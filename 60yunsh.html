<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>å…«å­—åˆç›˜ï¼ˆäº‹ä¸šè´¢è¿/å©šå§»ï¼‰â€” å«åœ°æ”¯è—å¹² & å–œç”¨ç¥ & ç ´è§£å»ºè®®</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
<style>
  body{font-family:"Noto Sans SC",system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",sans-serif;background:#f6f7fb;margin:0;padding:24px;color:#1f2937}
  h1{margin:0 0 12px 0;font-size:24px;text-align:center}
  .status{text-align:center;margin:6px 0 14px 0;font-weight:700}
  .green{color:#16a34a}.red{color:#ef4444}.orange{color:#f59e0b}
  .card{background:#fff;border-radius:14px;padding:14px;box-shadow:0 8px 28px rgba(2,6,23,.08);margin-top:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row input[type="number"]{width:90px}
  .btn{padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:700}
  .btn-primary{background:#22c55e;color:#fff}
  .btn-secondary{background:#3b82f6;color:#fff}
  .btn-amber{background:#f59e0b;color:#fff}
  .btn-purple{background:#8b5cf6;color:#fff}
  .muted{color:#6b7280;font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:8px}
  .kpi{background:#0b1020;color:#fff;border-radius:12px;padding:12px}
  .kpi h3{margin:0 0 6px 0;font-size:13px;opacity:.8;font-weight:500}
  .kpi div{font-size:18px;font-weight:800}
  .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1020;color:#cbd5e1;padding:10px;border-radius:10px;white-space:pre-wrap}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid #e5e7eb;padding:10px 8px;text-align:left}
  th{background:#f9fafb}
  .scroll{max-height:60vh;overflow:auto;border-radius:12px}
  .bar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar>div{height:10px;background:#3b82f6}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;margin-right:6px;margin-bottom:4px;border:1px solid rgba(31,41,55,.12)}
  .tag-red{color:#ef4444;border-color:#fecaca;background:#fff1f2}
  .tag-green{color:#16a34a;border-color:#bbf7d0;background:#f0fdf4}
  .tag-amber{color:#b45309;border-color:#fde68a;background:#fffbeb}
  .good{font-weight:800}
</style>
</head>
<body>
  <h1>å…«å­—åˆç›˜ Â· ç”¨äººè¯†äººï¼ˆäº‹ä¸šè´¢è¿ / å©šå§»ï¼‰</h1>
  <div id="engineStatus" class="status">æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆåŠ è½½ä¸­â€¦ï¼‰</div>

  <!-- è¾“å…¥åŒº -->
  <div class="card">
    <h2 style="margin:0 0 8px 0">ç”²æ–¹ï¼ˆAï¼‰å‡ºç”Ÿä¿¡æ¯</h2>
    <div class="row">
      <input type="number" id="Ayear" placeholder="å¹´">
      <input type="number" id="Amonth" placeholder="æœˆ">
      <input type="number" id="Aday" placeholder="æ—¥">
      <input type="number" id="Ahour" placeholder="æ—¶">
      <button class="btn btn-primary" id="btnA">ç”ŸæˆAå››æŸ±</button>
    </div>
    <h2 style="margin:12px 0 8px 0">ä¹™æ–¹ï¼ˆBï¼‰å‡ºç”Ÿä¿¡æ¯</h2>
    <div class="row">
      <input type="number" id="Byear" placeholder="å¹´">
      <input type="number" id="Bmonth" placeholder="æœˆ">
      <input type="number" id="Bday" placeholder="æ—¥">
      <input type="number" id="Bhour" placeholder="æ—¶">
      <button class="btn btn-primary" id="btnB">ç”ŸæˆBå››æŸ±</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn btn-secondary" id="btnCareer">åˆç›˜ï¼šäº‹ä¸šè´¢è¿</button>
      <button class="btn btn-purple" id="btnMarriage">åˆç›˜ï¼šå©šå§»</button>
      <button class="btn btn-amber" id="btnTest">å†…å»ºæµ‹è¯•</button>
    </div>
    <div class="muted" style="margin-top:6px">æç¤ºï¼šå°æ—¶æœªçŸ¥å¯å¡« 12ã€‚è‹¥éœ€ä¸¥è°¨å¤§è¿ï¼ˆèµ·è¿å²æ•°ã€é¡ºé€†ã€çœŸå¤ªé˜³æ—¶ï¼‰ï¼Œè¯·æä¾›æ€§åˆ«ä¸å‡ºç”Ÿåœ°/æ—¶åŒºã€‚</div>
  </div>

  <!-- A/B æ’ç›˜åŒº -->
  <div class="card" id="panelA" style="display:none">
    <h2>ğŸ“œ ç”²æ–¹ A â€” å››æŸ±ï¼ˆå«åœ°æ”¯è—å¹²/å–œç”¨ç¥ï¼‰</h2>
    <div class="grid" id="kpiA"></div>
    <div class="scroll" style="margin-top:8px">
      <table id="tabA"><thead><tr><th>æŸ±</th><th>å¤©å¹²</th><th>åœ°æ”¯</th><th>è—å¹²æ‹†è§£</th></tr></thead><tbody></tbody></table>
    </div>
    <pre class="code" id="txtA"></pre>
  </div>

  <div class="card" id="panelB" style="display:none">
    <h2>ğŸ“œ ä¹™æ–¹ B â€” å››æŸ±ï¼ˆå«åœ°æ”¯è—å¹²/å–œç”¨ç¥ï¼‰</h2>
    <div class="grid" id="kpiB"></div>
    <div class="scroll" style="margin-top:8px">
      <table id="tabB"><thead><tr><th>æŸ±</th><th>å¤©å¹²</th><th>åœ°æ”¯</th><th>è—å¹²æ‹†è§£</th></tr></thead><tbody></tbody></table>
    </div>
    <pre class="code" id="txtB"></pre>
  </div>

  <!-- åˆç›˜è¾“å‡º -->
  <div class="card" id="panelCompat" style="display:none">
    <h2>ğŸ¤ åˆç›˜ç»“æœ <span id="compatType"></span></h2>
    <div class="grid" id="kpiC"></div>
    <div class="card" style="background:#f9fafb;margin-top:12px">
      <h3 style="margin:4px 0 8px 0;">å…³ç³»ç»“æ„ä¸ç›¸äº’ä½œç”¨</h3>
      <pre class="code" id="txtCompat"></pre>
    </div>
    <div class="card" style="background:#fff;margin-top:12px">
      <h3 style="margin:4px 0 8px 0;">ç ´è§£ä¸è½åœ°å»ºè®®</h3>
      <ol id="adviceList" style="margin:0 0 0 18px"></ol>
    </div>
  </div>

<script>
  // â€”â€”â€” å¼•æ“çŠ¶æ€ â€”â€”â€”
  window.addEventListener('load', () => {
    const st = document.getElementById('engineStatus');
    if (window.Solar && window.Lunar) { st.textContent='æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆå·²å°±ç»ªï¼‰'; st.classList.add('green'); }
    else { st.textContent='æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆåŠ è½½å¤±è´¥ï¼‰'; st.classList.add('red'); }
  });

  // â€”â€”â€” åŸºç¡€æ˜ å°„ â€”â€”â€”
  const wuxingGan = {ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'};
  const wuxingZhi = {å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'};
  const zhiCang = {
    å­:[['ç™¸',1.0]], ä¸‘:[['å·±',0.6],['ç™¸',0.2],['è¾›',0.2]],
    å¯…:[['ç”²',0.6],['ä¸™',0.3],['æˆŠ',0.1]], å¯:[['ä¹™',1.0]],
    è¾°:[['æˆŠ',0.6],['ä¹™',0.2],['ç™¸',0.2]], å·³:[['ä¸™',0.6],['æˆŠ',0.2],['åºš',0.2]],
    åˆ:[['ä¸',0.7],['å·±',0.3]], æœª:[['å·±',0.6],['ä¸',0.2],['ä¹™',0.2]],
    ç”³:[['åºš',0.6],['å£¬',0.3],['æˆŠ',0.1]], é…‰:[['è¾›',1.0]],
    æˆŒ:[['æˆŠ',0.6],['è¾›',0.2],['ä¸',0.2]], äº¥:[['å£¬',0.7],['ç”²',0.3]],
  };
  const YY = {ç”²:1, ä¸™:1, æˆŠ:1, åºš:1, å£¬:1, ä¹™:0, ä¸:0, å·±:0, è¾›:0, ç™¸:0};
  const SHENG = {æœ¨:'ç«', ç«:'åœŸ', åœŸ:'é‡‘', é‡‘:'æ°´', æ°´:'æœ¨'};
  const KE    = {æœ¨:'åœŸ', ç«:'é‡‘', åœŸ:'æ°´', é‡‘:'æœ¨', æ°´:'ç«'};
  const ganHe = {ç”²:'å·±',ä¹™:'åºš',ä¸™:'è¾›',ä¸:'å£¬',æˆŠ:'ç™¸',å·±:'ç”²',åºš:'ä¹™',è¾›:'ä¸™',å£¬:'ä¸',ç™¸:'æˆŠ'};
  const ganChong = {ç”²:'åºš',ä¹™:'è¾›',ä¸™:'å£¬',ä¸:'ç™¸',æˆŠ:'ç”²',å·±:'ä¹™',åºš:'ç”²',è¾›:'ä¹™',å£¬:'ä¸™',ç™¸:'ä¸'};
  const zhiChongPairs = new Set(['å­åˆ','åˆå­','ä¸‘æœª','æœªä¸‘','å¯…ç”³','ç”³å¯…','å¯é…‰','é…‰å¯','è¾°æˆŒ','æˆŒè¾°','å·³äº¥','äº¥å·³']);
  const zhiHePairs = new Set(['å­ä¸‘','ä¸‘å­','å¯…äº¥','äº¥å¯…','å¯æˆŒ','æˆŒå¯','è¾°é…‰','é…‰è¾°','å·³ç”³','ç”³å·³','åˆæœª','æœªåˆ']);

  // â€”â€”â€” å°å·¥å…· â€”â€”â€”
  function needInputs(prefix){
    const y=parseInt(document.getElementById(prefix+'year').value,10);
    const m=parseInt(document.getElementById(prefix+'month').value,10);
    const d=parseInt(document.getElementById(prefix+'day').value,10);
    const h=parseInt(document.getElementById(prefix+'hour').value,10);
    if(!y||!m||!d||Number.isNaN(h)){ alert('è¯·è¾“å…¥å®Œæ•´çš„ '+(prefix==='A'?'ç”²æ–¹':'ä¹™æ–¹')+' å¹´/æœˆ/æ—¥/æ—¶'); return null; }
    if(!window.Solar||!window.Lunar){ alert('å¼•æ“æœªåŠ è½½æˆåŠŸ'); return null; }
    return {y,m,d,h};
  }
  function zhiCangText(z){ return (zhiCang[z]||[]).map(([g,w])=>`${g}(${w})`).join(' + '); }

  // åç¥ï¼ˆç›¸å¯¹æ—¥å¹²ï¼‰
  function tenGod(dayGan, otherGan){
    const dm=wuxingGan[dayGan], om=wuxingGan[otherGan]; if(!dm||!om) return 'ï¼ˆæœªçŸ¥ï¼‰';
    const sameYY = YY[dayGan]===YY[otherGan];
    if(om===dm) return sameYY?'æ¯”è‚©':'åŠ«è´¢';
    if(SHENG[dm]===om) return sameYY?'é£Ÿç¥':'ä¼¤å®˜';
    if(SHENG[om]===dm) return sameYY?'æ­£å°':'åå°';
    if(KE[dm]===om)    return sameYY?'æ­£è´¢':'åè´¢';
    if(KE[om]===dm)    return sameYY?'æ­£å®˜':'ä¸ƒæ€';
    return 'ï¼ˆæœªçŸ¥ï¼‰';
  }

  // å¤©å¹²+åœ°æ”¯è—å¹² â†’ äº”è¡Œè®¡é‡ï¼ˆå«æœˆä»¤+0.5ï¼‰
  function tallyFiveElements(stems, branches, monthZhi){
    const count={æœ¨:0,ç«:0,åœŸ:0,é‡‘:0,æ°´:0};
    stems.forEach(g=>{const w=wuxingGan[g]; if(w) count[w]+=1;});
    branches.forEach(z=>{(zhiCang[z]||[]).forEach(([g,w])=>{const ww=wuxingGan[g]; if(ww) count[ww]+=w;});});
    const mw=wuxingZhi[monthZhi]; if(mw) count[mw]+=0.5;
    return count;
  }
  function rootingStrength(dayGan, branches){
    let s=0; branches.forEach(z=>{(zhiCang[z]||[]).forEach(([g,w])=>{if(g===dayGan) s+=w;});});
    return s;
  }
  function strongWeakAndYong(ec){
    const stems=[ec.getYearGan(),ec.getMonthGan(),ec.getDayGan(),ec.getTimeGan()];
    const zhis=[ec.getYearZhi(),ec.getMonthZhi(),ec.getDayZhi(),ec.getTimeZhi()];
    const wc=tallyFiveElements(stems,zhis,ec.getMonthZhi());
    const dayGan=ec.getDayGan(), dayMaster=wuxingGan[dayGan], root=rootingStrength(dayGan,zhis);
    let strongWeak='ä¸­å’Œ'; const own=wc[dayMaster];
    if(own+root>=3.5) strongWeak='åå¼º';
    if(own+root<=2.0) strongWeak='åå¼±';
    const beiKe={}, shengWo={}; Object.entries(KE).forEach(([a,b])=>beiKe[b]=a); Object.entries(SHENG).forEach(([a,b])=>shengWo[b]=a);
    const yongSet=new Set(), jiSet=new Set();
    if(strongWeak==='åå¼º'){ yongSet.add(KE[dayMaster]); yongSet.add(beiKe[dayMaster]); jiSet.add(dayMaster); }
    else if(strongWeak==='åå¼±'){ yongSet.add(dayMaster); yongSet.add(shengWo[dayMaster]); jiSet.add(KE[dayMaster]); jiSet.add(SHENG[dayMaster]); }
    else { const order=Object.entries(wc).sort((a,b)=>a[1]-b[1]); yongSet.add(order[0][0]); yongSet.add(order[1][0]); jiSet.add(order[4][0]); }
    return {dayGan, dayMaster, strongWeak, wc, yongSet, jiSet, root};
  }

  // æ ¼å±€ï¼ˆå…¥é—¨è§„åˆ™ï¼‰
  function patternGuess(ec){
    const d=ec.getDayGan(), dW=wuxingGan[d];
    const tg = {
      å¹´: tenGod(d, ec.getYearGan()),
      æœˆ: tenGod(d, ec.getMonthGan()),
      æ—¶: tenGod(d, ec.getTimeGan()),
    };
    const c={}; ['æ¯”è‚©','åŠ«è´¢','é£Ÿç¥','ä¼¤å®˜','æ­£è´¢','åè´¢','æ­£å®˜','ä¸ƒæ€','æ­£å°','åå°'].forEach(k=>c[k]=0);
    Object.values(tg).forEach(v=>{ if(c[v]!=null) c[v]++; });
    const yW = wuxingZhi[ec.getMonthZhi()];
    const has=k=>(c[k]||0)>0, many=(...ks)=>ks.reduce((s,k)=>s+(c[k]||0),0);
    if (has('æ­£å®˜') && !has('ä¸ƒæ€')) return {name:'æ­£å®˜æ ¼', reason:'å®˜æ¸…ä¸è§æ€'};
    if (has('ä¸ƒæ€') && (has('æ­£å°')||has('åå°'))) return {name:'æ€å°ç›¸ç”Ÿ', reason:'æœ‰æ€æœ‰å°ï¼ŒåŒ–æ€ä¸ºæƒ'};
    if (has('ä¼¤å®˜') && (has('æ­£å°')||has('åå°'))) return {name:'ä¼¤å®˜é…å°', reason:'ä¼¤å®˜æœ‰å°åˆ¶'};
    if ((has('é£Ÿç¥')||has('ä¼¤å®˜')) && (has('æ­£è´¢')||has('åè´¢'))) return {name:'é£Ÿä¼¤ç”Ÿè´¢', reason:'æ³„ç§€ç”Ÿè´¢'};
    if (many('æ¯”è‚©','åŠ«è´¢')>=2) return {name:'æ¯”åŠ«æ—º', reason:'åŒå…šæ—º'};
    if (yW===dW) return {name:'èº«æ—ºå–æ³„', reason:'æœˆä»¤åŒæ°”'};
    return {name:'å¹³æ ¼', reason:'æœªè§¦å‘å…¸å‹é—¨ç±»'};
  }

  // å››æŸ±ç”Ÿæˆï¼ˆé€šç”¨æ¸²æŸ“ï¼‰
  function genChart(prefix){
    const inps=needInputs(prefix); if(!inps) return null;
    const {y,m,d,h}=inps, s=Solar.fromYmdHms(y,m,d,h,0,0), l=s.getLunar(), ec=l.getEightChar();
    const stems=[ec.getYearGan(),ec.getMonthGan(),ec.getDayGan(),ec.getTimeGan()];
    const zhis=[ec.getYearZhi(),ec.getMonthZhi(),ec.getDayZhi(),ec.getTimeZhi()];
    const sw=strongWeakAndYong(ec), pat=patternGuess(ec);

    // KPI
    const kpiEl=document.getElementById('kpi'+prefix);
    const panel=document.getElementById('panel'+prefix);
    if(panel) panel.style.display='block';
    kpiEl.innerHTML='';
    [['å››æŸ±',ec.toString()],['æ—¥ä¸»', ec.getDayGan()+'ï¼ˆ'+sw.dayMaster+'ï¼‰'],['å¼ºå¼±', `${sw.strongWeak}ï¼ˆé€šæ ¹${sw.root.toFixed(2)}ï¼‰`],['å–œç”¨', [...sw.yongSet].join('ã€')||'â€”'],['å¿Œç¥',[...sw.jiSet].join('ã€')||'â€”'],['å‘½æ ¼', pat.name+'ï¼š'+pat.reason]].forEach(([k,v])=>{
      const el=document.createElement('div'); el.className='kpi'; el.innerHTML=`<h3>${k}</h3><div>${v}</div>`; kpiEl.appendChild(el);
    });

    // è¡¨æ ¼
    const tb=document.querySelector('#tab'+prefix+' tbody'); tb.innerHTML='';
    [['å¹´',0],['æœˆ',1],['æ—¥',2],['æ—¶',3]].forEach(([lab,i])=>{
      const tr=document.createElement('tr'); tr.innerHTML=`
        <td>${lab}</td>
        <td>${stems[i]}ï¼ˆ${wuxingGan[stems[i]]}ï¼‰</td>
        <td>${zhis[i]}ï¼ˆ${wuxingZhi[zhis[i]]}ï¼‰</td>
        <td>${zhiCangText(zhis[i])}</td>`;
      tb.appendChild(tr);
    });

    // æ–‡æœ¬
    const lines=[];
    lines.push(`å…¬å†ï¼š${y}-${m}-${d} ${String(h).padStart(2,'0')}:00`);
    lines.push(`å››æŸ±ï¼š${ec.toString()}`);
    const wc=sw.wc;
    lines.push(`äº”è¡Œç»Ÿè®¡ï¼ˆå¹²1.0 + è—å¹²æƒé‡ + æœˆä»¤0.5ï¼‰ï¼šæœ¨${wc.æœ¨.toFixed(1)} ç«${wc.ç«.toFixed(1)} åœŸ${wc.åœŸ.toFixed(1)} é‡‘${wc.é‡‘.toFixed(1)} æ°´${wc.æ°´.toFixed(1)}`);
    document.getElementById('txt'+prefix).textContent=lines.join('\n');

    // è¿”å›å¯¹è±¡ç”¨äºåˆç›˜
    return {
      y,m,d,h, lunar:l, ec,
      stems, zhis,
      dayGan: ec.getDayGan(), dayZhi: ec.getDayZhi(),
      dayElement: wuxingGan[ec.getDayGan()],
      sw, pat
    };
  }

  // ============== åˆç›˜æ ¸å¿ƒ =================
  // ç»Ÿè®¡â€œå†²/åˆâ€æ•°é‡ï¼ˆå¤©å¹²å¯¹åº”æŸ±ã€åœ°æ”¯å¯¹åº”æŸ±ï¼Œæ—¥æŸ±æƒé‡æ›´é«˜ï¼‰
  function countInteractions(A,B){
    const res={ganHe:0,ganChong:0,zhiHe:0,zhiChong:0,notes:[]};
    const lab=['å¹´','æœˆ','æ—¥','æ—¶'];
    for(let i=0;i<4;i++){
      const gA=A.stems[i], gB=B.stems[i], zA=A.zhis[i], zB=B.zhis[i];
      if(ganHe[gA]===gB){ res.ganHe+=(i===2?2:1); res.notes.push(`å¤©å¹²${lab[i]}æŸ±åˆï¼š${gA}+${gB}`); }
      if(ganChong[gA]===gB){ res.ganChong+=(i===2?2:1); res.notes.push(`å¤©å¹²${lab[i]}æŸ±å†²ï¼š${gA}Ã—${gB}`); }
      if(zhiHePairs.has(zA+zB)){ res.zhiHe+=(i===2?2:1); res.notes.push(`åœ°æ”¯${lab[i]}æŸ±åˆï¼š${zA}+${zB}`); }
      if(zhiChongPairs.has(zA+zB)){ res.zhiChong+=(i===2?2:1); res.notes.push(`åœ°æ”¯${lab[i]}æŸ±å†²ï¼š${zA}Ã—${zB}`); }
    }
    return res;
  }

  // å–œç”¨è¡¥ç›Š/å¿Œç¥æŠµè§¦
  function favorTally(A,B){
    let aGain=0,bGain=0,aHitJi=0,bHitJi=0,notes=[];
    const countByWux = chart => chart.stems.map(g=>wuxingGan[g]).reduce((m,w)=>(m[w]=(m[w]||0)+1,m),{});
    const Aw=countByWux(A), Bw=countByWux(B);
    // Açš„å–œç”¨è¢«Bæä¾›
    A.sw.yongSet.forEach(w=>{ if((Bw[w]||0)>0){ aGain+=1; notes.push(`Aå–œç”¨${w} â† Bå¤©å¹²æä¾›`); }});
    B.sw.yongSet.forEach(w=>{ if((Aw[w]||0)>0){ bGain+=1; notes.push(`Bå–œç”¨${w} â† Aå¤©å¹²æä¾›`); }});
    // Açš„å¿Œç¥è¢«Bæ”¾å¤§
    A.sw.jiSet.forEach(w=>{ if((Bw[w]||0)>0){ aHitJi+=1; notes.push(`Aå¿Œç¥${w} â† Bå¤©å¹²æ”¾å¤§`); }});
    B.sw.jiSet.forEach(w=>{ if((Aw[w]||0)>0){ bHitJi+=1; notes.push(`Bå¿Œç¥${w} â† Aå¤©å¹²æ”¾å¤§`); }});
    return {aGain,bGain,aHitJi,bHitJi,notes};
  }

  // å©šå§»ä¾§é‡ï¼šæ—¥å¹²/æ—¥æ”¯åŒ¹é…ã€åˆå¤šå†²å°‘ã€å–œç”¨äº’è¡¥
  function scoreMarriage(A,B){
    let score=60, reasons=[];
    // æ—¥å¹²å…³ç³»
    const dA=A.dayGan, dB=B.dayGan, zA=A.dayZhi, zB=B.dayZhi;
    if(ganHe[dA]===dB){ score+=15; reasons.push(`æ—¥å¹²äº”åˆï¼š${dA}+${dB} â†’ +15`); }
    if(ganChong[dA]===dB){ score-=15; reasons.push(`æ—¥å¹²å†²ï¼š${dA}Ã—${dB} â†’ âˆ’15`); }
    if(wuxingGan[dA]===wuxingGan[dB]){ score+=5; reasons.push(`æ—¥ä¸»åŒäº”è¡Œï¼ˆä»·å€¼è§‚æ¥è¿‘ï¼‰â†’ +5`); }

    // æ—¥æ”¯å…­åˆ/å…­å†²
    if(zhiHePairs.has(zA+zB)){ score+=10; reasons.push(`æ—¥æ”¯å…­åˆï¼š${zA}+${zB} â†’ +10`); }
    if(zhiChongPairs.has(zA+zB)){ score-=15; reasons.push(`æ—¥æ”¯å…­å†²ï¼š${zA}Ã—${zB} â†’ âˆ’15`); }

    // å…¨å±€äº’åŠ¨
    const it=countInteractions(A,B);
    score += it.ganHe*3 + it.zhiHe*3;
    score -= it.ganChong*3 + it.zhiChong*4;
    if(it.ganHe||it.zhiHe) reasons.push(`å…¨å±€åˆè®¡ï¼šå¹²åˆ${it.ganHe}ã€æ”¯åˆ${it.zhiHe} â†’ ç¨³å®šæ€§åŠ åˆ†`);
    if(it.ganChong||it.zhiChong) reasons.push(`å…¨å±€å†²è®¡ï¼šå¹²å†²${it.ganChong}ã€æ”¯å†²${it.zhiChong} â†’ ç£¨åˆæˆæœ¬`);

    // å–œç”¨äº’è¡¥
    const fav=favorTally(A,B);
    score += (fav.aGain+fav.bGain)*4;
    score -= (fav.aHitJi+fav.bHitJi)*4;
    if(fav.aGain||fav.bGain) reasons.push(`å–œç”¨äº’è¡¥ï¼šæ€»${fav.aGain+fav.bGain}å¤„ â†’ +${(fav.aGain+fav.bGain)*4}`);
    if(fav.aHitJi||fav.bHitJi) reasons.push(`å¿Œç¥äº’è¸©ï¼šæ€»${fav.aHitJi+fav.bHitJi}å¤„ â†’ âˆ’${(fav.aHitJi+fav.bHitJi)*4}`);

    // æ”¶å£
    score=Math.max(0,Math.min(100,Math.round(score)));
    return {score, reasons, it, fav};
  }

  // äº‹ä¸šè´¢è¿ä¾§é‡ï¼šäº’è¡¥ï¼ˆé£Ÿä¼¤/è´¢å®˜/å°ï¼‰ã€å†²å°‘åˆå¤šã€å–œç”¨ä¾›ç»™ã€åˆ†å·¥æ¸…æ™°
  function scoreCareer(A,B){
    let score=60, reasons=[];
    const it=countInteractions(A,B);
    score += it.ganHe*3 + it.zhiHe*2;  // åˆä½œé¡ºç•…
    score -= it.ganChong*4 + it.zhiChong*3; // å†²çªæˆæœ¬
    if(it.ganHe||it.zhiHe) reasons.push(`åˆå¤šï¼šå¹²åˆ${it.ganHe}ã€æ”¯åˆ${it.zhiHe} â†’ æå‡ååŒ`);
    if(it.ganChong||it.zhiChong) reasons.push(`å†²å¤šï¼šå¹²å†²${it.ganChong}ã€æ”¯å†²${it.zhiChong} â†’ é™ä½ç¨³å®š`);

    // èŒèƒ½äº’è¡¥ï¼ˆæœ¨ç«ååˆ›æ„å¤–æ”¾ï¼›åœŸé‡‘æ°´åç»„ç»‡è´¢æ§/è¿è¥ï¼‰
    function side(wc){ const mf=(wc.æœ¨+wc.ç«), tjs=(wc.åœŸ+wc.é‡‘+wc.æ°´); return {mf,tjs}; }
    const Sa=side(A.sw.wc), Sb=side(B.sw.wc);
    const diff = Math.abs((Sa.mf-Sa.tjs)) + Math.abs((Sb.mf-Sb.tjs));
    if((Sa.mf>Sa.tjs && Sb.tjs>Sb.mf) || (Sa.tjs>Sa.mf && Sb.mf>Sb.tjs)){ score+=10; reasons.push('èŒèƒ½äº’è¡¥ï¼šä¸€åˆ›æ„ä¸€æ‰§è¡Œ â†’ +10'); }

    // å–œç”¨ä¾›ç»™
    const fav=favorTally(A,B);
    score += (fav.aGain+fav.bGain)*5;
    score -= (fav.aHitJi+fav.bHitJi)*5;
    if(fav.aGain||fav.bGain) reasons.push(`å–œç”¨ä¾›ç»™ï¼šæ€»${fav.aGain+fav.bGain}å¤„ â†’ +${(fav.aGain+fav.bGain)*5}`);
    if(fav.aHitJi||fav.bHitJi) reasons.push(`å¿Œç¥æ”¾å¤§ï¼šæ€»${fav.aHitJi+fav.bHitJi}å¤„ â†’ âˆ’${(fav.aHitJi+fav.bHitJi)*5}`);

    // æ—¥ä¸»å…³ç³»ï¼šå’Œåˆ™æ²Ÿé€šä½æ‘©æ“¦
    const dA=A.dayGan,dB=B.dayGan;
    if(ganHe[dA]===dB){ score+=6; reasons.push(`æ—¥å¹²äº”åˆï¼šæ²Ÿé€šé¡ºæ»‘ â†’ +6`); }
    if(ganChong[dA]===dB){ score-=8; reasons.push(`æ—¥å¹²å†²ï¼šæˆ˜ç•¥åˆ†æ­§é£é™© â†’ âˆ’8`); }

    score=Math.max(0,Math.min(100,Math.round(score)));
    return {score, reasons, it, fav};
  }

  // è§£æå»ºè®®ï¼ˆé€šç”¨è½åœ°ï¼‰
  function buildAdviceList(type,A,B,calc){
    const list=[];
    const better = (w)=>`åŠ å¼ºã€Œ${w}ã€å…ƒç´ ï¼šé¢œè‰²/æè´¨/æ–¹ä½/ä½œæ¯/é¡¹ç›®ç±»å‹å‘è¯¥äº”è¡Œé æ‹¢`;
    const bothYong = new Set([...A.sw.yongSet].filter(x=>B.sw.yongSet.has(x)));
    const risky = new Set([...A.sw.jiSet].filter(x=>B.sw.jiSet.has(x)));

    // 1. å–œç”¨ååŒ & å¿Œç¥è§„é¿
    if(bothYong.size>0) list.push(`å…±åŒå–œç”¨ï¼š${[...bothYong].join('ã€')}ã€‚ä¼˜å…ˆæŠŠå…³é”®é¡¹ç›®å®‰æ’åœ¨è¿™ç±»å…ƒç´ /æœˆä»½/è¡Œä¸šä¸Šã€‚`);
    if(risky.size>0) list.push(`å…±åŒå¿Œç¥ï¼š${[...risky].join('ã€')}ã€‚é¿å¼€è¯¥ç±»å…ƒç´ çš„é«˜å¼ºåº¦æš´éœ²åœºæ™¯ï¼Œå…ˆè¯•ç‚¹å†æ‰©å¼ ã€‚`);

    // 2. è§’è‰²åˆ†å·¥ï¼ˆäº‹ä¸šï¼‰
    if(type==='career'){
      const Sa=A.sw.wc, Sb=B.sw.wc;
      const A_creative = (Sa.æœ¨+Sa.ç«) > (Sa.åœŸ+Sa.é‡‘+Sa.æ°´);
      const B_creative = (Sb.æœ¨+Sb.ç«) > (Sb.åœŸ+Sb.é‡‘+Sb.æ°´);
      if(A_creative!==B_creative){
        list.push(`è§’è‰²åˆ†å·¥ï¼šä¸€æ–¹ä¸»å¤–ï¼ˆäº§å“/å¢é•¿/BDï¼‰ï¼Œä¸€æ–¹ä¸»å†…ï¼ˆäº¤ä»˜/è´¢æ§/æ³•åŠ¡/é£æ§ï¼‰ï¼›å¯¹é½KPIï¼Œé¿å…æƒè´£ä¸æ¸…ã€‚`);
      }else{
        list.push(`è§’è‰²åˆ†å·¥ï¼šèƒ½åŠ›ä¾§é‡ç›¸ä¼¼ï¼Œå»ºè®®æŒ‰äº§å“çº¿/åŒºåŸŸåˆ†è´¦åˆ¶ï¼Œå‡å°‘ç›´æ¥é‡å ã€‚`);
      }
    }

    // 3. æ—¶é—´æ‹©æœŸï¼ˆåŒæ–¹å–œç”¨å…ƒç´ çš„å¹´ä»½/æœˆä»½/æ—¥å­ï¼‰
    list.push(`æ—¶é—´æ‹©æœŸï¼šä¼˜å…ˆé€‰æ‹©åŒæ–¹å–œç”¨å…ƒç´ å¯¹åº”çš„å¹´ä»½/æœˆä»½/å¼€å§‹æ—¥è¡ŒåŠ¨ï¼ˆå¦‚å–œæ°´â†’äº¥å­æœˆ/å£¬ç™¸æ—¥ï¼‰ã€‚`);

    // 4. å¥‘çº¦æœºåˆ¶ï¼ˆäº‹ä¸š/å©šå§»ï¼‰
    list.push(`æœºåˆ¶è®¾å®šï¼šå»ºç«‹â€œé‡å¤§å†³ç­–å†·é™æœŸ + åŒç­¾å/è§è¯äºº/ç¬¬ä¸‰æ–¹ä»²è£â€æœºåˆ¶ï¼Œå‡å°‘å†²å…‹å¹´ä»½çš„å†³ç­–å¤±è¯¯ä¸æƒ…ç»ªåŒ–ã€‚`);

    // 5. åœºåŸŸ/é£æ ¼ï¼ˆç®€å•äº”è¡ŒåŒ–ï¼‰
    const pick = (set)=> set.size? [...set][0] : null;
    const sample = pick(bothYong) || pick(A.sw.yongSet) || pick(B.sw.yongSet);
    if(sample) list.push(better(sample)+'ï¼›ä¾‹å¦‚ï¼šåŠå…¬/å©šæˆ¿è£…é¥°ä¸ç©¿æ­é…è‰²ã€Logo/å©šç¤¼ä¸»è‰²ã€‚');

    // 6. å†²å¤šæ—¶çš„ç¼“è§£
    const it=calc.it;
    if((it.ganChong+it.zhiChong)>(it.ganHe+it.zhiHe)){
      list.push('å†²ä¸ºåŠ¨ï¼šä¼˜å…ˆæŠŠâ€œå†²â€çš„èƒ½é‡å¯¼å‘å¯æ§çš„å˜åŒ–ï¼Œå¦‚çŸ­å‘¨æœŸé¡¹ç›®/æ—…è¡Œ/å­¦ä¹ ï¼›é¿å…åœ¨å†²å¹´åšä¸å¯é€†é‡å†³ç­–ã€‚');
    }

    // 7. å…·ä½“æç¤ºï¼ˆå©šå§»ï¼‰
    if(type==='marriage'){
      const dA=A.dayGan, dB=B.dayGan;
      if(ganChong[dA]===dB) list.push('æ²Ÿé€šä¹‹é“ï¼šé‡åˆ†æ­§å…ˆå†™ä¸‹å½¼æ­¤ç«‹åœºä¸è¯æ®ï¼Œ24å°æ—¶åå†å†³å®šï¼›è®¾ç½®â€œæƒ…ç»ªæš‚åœâ€æš—å·ã€‚');
      if(ganHe[dA]===dB) list.push('çæƒœé»˜å¥‘ï¼šå»ºç«‹å›ºå®šçš„æ¯å‘¨â€œå…±åˆ›æ—¶é—´â€ï¼Œè§„åˆ’å…±åŒç›®æ ‡ï¼ˆæ—…è¡Œ/è¯¾ç¨‹/å®¶åº­é¡¹ç›®ï¼‰ã€‚');
    }

    return list;
  }

  // æ¸²æŸ“åˆç›˜
  function renderCompat(type,A,B,calc){
    document.getElementById('panelCompat').style.display='block';
    document.getElementById('compatType').textContent = type==='career' ? 'ï¼ˆäº‹ä¸šè´¢è¿ï¼‰' : 'ï¼ˆå©šå§»ï¼‰';

    // KPI
    const kpiC=document.getElementById('kpiC'); kpiC.innerHTML='';
    const bothYong=[...new Set([...A.sw.yongSet].filter(x=>B.sw.yongSet.has(x)))];
    const bothJi=[...new Set([...A.sw.jiSet].filter(x=>B.sw.jiSet.has(x)))];
    const score=calc.score;
    [['æ€»è¯„åˆ†', score+'/100'], ['Aæ—¥ä¸»', A.dayGan+'ï¼ˆ'+A.dayElement+'ï¼›'+A.sw.strongWeak+'ï¼‰'], ['Bæ—¥ä¸»', B.dayGan+'ï¼ˆ'+B.dayElement+'ï¼›'+B.sw.strongWeak+'ï¼‰'], ['å…±åŒå–œç”¨', bothYong.join('ã€')||'â€”'], ['å…±åŒå¿Œç¥', bothJi.join('ã€')||'â€”'], ['åˆ/å†²ï¼ˆæƒé‡ï¼‰', `å¹²åˆ${calc.it.ganHe} æ”¯åˆ${calc.it.zhiHe}ï½œå¹²å†²${calc.it.ganChong} æ”¯å†²${calc.it.zhiChong}`]].forEach(([k,v])=>{
      const el=document.createElement('div'); el.className='kpi'; el.innerHTML=`<h3>${k}</h3><div>${v}</div>`; kpiC.appendChild(el);
    });

    // æ–‡æœ¬è¯´æ˜
    const txt=[];
    txt.push(`æ ¸å¿ƒä¾æ®ï¼šæ—¥ä¸»å…³ç³»ã€å››æŸ±åˆ/å†²ã€å–œç”¨äº’è¡¥/å¿Œç¥äº’è¸©ã€äº”è¡ŒèŒèƒ½äº’è¡¥ã€‚`);
    calc.reasons.forEach((r,i)=>txt.push(`${i+1}. ${r}`));
    txt.push('');
    txt.push(`Aå–œç”¨ï¼š${[...A.sw.yongSet].join('ã€')}ï¼›Aå¿Œç¥ï¼š${[...A.sw.jiSet].join('ã€')}`);
    txt.push(`Bå–œç”¨ï¼š${[...B.sw.yongSet].join('ã€')}ï¼›Bå¿Œç¥ï¼š${[...B.sw.jiSet].join('ã€')}`);
    document.getElementById('txtCompat').textContent=txt.join('\n');

    // ç ´è§£å»ºè®®
    const advUl=document.getElementById('adviceList'); advUl.innerHTML='';
    buildAdviceList(type,A,B,calc).forEach(s=>{
      const li=document.createElement('li'); li.textContent=s; advUl.appendChild(li);
    });
  }

  // æŒ‰é’®äº‹ä»¶
  let A=null,B=null;
  document.getElementById('btnA').addEventListener('click', ()=>{ A=genChart('A'); });
  document.getElementById('btnB').addEventListener('click', ()=>{ B=genChart('B'); });
  document.getElementById('btnCareer').addEventListener('click', ()=>{
    if(!A) A=genChart('A'); if(!B) B=genChart('B'); if(!(A&&B)) return;
    const calc=scoreCareer(A,B); renderCompat('career',A,B,calc);
  });
  document.getElementById('btnMarriage').addEventListener('click', ()=>{
    if(!A) A=genChart('A'); if(!B) B=genChart('B'); if(!(A&&B)) return;
    const calc=scoreMarriage(A,B); renderCompat('marriage',A,B,calc);
  });

  // å†…å»ºæµ‹è¯•ï¼šéªŒè¯ Solar.fromYmdHms & åˆç›˜æµç¨‹
  document.getElementById('btnTest').addEventListener('click', ()=>{
    const st=document.getElementById('engineStatus'); st.textContent='æ’ç›˜å¼•æ“ï¼šæµ‹è¯•ä¸­â€¦'; st.classList.remove('green','red'); st.classList.add('orange');
    const msgs=[];
    try{
      if(!window.Solar||!window.Lunar) throw new Error('å¼•æ“æœªåŠ è½½');
      const s1=Solar.fromYmdHms(1990,1,1,12,0,0), s2=Solar.fromYmdHms(1992,6,10,8,0,0);
      const Atest={y:1990,m:1,d:1,h:12}, Btest={y:1992,m:6,d:10,h:8};
      document.getElementById('Ayear').value=Atest.y; document.getElementById('Amonth').value=Atest.m; document.getElementById('Aday').value=Atest.d; document.getElementById('Ahour').value=Atest.h;
      document.getElementById('Byear').value=Btest.y; document.getElementById('Bmonth').value=Btest.m; document.getElementById('Bday').value=Btest.d; document.getElementById('Bhour').value=Btest.h;
      A=genChart('A'); B=genChart('B');
      const mc=scoreMarriage(A,B), cc=scoreCareer(A,B);
      msgs.push('âœ… Solar.fromYmdHms å¯ç”¨ï¼›A/B æ’ç›˜å°±ç»ª');
      msgs.push('âœ… å©šå§»è¯„åˆ†ï¼š'+mc.score);
      msgs.push('âœ… äº‹ä¸šè¯„åˆ†ï¼š'+cc.score);
      st.textContent='æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆå·²å°±ç»ªï¼‰'; st.classList.remove('orange'); st.classList.add('green');
    }catch(e){
      msgs.push('âŒ æµ‹è¯•å¤±è´¥ï¼š'+e.message);
      st.textContent='æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆåŠ è½½å¤±è´¥ï¼‰'; st.classList.remove('orange'); st.classList.add('red');
    }
    alert(msgs.join('\n'));
  });
</script>
</body>
</html>
