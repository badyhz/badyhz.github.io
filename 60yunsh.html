<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>八字合盘(事业/婚姻) · 刑/害/破 · 三合/三会 · 落地建议</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--ink:#1f2937;--muted:#6b7280}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans SC",system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",sans-serif}
  .wrap{padding:22px;max-width:1200px;margin:0 auto}
  h1{margin:0 0 8px 0;font-size:22px}
  .status{font-weight:700;margin:2px 0 14px 0}
  .green{color:#16a34a}.red{color:#ef4444}.orange{color:#f59e0b}
  .card{background:#fff;border-radius:14px;padding:14px;box-shadow:0 8px 28px rgba(2,6,23,.08);margin-top:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row input[type="number"]{width:90px}
  .btn{padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:700;color:#fff}
  .btn-primary{background:#22c55e}.btn-secondary{background:#3b82f6}.btn-amber{background:#f59e0b}.btn-purple{background:#8b5cf6}
  .muted{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:8px}
  .kpi{background:#0b1020;color:#fff;border-radius:12px;padding:12px}
  .kpi h3{margin:0 0 6px 0;font-size:13px;opacity:.8;font-weight:500}
  .kpi div{font-size:18px;font-weight:800}
  .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1020;color:#cbd5e1;padding:10px;border-radius:10px;white-space:pre-wrap}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid #e5e7eb;padding:10px 8px;text-align:left}
  th{background:#f9fafb}
  .scroll{max-height:60vh;overflow:auto;border-radius:12px}
  .tips{font-size:13px;line-height:1.5;color:#374151}
</style>
</head>
<body>
<div class="wrap">
  <h1>八字合盘 · 用人识人（事业财运 / 婚姻）</h1>
  <div id="engineStatus" class="status">排盘引擎：lunar-javascript（加载中…）</div>

  <!-- 输入 -->
  <div class="card">
    <h2 style="margin:0 0 8px 0">甲方（A）出生信息</h2>
    <div class="row">
      <input type="number" id="Ayear" placeholder="年">
      <input type="number" id="Amonth" placeholder="月">
      <input type="number" id="Aday" placeholder="日">
      <input type="number" id="Ahour" placeholder="时">
      <button class="btn btn-primary" id="btnA">生成A四柱</button>
    </div>
    <h2 style="margin:12px 0 8px 0">乙方（B）出生信息</h2>
    <div class="row">
      <input type="number" id="Byear" placeholder="年">
      <input type="number" id="Bmonth" placeholder="月">
      <input type="number" id="Bday" placeholder="日">
      <input type="number" id="Bhour" placeholder="时">
      <button class="btn btn-primary" id="btnB">生成B四柱</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn btn-secondary" id="btnCareer">合盘：事业财运（运行）</button>
      <button class="btn btn-purple" id="btnMarriage">合盘：婚姻（运行）</button>
      <button class="btn btn-amber" id="btnTest">运行示例</button>
    </div>
    <div class="muted" style="margin-top:6px">提示：小时未知可填 12。若要起运岁数/真太阳时，请补性别与出生地（本版本不含）。</div>
  </div>

  <!-- A / B 排盘 -->
  <div class="card" id="panelA" style="display:none">
    <h2>📜 甲方 A — 四柱（含地支藏干/喜用神）</h2>
    <div class="grid" id="kpiA"></div>
    <div class="scroll" style="margin-top:8px">
      <table id="tabA"><thead><tr><th>柱</th><th>天干</th><th>地支</th><th>藏干拆解</th></tr></thead><tbody></tbody></table>
    </div>
    <pre class="code" id="txtA"></pre>
  </div>

  <div class="card" id="panelB" style="display:none">
    <h2>📜 乙方 B — 四柱（含地支藏干/喜用神）</h2>
    <div class="grid" id="kpiB"></div>
    <div class="scroll" style="margin-top:8px">
      <table id="tabB"><thead><tr><th>柱</th><th>天干</th><th>地支</th><th>藏干拆解</th></tr></thead><tbody></tbody></table>
    </div>
    <pre class="code" id="txtB"></pre>
  </div>

  <!-- 合盘 -->
  <div class="card" id="panelCompat" style="display:none">
    <h2>🤝 合盘结果 <span id="compatType"></span></h2>
    <div class="grid" id="kpiC"></div>

    <div class="card" style="background:#f9fafb;margin-top:12px">
      <h3 style="margin:4px 0 8px 0;">关系结构与相互作用（解释层）</h3>
      <pre class="code" id="txtCompat"></pre>
    </div>

    <div class="card" style="background:#fff;margin-top:12px">
      <h3 style="margin:4px 0 8px 8px;">刑 / 害 / 破 · 三合 / 三会 · 三合局（现象 & 影响）</h3>
      <div class="scroll">
        <table id="tabXingHaiPo"><thead>
          <tr><th>对象</th><th>刑</th><th>害</th><th>破</th><th>三合倾向</th><th>三会倾向</th><th>说明</th></tr>
        </thead><tbody></tbody></table>
      </div>
      <pre class="code" id="txtXhpExplain"></pre>
    </div>

    <div class="card" style="background:#fff;margin-top:12px">
      <h3 style="margin:4px 0 8px 0;">破解与落地建议（元素 / 月份 / 行业）</h3>
      <ol id="adviceList" style="margin:0 0 0 18px"></ol>
      <div class="tips">
        <p><b>五行→农历月份→阳历大致区间→行业示例</b></p>
        <ul>
          <li><b>木：</b>寅月(正月, 约1/下-2/中)・卯月(二月, 约2/下-3/下) → 教育/文化/出版/园林/医药研发/生物</li>
          <li><b>火：</b>巳月(四月, 约5/上-6/上)・午月(五月, 约6/上-7/上) → 媒体/内容/品牌/互联网/电商/餐饮</li>
          <li><b>土：</b>辰/未/戌/丑（月） → 地产/农业/建材/供应链/人事/财务</li>
          <li><b>金：</b>申月(七月, 约8/上-9/上)・酉月(八月, 约9/上-10/上) → 金融/法律/咨询/金属/安防/制造</li>
          <li><b>水：</b>亥月(十月, 约11/上-12/上)・子月(十一月, 约12/上-1/上) → 科技/数据/物流/航运/教育(理科)/出海</li>
        </ul>
        <p class="muted">※ 阳历区间为<b>大致参考</b>，择日以地支月份为准。</p>
      </div>
    </div>
  </div>
</div>

<script>
  // 引擎状态提示
  window.addEventListener('load', () => {
    const st = document.getElementById('engineStatus');
    if (window.Solar && window.Lunar) { st.textContent='排盘引擎：lunar-javascript（已就绪）'; st.classList.add('green'); }
    else { st.textContent='排盘引擎：lunar-javascript（加载失败）'; st.classList.add('red'); }
  });

  // —— 基础字典 —— //
  const wuxingGan = {甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
  const wuxingZhi = {子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'};
  const zhiCang = {
    子:[['癸',1.0]], 丑:[['己',0.6],['癸',0.2],['辛',0.2]],
    寅:[['甲',0.6],['丙',0.3],['戊',0.1]], 卯:[['乙',1.0]],
    辰:[['戊',0.6],['乙',0.2],['癸',0.2]], 巳:[['丙',0.6],['戊',0.2],['庚',0.2]],
    午:[['丁',0.7],['己',0.3]], 未:[['己',0.6],['丁',0.2],['乙',0.2]],
    申:[['庚',0.6],['壬',0.3],['戊',0.1]], 酉:[['辛',1.0]],
    戌:[['戊',0.6],['辛',0.2],['丁',0.2]], 亥:[['壬',0.7],['甲',0.3]],
  };
  const SHENG = {木:'火', 火:'土', 土:'金', 金:'水', 水:'木'};
  const KE    = {木:'土', 火:'金', 土:'水', 金:'木', 水:'火'};
  const ganHe = {甲:'己',乙:'庚',丙:'辛',丁:'壬',戊:'癸',己:'甲',庚:'乙',辛:'丙',壬:'丁',癸:'戊'};
  const ganChong = {甲:'庚',乙:'辛',丙:'壬',丁:'癸',戊:'甲',己:'乙',庚:'甲',辛:'乙',壬:'丙',癸:'丁'};
  const zhiChongPairs = new Set(['子午','午子','丑未','未丑','寅申','申寅','卯酉','酉卯','辰戌','戌辰','巳亥','亥巳']);
  const zhiHePairs = new Set(['子丑','丑子','寅亥','亥寅','卯戌','戌卯','辰酉','酉辰','巳申','申巳','午未','未午']);

  // 刑/害/破 & 三合/三会
  const xingPairs = new Set(['寅巳','巳申','申寅','丑未','未戌','戌丑','子卯','卯子']); // 自刑另记
  const selfXing = new Set(['辰','午','酉','亥']);
  const haiPairs = new Set(['子未','未子','丑午','午丑','寅巳','巳寅','卯辰','辰卯','申亥','亥申','酉戌','戌酉']);
  const poPairs  = new Set(['子酉','酉子','丑辰','辰丑','寅亥','亥寅','卯午','午卯','申巳','巳申','未戌','戌未']);
  const sanHeGroups = [
    {name:'水局', set:new Set(['申','子','辰']), elem:'水'},
    {name:'木局', set:new Set(['亥','卯','未']), elem:'木'},
    {name:'火局', set:new Set(['寅','午','戌']), elem:'火'},
    {name:'金局', set:new Set(['巳','酉','丑']), elem:'金'},
  ];
  const sanHuiGroups = [
    {name:'水会', set:new Set(['亥','子','丑']), elem:'水'},
    {name:'木会', set:new Set(['寅','卯','辰']), elem:'木'},
    {name:'火会', set:new Set(['巳','午','未']), elem:'火'},
    {name:'金会', set:new Set(['申','酉','戌']), elem:'金'},
  ];

  // 元素→月份(地支)→阳历区间→行业
  const elementMonths = {
    木: { zhi:['寅','卯'], greg:['约1月下旬-3月下旬'], jobs:['教育','文化','出版','园林','医药研发','生物'] },
    火: { zhi:['巳','午'], greg:['约5月上旬-7月上旬'], jobs:['媒体','内容','品牌','互联网','电商','餐饮'] },
    土: { zhi:['辰','未','戌','丑'], greg:['约3月末-1月（含换季四土月）'], jobs:['地产','农业','建材','供应链','人事','财务'] },
    金: { zhi:['申','酉'], greg:['约8月上旬-10月上旬'], jobs:['金融','法律','咨询','金属','安防','制造'] },
    水: { zhi:['亥','子'], greg:['约11月上旬-1月上旬'], jobs:['科技','数据','物流','航运','教育(理科)','出海'] }
  };

  // —— 工具函数 —— //
  function needInputs(prefix){
    const y=parseInt(document.getElementById(prefix+'year').value,10);
    const m=parseInt(document.getElementById(prefix+'month').value,10);
    const d=parseInt(document.getElementById(prefix+'day').value,10);
    const h=parseInt(document.getElementById(prefix+'hour').value,10);
    if(!y||!m||!d||Number.isNaN(h)){ alert('请输入完整的 '+(prefix==='A'?'甲方':'乙方')+' 年/月/日/时'); return null; }
    if(!window.Solar||!window.Lunar){ alert('引擎未加载成功'); return null; }
    return {y,m,d,h};
  }
  const zhiCangText = z => (zhiCang[z]||[]).map(([g,w])=>`${g}(${w})`).join(' + ');

  function tenGod(dayGan, otherGan){
    const YY={甲:1,丙:1,戊:1,庚:1,壬:1,乙:0,丁:0,己:0,辛:0,癸:0};
    const dm=wuxingGan[dayGan], om=wuxingGan[otherGan]; if(!dm||!om) return '—';
    const sameYY = YY[dayGan]===YY[otherGan];
    if(om===dm) return sameYY?'比肩':'劫财';
    if(SHENG[dm]===om) return sameYY?'食神':'伤官';
    if(SHENG[om]===dm) return sameYY?'正印':'偏印';
    if(KE[dm]===om)    return sameYY?'正财':'偏财';
    if(KE[om]===dm)    return sameYY?'正官':'七杀';
    return '—';
  }
  function tallyFiveElements(stems, branches, monthZhi){
    const count={木:0,火:0,土:0,金:0,水:0};
    stems.forEach(g=>{const w=wuxingGan[g]; if(w) count[w]+=1;});
    branches.forEach(z=>{(zhiCang[z]||[]).forEach(([g,w])=>{const ww=wuxingGan[g]; if(ww) count[ww]+=w;});});
    const mw=wuxingZhi[monthZhi]; if(mw) count[mw]+=0.5; // 月令加权
    return count;
  }
  function rootingStrength(dayGan, branches){
    let s=0; branches.forEach(z=>{(zhiCang[z]||[]).forEach(([g,w])=>{if(g===dayGan) s+=w;});});
    return s;
  }
  function strongWeakAndYong(ec){
    const stems=[ec.getYearGan(),ec.getMonthGan(),ec.getDayGan(),ec.getTimeGan()];
    const zhis=[ec.getYearZhi(),ec.getMonthZhi(),ec.getDayZhi(),ec.getTimeZhi()];
    const wc=tallyFiveElements(stems,zhis,ec.getMonthZhi());
    const dayGan=ec.getDayGan(), dayMaster=wuxingGan[dayGan], root=rootingStrength(dayGan,zhis);
    let strongWeak='中和'; const own=wc[dayMaster];
    if(own+root>=3.5) strongWeak='偏强';
    if(own+root<=2.0) strongWeak='偏弱';
    const beiKe={}, shengWo={}; Object.entries(KE).forEach(([a,b])=>beiKe[b]=a); Object.entries(SHENG).forEach(([a,b])=>shengWo[b]=a);
    const yongSet=new Set(), jiSet=new Set();
    if(strongWeak==='偏强'){ yongSet.add(KE[dayMaster]); yongSet.add(beiKe[dayMaster]); jiSet.add(dayMaster); }
    else if(strongWeak==='偏弱'){ yongSet.add(dayMaster); yongSet.add(shengWo[dayMaster]); jiSet.add(KE[dayMaster]); jiSet.add(SHENG[dayMaster]); }
    else { const order=Object.entries(wc).sort((a,b)=>a[1]-b[1]); yongSet.add(order[0][0]); yongSet.add(order[1][0]); jiSet.add(order[4][0]); }
    return {dayGan, dayMaster, strongWeak, wc, yongSet, jiSet, root};
  }
  function patternGuess(ec){
    const d=ec.getDayGan(), dW=wuxingGan[d];
    const tg = {年: tenGod(d, ec.getYearGan()), 月: tenGod(d, ec.getMonthGan()), 时: tenGod(d, ec.getTimeGan())};
    const c={}; ['比肩','劫财','食神','伤官','正财','偏财','正官','七杀','正印','偏印'].forEach(k=>c[k]=0);
    Object.values(tg).forEach(v=>{ if(c[v]!=null) c[v]++; });
    const yW = wuxingZhi[ec.getMonthZhi()];
    const has=k=>(c[k]||0)>0, many=(...ks)=>ks.reduce((s,k)=>s+(c[k]||0),0);
    if (has('正官') && !has('七杀')) return {name:'正官格', reason:'官清不见杀'};
    if (has('七杀') && (has('正印')||has('偏印'))) return {name:'杀印相生', reason:'有杀有印，化杀为权'};
    if (has('伤官') && (has('正印')||has('偏印'))) return {name:'伤官配印', reason:'伤官有印制'};
    if ((has('食神')||has('伤官')) && (has('正财')||has('偏财'))) return {name:'食伤生财', reason:'泄秀生财'};
    if (many('比肩','劫财')>=2) return {name:'比劫旺', reason:'同党旺'};
    if (yW===dW) return {name:'身旺取泄', reason:'月令同气'};
    return {name:'平格', reason:'未触发典型门类'};
  }

  // 生成四柱
  function genChart(prefix){
    const inps=needInputs(prefix); if(!inps) return null;
    const {y,m,d,h}=inps, s=Solar.fromYmdHms(y,m,d,h,0,0), l=s.getLunar(), ec=l.getEightChar();
    const stems=[ec.getYearGan(),ec.getMonthGan(),ec.getDayGan(),ec.getTimeGan()];
    const zhis=[ec.getYearZhi(),ec.getMonthZhi(),ec.getDayZhi(),ec.getTimeZhi()];
    const sw=strongWeakAndYong(ec), pat=patternGuess(ec);

    const kpiEl=document.getElementById('kpi'+prefix);
    const panel=document.getElementById('panel'+prefix);
    if(panel) panel.style.display='block';
    kpiEl.innerHTML='';
    [['四柱',ec.toString()],['日主', ec.getDayGan()+'（'+sw.dayMaster+'）'],['强弱', `${sw.strongWeak}（通根${sw.root.toFixed(2)}）`],['喜用', [...sw.yongSet].join('、')||'—'],['忌神',[...sw.jiSet].join('、')||'—'],['命格', pat.name+'：'+pat.reason]].forEach(([k,v])=>{
      const el=document.createElement('div'); el.className='kpi'; el.innerHTML=`<h3>${k}</h3><div>${v}</div>`; kpiEl.appendChild(el);
    });

    const tb=document.querySelector('#tab'+prefix+' tbody'); tb.innerHTML='';
    [['年',0],['月',1],['日',2],['时',3]].forEach(([lab,i])=>{
      const tr=document.createElement('tr'); tr.innerHTML=`
        <td>${lab}</td>
        <td>${stems[i]}（${wuxingGan[stems[i]]}）</td>
        <td>${zhis[i]}（${wuxingZhi[zhis[i]]}）</td>
        <td>${zhiCangText(zhis[i])}</td>`;
      tb.appendChild(tr);
    });

    const lines=[];
    lines.push(`公历：${y}-${m}-${d} ${String(h).padStart(2,'0')}:00`);
    lines.push(`四柱：${ec.toString()}`);
    const wc=sw.wc;
    lines.push(`五行统计（干1.0 + 藏干权重 + 月令0.5）：木${wc.木.toFixed(1)} 火${wc.火.toFixed(1)} 土${wc.土.toFixed(1)} 金${wc.金.toFixed(1)} 水${wc.水.toFixed(1)}`);
    document.getElementById('txt'+prefix).textContent=lines.join('\n');

    return { y,m,d,h, lunar:l, ec, stems, zhis,
      dayGan: ec.getDayGan(), dayZhi: ec.getDayZhi(),
      dayElement: wuxingGan[ec.getDayGan()],
      sw, pat
    };
  }

  // 关系统计
  function countInteractions(A,B){
    const res={ganHe:0,ganChong:0,zhiHe:0,zhiChong:0,notes:[]};
    const lab=['年','月','日','时'];
    for(let i=0;i<4;i++){
      const gA=A.stems[i], gB=B.stems[i], zA=A.zhis[i], zB=B.zhis[i];
      if(ganHe[gA]===gB){ res.ganHe+=(i===2?2:1); res.notes.push(`天干${lab[i]}柱合：${gA}+${gB}`); }
      if(ganChong[gA]===gB){ res.ganChong+=(i===2?2:1); res.notes.push(`天干${lab[i]}柱冲：${gA}×${gB}`); }
      if(zhiHePairs.has(zA+zB)){ res.zhiHe+=(i===2?2:1); res.notes.push(`地支${lab[i]}柱合：${zA}+${zB}`); }
      if(zhiChongPairs.has(zA+zB)){ res.zhiChong+=(i===2?2:1); res.notes.push(`地支${lab[i]}柱冲：${zA}×${zB}`); }
    }
    return res;
  }
  function favorTally(A,B){
    let aGain=0,bGain=0,aHitJi=0,bHitJi=0,notes=[];
    const countByWux = chart => chart.stems.map(g=>wuxingGan[g]).reduce((m,w)=>(m[w]=(m[w]||0)+1,m),{});
    const Aw=countByWux(A), Bw=countByWux(B);
    A.sw.yongSet.forEach(w=>{ if((Bw[w]||0)>0){ aGain+=1; notes.push(`A喜用${w} ← B天干提供`); }});
    B.sw.yongSet.forEach(w=>{ if((Aw[w]||0)>0){ bGain+=1; notes.push(`B喜用${w} ← A天干提供`); }});
    A.sw.jiSet.forEach(w=>{ if((Bw[w]||0)>0){ aHitJi+=1; notes.push(`A忌神${w} ← B天干放大`); }});
    B.sw.jiSet.forEach(w=>{ if((Aw[w]||0)>0){ bHitJi+=1; notes.push(`B忌神${w} ← A天干放大`); }});
    return {aGain,bGain,aHitJi,bHitJi,notes};
  }

  // 刑害破+三合三会
  function analyzeXHP_San(zhiList){
    let xing=0, hai=0, po=0, self=0, info=[];
    for(let i=0;i<zhiList.length;i++){
      for(let j=i;j<zhiList.length;j++){
        const a=zhiList[i], b=zhiList[j];
        if(i===j && selfXing.has(a)){ self++; info.push(`自刑：${a}`); }
        if(i===j) continue;
        const ab=a+b, ba=b+a;
        if(xingPairs.has(ab)||xingPairs.has(ba)){ xing++; info.push(`刑：${a}↔${b}`); }
        if(haiPairs.has(ab)||haiPairs.has(ba)){ hai++; info.push(`害：${a}↔${b}`); }
        if(poPairs.has(ab)||poPairs.has(ba)){ po++; info.push(`破：${a}↔${b}`); }
      }
    }
    function detectTri(groups){
      const hits=[];
      groups.forEach(g=>{
        const cnt = [...g.set].filter(z=>zhiList.includes(z)).length;
        if(cnt>=2) hits.push(`${g.name}（${g.elem}，${cnt}/3）`);
      });
      return hits.join('、') || '—';
    }
    return {
      xing: xing + (self>0?1:0),
      hai, po,
      sanhe: detectTri(sanHeGroups),
      sanhui: detectTri(sanHuiGroups),
      explain: info.join('；') || '—'
    };
  }

  // 评分
  function scoreMarriage(A,B){
    let score=60, reasons=[];
    const dA=A.dayGan, dB=B.dayGan, zA=A.dayZhi, zB=B.dayZhi;
    if(ganHe[dA]===dB){ score+=15; reasons.push(`日干五合：${dA}+${dB} → +15`); }
    if(ganChong[dA]===dB){ score-=15; reasons.push(`日干冲：${dA}×${dB} → −15`); }
    if(wuxingGan[dA]===wuxingGan[dB]){ score+=5; reasons.push(`日主同五行（价值观接近）→ +5`); }

    if(zhiHePairs.has(zA+zB)){ score+=10; reasons.push(`日支六合：${zA}+${zB} → +10`); }
    if(zhiChongPairs.has(zA+zB)){ score-=15; reasons.push(`日支六冲：${zA}×${zB} → −15`); }

    const it=countInteractions(A,B);
    score += it.ganHe*3 + it.zhiHe*3;
    score -= it.ganChong*3 + it.zhiChong*4;

    const fav=favorTally(A,B);
    score += (fav.aGain+fav.bGain)*4;
    score -= (fav.aHitJi+fav.bHitJi)*4;

    const ax=analyzeXHP_San([...A.zhis,...B.zhis]);
    score -= ax.xing*3 + ax.hai*2 + ax.po*2;

    score=Math.max(0,Math.min(100,Math.round(score)));
    return {score, reasons:[...reasons, `合/冲：干合${it.ganHe} 支合${it.zhiHe}｜干冲${it.ganChong} 支冲${it.zhiChong}`, `刑害破：刑${ax.xing} 害${ax.hai} 破${ax.po}`], it, fav, ax};
  }
  function scoreCareer(A,B){
    let score=60, reasons=[];
    const it=countInteractions(A,B);
    score += it.ganHe*3 + it.zhiHe*2;
    score -= it.ganChong*4 + it.zhiChong*3;

    function side(wc){ const mf=wc.木+wc.火, tjs=wc.土+wc.金+wc.水; return {mf,tjs}; }
    const Sa=side(A.sw.wc), Sb=side(B.sw.wc);
    if((Sa.mf>Sa.tjs && Sb.tjs>Sb.mf) || (Sa.tjs>Sa.mf && Sb.mf>Sb.tjs)){ score+=10; reasons.push('职能互补：一创意一执行 → +10'); }

    const fav=favorTally(A,B);
    score += (fav.aGain+fav.bGain)*5;
    score -= (fav.aHitJi+fav.bHitJi)*5;

    const ax=analyzeXHP_San([...A.zhis,...B.zhis]);
    score -= ax.xing*2 + ax.hai*1 + ax.po*1;

    const sanHelike = ax.sanhe.includes('（') ? 1 : 0;
    const sanHuilike = ax.sanhui.includes('（') ? 1 : 0;
    score += (sanHelike+sanHuilike)*3;

    score=Math.max(0,Math.min(100,Math.round(score)));
    return {score, reasons:[...reasons, `合/冲：干合${it.ganHe} 支合${it.zhiHe}｜干冲${it.ganChong} 支冲${it.zhiChong}`, `刑害破：刑${ax.xing} 害${ax.hai} 破${ax.po}`, (sanHelike||sanHuilike)?'三合/三会助力：组织协同加分':''], it, fav, ax};
  }

  // —— 明确的破解与落地建议 —— //
  function pick(arr){ return arr && arr.length ? arr[0] : null; }

  function buildActionable(type,A,B,calc){
    const list=[];
    const bothYong = [...new Set([...A.sw.yongSet].filter(x=>B.sw.yongSet.has(x)))];
    const bothJi   = [...new Set([...A.sw.jiSet].filter(x=>B.sw.jiSet.has(x)))];

    // 1) 明确元素
    if(bothYong.length){
      const e = bothYong[0];
      const em = elementMonths[e];
      list.push(`优先元素：${e}（共同喜用）。`);
      if(em){
        list.push(`【月份】${e}月令：${em.zhi.join(' / ')}；阳历参考：${em.greg[0]}。`);
        list.push(`【行业】侧重：${em.jobs.join('、')}。`);
      }
    } else {
      const e = pick([...A.sw.yongSet]) || pick([...B.sw.yongSet]);
      if(e){
        const em = elementMonths[e];
        list.push(`优先元素：${e}（单方核心喜用，优先由团队环境提供）。`);
        if(em){
          list.push(`【月份】${e}月令：${em.zhi.join(' / ')}；阳历参考：${em.greg[0]}。`);
          list.push(`【行业】可择：${em.jobs.join('、')}。`);
        }
      }
    }

    // 2) 忌神规避
    if(bothJi.length){
      const e = bothJi[0];
      const em = elementMonths[e];
      list.push(`规避元素：${e}（共同忌神）。`);
      if(em){
        list.push(`【避月】${em.zhi.join(' / ')}月尽量避免做终局性决策；改为试点+里程碑式推进。`);
        list.push(`【避业】少涉：${em.jobs.join('、')} 或以外包/第三方隔离风险。`);
      }
    }

    // 3) 刑/害/破专属破解
    const ax = calc.ax;
    if(ax.xing>0) list.push(`有“刑”：固定化SOP + 双复核 + 例外审批；刑月避免不可逆决策。`);
    if(ax.hai>0) list.push(`有“害”：设置信息墙与冲突披露；害月按书面流程留痕，减少误解与小人。`);
    if(ax.po>0)  list.push(`有“破”：采用A/B测试与短冲刺；破月不签长期不可解约合同。`);

    // 4) 三合 / 三会 助力的利用
    const elemFromTxt = (txt)=>{ const m = txt.match(/（(.+?)，/); return m?m[1]:null; };
    const shElem=elemFromTxt(ax.sanhe), shuiElem=elemFromTxt(ax.sanhui);
    const preferElem = shElem || shuiElem;
    if(preferElem && elementMonths[preferElem]){
      const em = elementMonths[preferElem];
      list.push(`三合/三会助力：偏向“${preferElem}”。`);
      list.push(`【择时】优先在 ${em.zhi.join(' / ')} 月推进关键节点（阳历 ${em.greg[0]}）。`);
      list.push(`【资源】对接 ${em.jobs.slice(0,4).join('、')} 相关资源/合作方。`);
    }

    // 5) 分工/沟通
    if(type==='career'){
      const Sa=A.sw.wc, Sb=B.sw.wc;
      const A_cre=(Sa.木+Sa.火)>(Sa.土+Sa.金+Sa.水), B_cre=(Sb.木+Sb.火)>(Sb.土+Sb.金+Sb.水);
      if(A_cre!==B_cre) list.push(`分工：一方主“外”（产品/增长/BD/品牌），一方主“内”（交付/风控/财控/法务）；KPI分离、权责对等。`);
      else list.push(`分工：侧重相近，采用“赛道分治/区域分账”，减少重叠与内耗。`);
    }else{
      const dA=A.dayGan,dB=B.dayGan;
      if(ganChong[dA]===dB) list.push(`沟通：设置“情绪暂停”暗号+24小时冷静期；重要议题使用书面共识清单。`);
      if(ganHe[dA]===dB)   list.push(`默契增幅：每周一次固定“共同项目”（课程/旅行/家庭项目），让合的能量落地。`);
    }

    // 6) 总体择期指引
    const yA=[...A.sw.yongSet], yB=[...B.sw.yongSet];
    const sel = (bothYong[0]) || (yA[0]) || (yB[0]);
    if(sel && elementMonths[sel]){
      const em = elementMonths[sel];
      list.push(`总体择期：以“${sel}”为主轴，关键推进放在 ${em.zhi.join(' / ')}（阳历 ${em.greg[0]}）。`);
    }
    return list;
  }

  // 渲染：刑/害/破表
  function renderXHPTable(A,B){
    const tb = document.querySelector('#tabXingHaiPo tbody'); tb.innerHTML='';
    const Ares = analyzeXHP_San(A.zhis);
    const Bres = analyzeXHP_San(B.zhis);
    const Mres = analyzeXHP_San([...A.zhis,...B.zhis]);
    [ ['A',Ares], ['B',Bres], ['合盘',Mres] ].forEach(([lab,res])=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${lab}</td><td>${res.xing}</td><td>${res.hai}</td><td>${res.po}</td><td>${res.sanhe}</td><td>${res.sanhui}</td><td>${res.explain}</td>`;
      tb.appendChild(tr);
    });

    const expl = [];
    expl.push('【名词解释】');
    expl.push('· 刑：规则/性格对撞，易内耗与纠结（寅巳申、丑未戌、子卯；辰/午/酉/亥自刑）。');
    expl.push('· 害：暗中掣肘、小人、误解成本升高（如子未、丑午、申亥等）。');
    expl.push('· 破：破坏/拆台，适合短周期试错，不宜终局性决策。');
    expl.push('· 三合/三会：同气相求/成局助力，利于组织协同与资源整合。');
    document.getElementById('txtXhpExplain').textContent=expl.join('\n');
  }

  // 渲染合盘
  function renderCompat(type,A,B,calc){
    document.getElementById('panelCompat').style.display='block';
    document.getElementById('compatType').textContent = type==='career' ? '（事业财运）' : '（婚姻）';

    const kpiC=document.getElementById('kpiC'); kpiC.innerHTML='';
    const bothYong=[...new Set([...A.sw.yongSet].filter(x=>B.sw.yongSet.has(x)))];
    const bothJi=[...new Set([...A.sw.jiSet].filter(x=>B.sw.jiSet.has(x)))];
    const score=calc.score;
    [
      ['总评分', score+'/100'],
      ['A日主', A.dayGan+'（'+A.dayElement+'；'+A.sw.strongWeak+'）'],
      ['B日主', B.dayGan+'（'+B.dayElement+'；'+B.sw.strongWeak+'）'],
      ['共同喜用', bothYong.join('、')||'—'],
      ['共同忌神', bothJi.join('、')||'—'],
      ['合/冲（权重）', `干合${calc.it.ganHe} 支合${calc.it.zhiHe}｜干冲${calc.it.ganChong} 支冲${calc.it.zhiChong}`]
    ].forEach(([k,v])=>{
      const el=document.createElement('div'); el.className='kpi'; el.innerHTML=`<h3>${k}</h3><div>${v}</div>`; kpiC.appendChild(el);
    });

    const txt=[];
    txt.push(`核心依据：日主关系、四柱合/冲、刑/害/破、喜用互补/忌神互踩、三合/三会助力、职能互补。`);
    calc.reasons.filter(Boolean).forEach((r,i)=>txt.push(`${i+1}. ${r}`));
    txt.push('');
    txt.push(`A喜用：${[...A.sw.yongSet].join('、')}；A忌神：${[...A.sw.jiSet].join('、')}`);
    txt.push(`B喜用：${[...B.sw.yongSet].join('、')}；B忌神：${[...B.sw.jiSet].join('、')}`);
    document.getElementById('txtCompat').textContent=txt.join('\n');

    renderXHPTable(A,B);

    const advUl=document.getElementById('adviceList'); advUl.innerHTML='';
    buildActionable(type,A,B,calc).forEach(s=>{
      const li=document.createElement('li'); li.textContent=s; advUl.appendChild(li);
    });
  }

  // 事件
  let A=null,B=null;
  document.getElementById('btnA').addEventListener('click', ()=>{ A=genChart('A'); });
  document.getElementById('btnB').addEventListener('click', ()=>{ B=genChart('B'); });
  document.getElementById('btnCareer').addEventListener('click', ()=>{
    if(!A) A=genChart('A'); if(!B) B=genChart('B'); if(!(A&&B)) return;
    const calc=scoreCareer(A,B); renderCompat('career',A,B,calc);
  });
  document.getElementById('btnMarriage').addEventListener('click', ()=>{
    if(!A) A=genChart('A'); if(!B) B=genChart('B'); if(!(A&&B)) return;
    const calc=scoreMarriage(A,B); renderCompat('marriage',A,B,calc);
  });
  // 运行示例（内建测试）
  document.getElementById('btnTest').addEventListener('click', ()=>{
    const st=document.getElementById('engineStatus'); st.textContent='排盘引擎：测试中…'; st.classList.remove('green','red'); st.classList.add('orange');
    try{
      if(!window.Solar||!window.Lunar) throw new Error('引擎未加载');
      const Atest={y:1990,m:1,d:1,h:12}, Btest={y:1992,m:6,d:10,h:8};
      document.getElementById('Ayear').value=Atest.y; document.getElementById('Amonth').value=Atest.m; document.getElementById('Aday').value=Atest.d; document.getElementById('Ahour').value=Atest.h;
      document.getElementById('Byear').value=Btest.y; document.getElementById('Bmonth').value=Btest.m; document.getElementById('Bday').value=Btest.d; document.getElementById('Bhour').value=Btest.h;
      A=genChart('A'); B=genChart('B');
      const mc=scoreMarriage(A,B), cc=scoreCareer(A,B);
      renderCompat('marriage',A,B,mc);
      alert(['✅ Solar.fromYmdHms 可用；A/B 排盘就绪','✅ 婚姻评分：'+mc.score,'✅ 事业评分：'+cc.score].join('\n'));
      st.textContent='排盘引擎：lunar-javascript（已就绪）'; st.classList.remove('orange'); st.classList.add('green');
    }catch(e){
      st.textContent='排盘引擎：lunar-javascript（加载失败）'; st.classList.remove('orange'); st.classList.add('red');
      alert('❌ 示例运行失败：'+e.message+'\n请检查网络是否能加载 CDN。');
    }
  });
</script>
</body>
</html>
