<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…«å­—æ’ç›˜ + å–œç”¨ç¥ & 60å¹´è¿åŠ¿ + å¤§è¿è¯„åˆ†</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
  <style>
    body{font-family:"Noto Sans SC",system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",sans-serif;background:#f6f7fb;margin:0;padding:24px;color:#1f2937}
    h1{margin:0 0 12px 0;font-size:24px;text-align:center}
    .status{font-weight:600;margin:8px 0 16px 0;text-align:center}
    .green{color:#16a34a}.red{color:#ef4444}.orange{color:#f59e0b}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 24px rgba(17,24,39,.06);margin-top:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row input[type="number"]{width:90px}
    .btn{padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:600}
    .btn-primary{background:#22c55e;color:#fff}.btn-secondary{background:#3b82f6;color:#fff}.btn-test{background:#f59e0b;color:#fff}.btn-ter{background:#8b5cf6;color:#fff}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:8px}
    .kpi{background:#0b1020;color:#fff;border-radius:12px;padding:12px}
    .kpi h3{margin:0 0 6px 0;font-size:13px;opacity:.8;font-weight:500}
    .kpi div{font-size:18px;font-weight:700}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1020;color:#cbd5e1;padding:10px;border-radius:8px;white-space:pre-wrap}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #e5e7eb;padding:10px 8px;text-align:left}
    th{background:#f9fafb;position:sticky;top:0;z-index:1}
    .scroll{max-height:60vh;overflow:auto;border-radius:12px}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;margin-right:6px;margin-bottom:4px;border:1px solid rgba(31,41,55,.12)}
    .tag-red{color:#ef4444;border-color:#fecaca;background:#fff1f2}
    .tag-green{color:#16a34a;border-color:#bbf7d0;background:#f0fdf4}
    .tag-amber{color:#b45309;border-color:#fde68a;background:#fffbeb}
    .muted{color:#6b7280;font-size:13px}
    .goodCell{font-weight:700}
  </style>
</head>
<body>
  <h1>å…«å­—æ’ç›˜ + å–œç”¨ç¥ & å‡ºç”Ÿå60å¹´è¿åŠ¿ + å¤§è¿è¯„åˆ†</h1>
  <div id="engineStatus" class="status">æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆåŠ è½½ä¸­â€¦ï¼‰</div>

  <div class="card">
    <div class="row">
      <label>å‡ºç”Ÿæ—¥æœŸæ—¶é—´ï¼š</label>
      <input type="number" id="year" placeholder="å¹´">
      <input type="number" id="month" placeholder="æœˆ">
      <input type="number" id="day" placeholder="æ—¥">
      <input type="number" id="hour" placeholder="æ—¶">
      <button class="btn btn-primary" id="btnBazi">ç”Ÿæˆå…«å­—</button>
      <button class="btn btn-secondary" id="btnLuck">ç”Ÿæˆ 60 å¹´è¿åŠ¿</button>
      <button class="btn btn-ter" id="btnDaYun">ç”Ÿæˆå¤§è¿è¯„åˆ†</button>
      <button class="btn btn-test" id="btnTest">è¿è¡Œå†…å»ºæµ‹è¯•</button>
    </div>
    <div class="muted" style="margin-top:6px">æç¤ºï¼šå°æ—¶æœªçŸ¥å¯å…ˆå¡« 12ï¼›éœ€è¦ä¸¥è°¨å¤§è¿ï¼ˆèµ·è¿å²æ•°ã€é¡ºé€†è¡Œï¼‰æ—¶ï¼Œè¯·å‘ŠçŸ¥æ€§åˆ«ä¸å‡ºç”Ÿåœ°/æ—¶åŒºã€‚</div>
  </div>

  <div class="card" id="panelBazi" style="display:none">
    <h2>ğŸ“œ å…«å­—æ’ç›˜ & å‘½æ ¼</h2>
    <div class="grid" id="kpi"></div>
    <pre class="code" id="baziText"></pre>
    <div id="yongshenBox" class="muted"></div>
  </div>

  <div class="card" id="panelLuck" style="display:none">
    <h2>ğŸ“ˆ å‡ºç”Ÿå 60 å¹´è¿åŠ¿è¯„åˆ†ï¼ˆæŒ‰å–œç”¨ç¥åŠ æƒï¼‰</h2>
    <div class="muted" style="margin-bottom:8px">
      æ ‡è®°ï¼š<span class="tag">æœ¬å‘½å¹´</span>/<span class="tag">å†²å¤ªå²</span>/<span class="tag">åˆå¤ªå²</span>ï¼Œ
      <span class="tag tag-red">é‡å¤§è½¬æŠ˜</span>ï¼ˆå­åˆå¯é…‰ï¼‰ï¼Œ
      <span class="tag tag-green">è´µäºº</span>ï¼ˆå¹´å¹²åˆæ—¥å¹²ï¼‰ï¼Œ
      <span class="tag tag-amber">å°äºº</span>ï¼ˆå¹´å¹²å†²æ—¥å¹²ï¼‰ã€‚è¯„åˆ†=åŸºç¡€åˆ†+å–œç”¨åŠ æˆâˆ’å¿Œç¥æ‰£åˆ†ï¼ˆå¹²>æ”¯ï¼‰ã€‚
    </div>
    <div class="card" id="summaryCard" style="background:#f9fafb">
      <h3 style="margin:4px 0 8px 0;">å¹´åº¦æ‘˜è¦</h3>
      <div id="summaryText" class="muted">ç”Ÿæˆåæ˜¾ç¤ºæœ€æ—º TOP5 / éœ€è°¨æ… TOP5ã€‚</div>
    </div>
    <div class="scroll" style="margin-top:8px">
      <table id="luckTable">
        <thead>
        <tr>
          <th>åº</th><th>å¹´ä»½</th><th>å¹´å¹²æ”¯</th><th>ç”Ÿè‚–</th>
          <th>æ ‡ç­¾</th><th>è¯„åˆ†</th><th>è¯´æ˜</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card" id="panelDaYun" style="display:none">
    <h2>ğŸ§­ å¤§è¿ï¼ˆå·¥ç¨‹ç‰ˆ 10 å¹´çª—å£ï¼‰</h2>
    <div class="muted">è¯´æ˜ï¼šå½“å‰ç‰ˆæœ¬æŒ‰å‡ºç”Ÿå¹´èµ·æ•´ 10 å¹´åˆ†æ®µï¼ˆY~Y+9ï¼‰ç»Ÿè®¡è¯¥æ®µå¹³å‡åˆ†ä¸å»ºè®®ã€‚éœ€è¦ä¸¥æ ¼èµ·è¿/é¡ºé€†è¡Œæ—¶ï¼Œè¯·å‘Šè¯‰æˆ‘æ€§åˆ«ä¸å‡ºç”Ÿåœ°ã€‚</div>
    <div class="scroll" style="margin-top:8px">
      <table id="dayunTable">
        <thead>
          <tr>
            <th>#</th><th>é˜¶æ®µ</th><th>èŒƒå›´</th><th>å‡åˆ†</th><th>ä»£è¡¨å¹´ä»½</th><th>å»ºè®®</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
  // å¼•æ“çŠ¶æ€
  window.addEventListener('load', () => {
    const st = document.getElementById('engineStatus');
    if (window.Solar && window.Lunar) { st.textContent = 'æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆå·²å°±ç»ªï¼‰'; st.classList.add('green'); }
    else { st.textContent = 'æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆåŠ è½½å¤±è´¥ï¼‰'; st.classList.add('red'); }
  });

  // æ˜ å°„è¡¨
  const wuxingGan = {ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'};
  const wuxingZhi = {å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'};
  const fourZheng = new Set(['å­','åˆ','å¯','é…‰']);
  const clashSX = {é¼ :'é©¬',ç‰›:'ç¾Š',è™:'çŒ´',å…”:'é¸¡',é¾™:'ç‹—',è›‡:'çŒª',é©¬:'é¼ ',ç¾Š:'ç‰›',çŒ´:'è™',é¸¡:'å…”',ç‹—:'é¾™',çŒª:'è›‡'};
  const heSX = {é¼ :'ç‰›',ç‰›:'é¼ ',è™:'çŒª',çŒª:'è™',å…”:'ç‹—',ç‹—:'å…”',é¾™:'é¸¡',é¸¡:'é¾™',è›‡:'çŒ´',çŒ´:'è›‡',é©¬:'ç¾Š',ç¾Š:'é©¬'};
  const ganHe = {ç”²:'å·±',ä¹™:'åºš',ä¸™:'è¾›',ä¸:'å£¬',æˆŠ:'ç™¸',å·±:'ç”²',åºš:'ä¹™',è¾›:'ä¸™',å£¬:'ä¸',ç™¸:'æˆŠ'};
  const ganChong = {ç”²:'åºš',ä¹™:'è¾›',ä¸™:'å£¬',ä¸:'ç™¸',æˆŠ:'ç”²',å·±:'ä¹™',åºš:'ç”²',è¾›:'ä¹™',å£¬:'ä¸™',ç™¸:'ä¸'};

  // è¾“å…¥æ£€æŸ¥
  function needInputs() {
    const y = parseInt(document.getElementById('year').value,10);
    const m = parseInt(document.getElementById('month').value,10);
    const d = parseInt(document.getElementById('day').value,10);
    const h = parseInt(document.getElementById('hour').value,10);
    if (!y || !m || !d || isNaN(h)) { alert('è¯·è¾“å…¥å®Œæ•´çš„ å¹´/æœˆ/æ—¥/æ—¶'); return null; }
    if (!window.Solar || !window.Lunar) { alert('å¼•æ“æœªåŠ è½½æˆåŠŸ'); return null; }
    return {y,m,d,h};
  }

  // å‘½æ ¼&å–œç”¨ç¥æ¨å¯¼ï¼ˆç®€åŒ–ç‰ˆï¼‰
  function inferMingJuAndYong(baziEC) {
    const stems = [baziEC.getYearGan(), baziEC.getMonthGan(), baziEC.getDayGan(), baziEC.getTimeGan()];
    const wuxCount = {æœ¨:0,ç«:0,åœŸ:0,é‡‘:0,æ°´:0};
    stems.forEach(g => { const w = wuxingGan[g]; if (w) wuxCount[w]++; });

    const dayGan = baziEC.getDayGan();
    const dayMaster = wuxingGan[dayGan];

    // å¼ºå¼±ï¼ˆç²—åˆ¤ï¼‰
    let strongWeak = 'ä¸­å’Œ';
    if (wuxCount[dayMaster] >= 3) strongWeak = 'åå¼º';
    if (wuxCount[dayMaster] <= 1) strongWeak = 'åå¼±';

    let yongSet = new Set(), jiSet = new Set();
    const ke = {æœ¨:'åœŸ',ç«:'é‡‘',åœŸ:'æ°´',é‡‘:'æœ¨',æ°´:'ç«'};
    const sheng = {æœ¨:'ç«',ç«:'åœŸ',åœŸ:'é‡‘',é‡‘:'æ°´',æ°´:'æœ¨'};
    const beiKe = Object.fromEntries(Object.entries(ke).map(([a,b])=>[b,a]));
    const shengWo = Object.fromEntries(Object.entries(sheng).map(([a,b])=>[b,a]));

    if (strongWeak === 'åå¼º') {
      yongSet.add(ke[dayMaster]);        // æˆ‘å…‹
      yongSet.add(beiKe[dayMaster]);     // å…‹æˆ‘è€…
      jiSet.add(dayMaster);               // åŒå…šä¸ºå¿Œ
    } else if (strongWeak === 'åå¼±') {
      yongSet.add(dayMaster);             // åŒå…š
      yongSet.add(shengWo[dayMaster]);    // ç”Ÿæˆ‘
      jiSet.add(ke[dayMaster]);           // å…‹æˆ‘
      jiSet.add(sheng[dayMaster]);        // æˆ‘ç”Ÿï¼ˆæ³„æˆ‘ï¼‰
    } else {
      const order = Object.entries(wuxCount).sort((a,b)=>a[1]-b[1]);
      yongSet.add(order[0][0]); yongSet.add(order[1][0]);
      jiSet.add(order[4][0]);
    }
    return { dayGan, dayMaster, strongWeak, wuxCount, yongSet, jiSet };
  }

  // å…«å­—
  function generateBazi() {
    const inps = needInputs(); if (!inps) return;
    const {y,m,d,h} = inps;
    const solar = Solar.fromYmdHms(y,m,d,h,0,0);
    const lunar = solar.getLunar();
    const ec = lunar.getEightChar();

    const lines = [];
    lines.push(`å…¬å†ï¼š${y}-${m}-${d} ${String(h).padStart(2,'0')}:00`);
    lines.push(`å†œå†ï¼š${lunar.toFullString()}`);
    lines.push(`å…«å­—ï¼š${ec.toString()}`);
    lines.push(`å››æŸ±ï¼šå¹´ ${ec.getYear()}ï½œæœˆ ${ec.getMonth()}ï½œæ—¥ ${ec.getDay()}ï½œæ—¶ ${ec.getTime()}`);
    lines.push(`æ—¥ä¸»ï¼ˆæ—¥å¹²ï¼‰ï¼š${ec.getDayGan()}`);

    document.getElementById('panelBazi').style.display='block';
    document.getElementById('baziText').textContent = lines.join('\n');

    const kpi = document.getElementById('kpi'); kpi.innerHTML='';
    [['ç”Ÿè‚–', lunar.getYearShengXiao()], ['æ—¥å¹²', ec.getDayGan()], ['å¹´å¹²æ”¯', ec.getYear()], ['æœˆä»¤ï¼ˆæœˆæ”¯ï¼‰', ec.getMonthZhi()]]
      .forEach(([k,v])=>{const el=document.createElement('div'); el.className='kpi'; el.innerHTML=`<h3>${k}</h3><div>${v}</div>`; kpi.appendChild(el);});

    const info = inferMingJuAndYong(ec);
    const wc = info.wuxCount;
    document.getElementById('yongshenBox').innerHTML =
      `äº”è¡Œåˆ†å¸ƒï¼šæœ¨${wc['æœ¨']} ç«${wc['ç«']} åœŸ${wc['åœŸ']} é‡‘${wc['é‡‘']} æ°´${wc['æ°´']}<br>
       å‘½å±€å¼ºå¼±ï¼š<b>${info.strongWeak}</b>ï¼›æ—¥ä¸»ï¼š<b>${info.dayMaster}</b><br>
       æ¨èå–œç”¨ç¥ï¼š<b>${[...info.yongSet].join('ã€')}</b>ï¼›å¿Œç¥ï¼š<b>${[...info.jiSet].join('ã€')}</b>`;
  }

  // 60å¹´è¿åŠ¿è¯„åˆ†
  function generateLuck60() {
    const inps = needInputs(); if (!inps) return;
    const {y,m,d,h} = inps;

    const baseSolar = Solar.fromYmdHms(y,m,d,h,0,0);
    const baseLunar = baseSolar.getLunar();
    const baseEC = baseLunar.getEightChar();
    const { dayGan, yongSet, jiSet } = inferMingJuAndYong(baseEC);
    const myAnimal = baseLunar.getYearShengXiao();

    const tbody=document.querySelector('#luckTable tbody'); tbody.innerHTML='';
    const rows = [];

    for (let i=0; i<60; i++){
      const Y = y + i;
      const s = Solar.fromYmdHms(Y,m,d,h,0,0);
      const l = s.getLunar();
      const gan = l.getYearGan();
      const zhi = l.getYearZhi();
      const gz = l.getYearInGanZhi();
      const animal = l.getYearShengXiao();

      const tags = [];
      if (animal === myAnimal) tags.push('<span class="tag">æœ¬å‘½å¹´</span>');
      if (clashSX[myAnimal] === animal) tags.push('<span class="tag">å†²å¤ªå²</span>');
      if (heSX[myAnimal] === animal) tags.push('<span class="tag">åˆå¤ªå²</span>');
      if (fourZheng.has(zhi)) tags.push('<span class="tag tag-red">é‡å¤§è½¬æŠ˜</span>');
      if (ganHe[dayGan] === gan) tags.push('<span class="tag tag-green">è´µäºº</span>');
      if (ganChong[dayGan] === gan) tags.push('<span class="tag tag-amber">å°äºº</span>');

      let score = 50;
      const ganW = wuxingGan[gan], zhiW = wuxingZhi[zhi];
      const marks = [];
      if (yongSet.has(ganW)) { score += 20; marks.push(`å¹´å¹²${gan}å±${ganW}âˆˆå–œç”¨ +20`); }
      if (yongSet.has(zhiW)) { score += 12; marks.push(`å¹´æ”¯${zhi}å±${zhiW}âˆˆå–œç”¨ +12`); }
      if (jiSet.has(ganW))   { score -= 20; marks.push(`å¹´å¹²${gan}å±${ganW}âˆˆå¿Œç¥ âˆ’20`); }
      if (jiSet.has(zhiW))   { score -= 12; marks.push(`å¹´æ”¯${zhi}å±${zhiW}âˆˆå¿Œç¥ âˆ’12`); }

      if (animal === myAnimal) { /* æœ¬å‘½å¹´ä»…æç¤º */ }
      if (clashSX[myAnimal] === animal) { score -= 5; marks.push('å†²å¤ªå² âˆ’5'); }
      if (heSX[myAnimal] === animal) { score += 5; marks.push('åˆå¤ªå² +5'); }
      if (fourZheng.has(zhi)) { score += 4; marks.push('å››æ­£èŠ‚ç‚¹ +4'); }

      score = Math.max(0, Math.min(100, score));
      const adv = buildAdvice({score, gan, ganW, zhi, zhiW, tags});
      rows.push({Y, gz, animal, tags:tags.join(' '), score, adv});
    }

    const top5 = [...rows].sort((a,b)=>b.score-a.score).slice(0,5);
    const low5 = [...rows].sort((a,b)=>a.score-b.score).slice(0,5);
    document.getElementById('summaryText').textContent =
      `æœ€æ—º TOP5ï¼š${top5.map(r=>`${r.Y}(${r.gz}ï¼š${r.score})`).join('ï¼Œ')} ï½œ ` +
      `éœ€è°¨æ… TOP5ï¼š${low5.map(r=>`${r.Y}(${r.gz}ï¼š${r.score})`).join('ï¼Œ')}`;

    const tbodyEl = document.querySelector('#luckTable tbody');
    rows.forEach((r,idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${r.Y}${(new Date().getFullYear()===r.Y)?'ï¼ˆä»Šå¹´ï¼‰':''}</td>
        <td>${r.gz}</td>
        <td>${r.animal}</td>
        <td>${r.tags}</td>
        <td class="goodCell">${r.score}</td>
        <td>${r.adv}</td>`;
      tbodyEl.appendChild(tr);
    });
    document.getElementById('panelLuck').style.display='block';
  }

  // å¤§è¿ï¼ˆå·¥ç¨‹ç‰ˆ 10 å¹´çª—å£ï¼šY~Y+9ï¼‰â€”â€”æŒ‰æµå¹´åˆ†æ•°æ±‚å‡å€¼ + å»ºè®®
  function generateDaYun() {
    const inps = needInputs(); if (!inps) return;
    const {y} = inps;

    // å¦‚æœè¿˜æ²¡ç”Ÿæˆè¿‡ 60 å¹´åˆ—è¡¨ï¼Œå…ˆç”Ÿæˆæ‹¿åˆ°å¹´åº¦åˆ†
    const tableRows = document.querySelectorAll('#luckTable tbody tr');
    if (tableRows.length === 0) generateLuck60();

    // æ”¶é›† 60 å¹´åˆ†æ•°
    const years = [];
    document.querySelectorAll('#luckTable tbody tr').forEach(tr=>{
      const Y = parseInt(tr.children[1].textContent,10);
      const score = parseFloat(tr.children[5].textContent);
      years.push({Y, score, adv: tr.children[6].textContent, gz: tr.children[2].textContent});
    });

    // åˆ†æ®µï¼š6 æ®µå¤§è¿ï¼ˆY~Y+9ï¼‰
    const segments = [];
    for (let k=0; k<6; k++){
      const start = y + 10*k;
      const end = start + 9;
      const slice = years.filter(r=>r.Y>=start && r.Y<=end);
      const avg = slice.length ? Math.round((slice.reduce((a,b)=>a+b.score,0)/slice.length)*10)/10 : 0;
      // ä»£è¡¨å¹´ä»½ï¼šåˆ†æ•°æœ€é«˜çš„ä¸¤å¹´
      const reps = slice.sort((a,b)=>b.score-a.score).slice(0,2).map(r=>`${r.Y}(${r.gz}:${r.score})`).join('ï¼Œ');
      const advise = adviseByAvg(avg);
      segments.push({idx:k+1, title:`ç¬¬${k+1}è¿`, range:`${start}~${end}`, avg, reps, advise});
    }

    // æ¸²æŸ“
    const tbody = document.querySelector('#dayunTable tbody');
    tbody.innerHTML='';
    segments.forEach(seg=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${seg.idx}</td><td>${seg.title}</td><td>${seg.range}</td><td class="goodCell">${seg.avg}</td><td>${seg.reps}</td><td>${seg.advise}</td>`;
      tbody.appendChild(tr);
    });
    document.getElementById('panelDaYun').style.display='block';
  }

  function adviseByAvg(avg){
    if (avg>=80) return 'é»„é‡‘é˜¶æ®µï¼šæ‰©å¼ ã€æ‹¿ç‰Œç…§/èƒŒä¹¦ã€å…³é”®å†²åˆº';
    if (avg>=65) return 'ä¸Šå‡é˜¶æ®µï¼šè¿­ä»£åšå¼ºï¼Œé€‚åº¦è¿›æ”»';
    if (avg>=50) return 'å¹³è¡¡é˜¶æ®µï¼šç¨³å¥è¿è¥ã€ä¼˜åŒ–ç»“æ„';
    if (avg>=35) return 'ä¿®å¤é˜¶æ®µï¼šèšç„¦å­¦ä¹ ä¸å·©å›ºæ ¹åŸº';
    return 'ä½è°·é˜¶æ®µï¼šä¸¥æ§é£é™©ï¼Œå®ˆæ­£å¾…æ—¶';
  }

  function buildAdvice({score, gan, ganW, zhi, zhiW, tags}) {
    const tagStr = (tags||[]).toString();
    const parts = [];
    if (score >= 80) parts.push('é¡ºåŠ¿æ‰©å¼ ï¼Œå®œç«‹ç›®æ ‡ä¸å†²åˆºå…³é”®é¡¹ç›®');
    else if (score >= 65) parts.push('ç¨³ä¸­æœ‰è¿›ï¼Œé€‚åˆè¿­ä»£ä¸ç§¯ç´¯');
    else if (score >= 50) parts.push('å¹³ç¨³è¿è¥ï¼Œæ§åˆ¶æˆæœ¬ä¸é£é™©');
    else if (score >= 35) parts.push('ä¿å®ˆä¸ºä¸»ï¼Œèšç„¦ä¿®å¤ä¸å­¦ä¹ ');
    else parts.push('è°¨æ…è¡Œäº‹ï¼Œé¿å…é‡èµ„äº§ä¸å¤§å†³ç­–');
    parts.push(`å¹²${gan}ï¼ˆ${ganW}ï¼‰æ”¯${zhi}ï¼ˆ${zhiW}ï¼‰`);
    if (tagStr.includes('è´µäºº')) parts.push('è´µäººåŠ©åŠ›ï¼Œå®œåˆä½œ/èƒŒä¹¦');
    if (tagStr.includes('å°äºº')) parts.push('äººäº‹è€ƒéªŒï¼Œæå‰åšé¢„æ¡ˆ');
    if (tagStr.includes('é‡å¤§è½¬æŠ˜')) parts.push('èŠ‚ç‚¹å¹´ï¼Œé€‚åˆå®šæ–¹å‘/æ¬è¿/è½¬å‹');
    return parts.join('ï¼›'); // âœ… ä¿®å¤ï¼šä½¿ç”¨åŠè§’ join('ï¼›')
  }

  // å†…å»ºæµ‹è¯•ï¼ˆä¿ç•™ + æ–°å¢ï¼‰
  function runTests() {
    const st = document.getElementById('engineStatus');
    st.textContent = 'æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆæµ‹è¯•ä¸­â€¦ï¼‰'; st.classList.remove('green','red'); st.classList.add('orange');
    const out=[];
    try{
      if(!window.Solar||!window.Lunar) throw new Error('å¼•æ“æœªåŠ è½½');
      out.push('âœ… å¼•æ“å…¨å±€å¯¹è±¡å­˜åœ¨');
      const s1=Solar.fromYmd(1990,1,1);
      const l1=s1.getLunar();
      out.push('âœ… 1990-01-01 è½¬å†œå†ï¼š'+l1.toFullString());
      const ec=l1.getEightChar();
      out.push('âœ… å››æŸ±ï¼š'+[ec.getYear(),ec.getMonth(),ec.getDay(),ec.getTime()].join(' '));
      const s2=Solar.fromYmdHms(2000,5,20,14,0,0);
      out.push('âœ… fromYmdHmsï¼š'+s2.toString());
      // æ–°å¢ï¼šæ ¡éªŒå¹´å¹²æ”¯ API æ˜¯å¦å­˜åœ¨
      if (!l1.getYearGan || !l1.getYearZhi || !l1.getYearInGanZhi) throw new Error('å¹´å¹²æ”¯APIç¼ºå¤±');
      out.push('âœ… å¹´å¹²æ”¯API å¯ç”¨ï¼š' + l1.getYearInGanZhi());
      st.textContent='æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆå·²å°±ç»ªï¼‰'; st.classList.remove('orange'); st.classList.add('green');
    }catch(e){
      out.push('âŒ æµ‹è¯•å¤±è´¥ï¼š'+e.message);
      st.textContent='æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆåŠ è½½å¤±è´¥ï¼‰'; st.classList.remove('orange'); st.classList.add('red');
    }
    document.getElementById('panelBazi').style.display='block';
    document.getElementById('baziText').textContent=out.join('\n');
    document.getElementById('kpi').innerHTML='';
    document.getElementById('yongshenBox').innerHTML='';
  }

  // äº‹ä»¶ç»‘å®š
  document.getElementById('btnBazi').addEventListener('click', generateBazi);
  document.getElementById('btnLuck').addEventListener('click', generateLuck60);
  document.getElementById('btnDaYun').addEventListener('click', generateDaYun);
  document.getElementById('btnTest').addEventListener('click', runTests);
</script>
</body>
</html>
