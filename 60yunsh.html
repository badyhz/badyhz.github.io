<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å…«å­—æ’ç›˜ä¸å‡ºç”Ÿå60å¹´è¿åŠ¿</title>
  <style>
    body { font-family: "Noto Sans SC", system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", sans-serif; background:#f6f7fb; margin:0; padding:24px; color:#1f2937; }
    h1 { margin:0 0 12px 0; font-size:24px; text-align:center; }
    .status { font-weight:600; margin: 8px 0 16px 0; text-align:center; }
    .green { color:#16a34a; } .red { color:#ef4444; } .orange { color:#f59e0b; }
    .card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 6px 24px rgba(17,24,39,.06); margin-top:16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .row input[type="number"] { width:90px; }
    .btn { padding:10px 14px; border:none; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn-primary { background:#22c55e; color:#fff; }
    .btn-secondary { background:#3b82f6; color:#fff; }
    .btn-test { background:#f59e0b; color:#fff; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border-bottom:1px solid #e5e7eb; padding:10px 8px; text-align:left; }
    th { background:#f9fafb; position:sticky; top:0; z-index:1; }
    .tag { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; margin-right:6px; margin-bottom:4px; border:1px solid rgba(31,41,55,.12); }
    .tag-red { color:#ef4444; border-color:#fecaca; background:#fff1f2; }
    .tag-green { color:#16a34a; border-color:#bbf7d0; background:#f0fdf4; }
    .tag-amber { color:#b45309; border-color:#fde68a; background:#fffbeb; }
    .muted { color:#6b7280; font-size:13px; }
    .grid { display:grid; grid-template-columns: repeat(4, minmax(200px, 1fr)); gap:8px; }
    .kpi { background:#0b1020; color:#fff; border-radius:12px; padding:12px; }
    .kpi h3 { margin:0 0 6px 0; font-size:13px; opacity:.8; font-weight:500; }
    .kpi div { font-size:18px; font-weight:700; }
    .scroll { max-height:60vh; overflow:auto; border-radius:12px; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0b1020; color:#cbd5e1; padding:10px; border-radius:8px; }
  </style>
</head>
<body>
  <h1>å…«å­—æ’ç›˜ä¸å‡ºç”Ÿå60å¹´è¿åŠ¿</h1>
  <div id="engineStatus" class="status">æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆåŠ è½½ä¸­â€¦ï¼‰</div>

  <div class="card">
    <div class="row">
      <label>å‡ºç”Ÿæ—¥æœŸæ—¶é—´ï¼š</label>
      <input type="number" id="year" placeholder="å¹´" />
      <input type="number" id="month" placeholder="æœˆ" />
      <input type="number" id="day" placeholder="æ—¥" />
      <input type="number" id="hour" placeholder="æ—¶" />
      <button class="btn btn-primary" id="btnBazi">ç”Ÿæˆå…«å­—åˆ†æ</button>
      <button class="btn btn-secondary" id="btnLuck">ç”Ÿæˆå‡ºç”Ÿå60å¹´è¿åŠ¿</button>
      <button class="btn btn-test" id="btnTest">è¿è¡Œå†…å»ºæµ‹è¯•</button>
    </div>
    <div class="muted" style="margin-top:6px">æç¤ºï¼šå°æ—¶æœªçŸ¥å¯å¡« 12ï¼›å¦‚é‡ç½‘ç»œæ³¢åŠ¨å¯¼è‡´è„šæœ¬æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚</div>
  </div>

  <div class="card" id="panelBazi" style="display:none">
    <h2>ğŸ“œ å…«å­—å››æŸ±</h2>
    <div class="grid" id="kpi"></div>
    <pre class="code" id="baziText"></pre>
  </div>

  <div class="card" id="panelLuck" style="display:none">
    <h2>ğŸ“ˆ å‡ºç”Ÿå 60 å¹´è¿åŠ¿æ—¶é—´è½´</h2>
    <div class="muted" id="luckHint" style="margin-bottom:8px">æ ‡è®°è§„åˆ™ï¼š<span class="tag tag-red">é‡å¤§è½¬æŠ˜</span> å››æ­£åœ°æ”¯ï¼ˆå­åˆå¯é…‰ï¼‰ï¼›<span class="tag tag-green">è´µäºº</span> å¹´å¹²ä¸æ—¥å¹²ç›¸åˆï¼›<span class="tag tag-amber">å°äºº</span> å¹´å¹²ä¸æ—¥å¹²ç›¸å†²ï¼›å¦æœ‰ <span class="tag">æœ¬å‘½å¹´</span>/<span class="tag">å†²å¤ªå²</span>/<span class="tag">åˆå¤ªå²</span>ã€‚</div>
    <div class="scroll">
      <table id="luckTable">
        <thead>
          <tr>
            <th>åº</th>
            <th>å¹´ä»½</th>
            <th>å¹´å¹²æ”¯</th>
            <th>ç”Ÿè‚–</th>
            <th>æ ‡è®°</th>
            <th>æç¤º</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- lunar-javascriptï¼šUMDï¼Œå…¨å±€æä¾› Solar/Lunar -->
  <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
  <script>
    // â€”â€” å¼•æ“çŠ¶æ€ â€”â€” //
    window.addEventListener('load', () => {
      const st = document.getElementById('engineStatus');
      if (window.Solar && window.Lunar) { st.textContent = 'æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆå·²å°±ç»ªï¼‰'; st.classList.add('green'); }
      else { st.textContent = 'æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆåŠ è½½å¤±è´¥ï¼‰'; st.classList.add('red'); }
      console.log('Solar', window.Solar, 'Lunar', window.Lunar);
    });

    // â€”â€” å·¥å…·è¡¨ â€”â€” //
    const clashSX = { é¼ :'é©¬', ç‰›:'ç¾Š', è™:'çŒ´', å…”:'é¸¡', é¾™:'ç‹—', è›‡:'çŒª', é©¬:'é¼ ', ç¾Š:'ç‰›', çŒ´:'è™', é¸¡:'å…”', ç‹—:'é¾™', çŒª:'è›‡' };
    const heSX = { é¼ :'ç‰›', ç‰›:'é¼ ', è™:'çŒª', çŒª:'è™', å…”:'ç‹—', ç‹—:'å…”', é¾™:'é¸¡', é¸¡:'é¾™', è›‡:'çŒ´', çŒ´:'è›‡', é©¬:'ç¾Š', ç¾Š:'é©¬' };
    const fourZheng = new Set(['å­','åˆ','å¯','é…‰']); // å››æ­£åœ°æ”¯
    const ganHe = { ç”²:'å·±', ä¹™:'åºš', ä¸™:'è¾›', ä¸:'å£¬', æˆŠ:'ç™¸', å·±:'ç”²', åºš:'ä¹™', è¾›:'ä¸™', å£¬:'ä¸', ç™¸:'æˆŠ' };
    const ganChong = { ç”²:'åºš', ä¹™:'è¾›', ä¸™:'å£¬', ä¸:'ç™¸', æˆŠ:'ç”²', å·±:'ä¹™', åºš:'ç”²', è¾›:'ä¹™', å£¬:'ä¸™', ç™¸:'ä¸' };

    function ensureInputs() {
      const y = parseInt(document.getElementById('year').value, 10);
      const m = parseInt(document.getElementById('month').value, 10);
      const d = parseInt(document.getElementById('day').value, 10);
      const h = parseInt(document.getElementById('hour').value, 10);
      if (!y || !m || !d || isNaN(h)) { alert('è¯·è¾“å…¥å®Œæ•´çš„ å¹´ / æœˆ / æ—¥ / æ—¶'); return null; }
      if (!window.Solar || !window.Lunar) { alert('æ’ç›˜å¼•æ“æœªåŠ è½½æˆåŠŸï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è„šæœ¬åœ°å€ã€‚'); return null; }
      return { y, m, d, h };
    }

    // â€”â€” å…«å­—åˆ†æ â€”â€” //
    function generateBazi() {
      const inps = ensureInputs(); if (!inps) return;
      const { y, m, d, h } = inps;
      const solar = Solar.fromYmdHms(y, m, d, h, 0, 0);
      const lunar = solar.getLunar();
      const ec = lunar.getEightChar();

      const lines = [];
      lines.push(`å…¬å†ï¼š${y}-${m}-${d} ${String(h).padStart(2,'0')}:00`);
      lines.push(`å†œå†ï¼š${lunar.toFullString()}`);
      lines.push(`å…«å­—ï¼š${ec.toString()}`);
      lines.push(`å››æŸ±ï¼šå¹´ ${ec.getYear()}ï½œæœˆ ${ec.getMonth()}ï½œæ—¥ ${ec.getDay()}ï½œæ—¶ ${ec.getTime()}`);
      lines.push(`æ—¥ä¸»ï¼ˆæ—¥å¹²ï¼‰ï¼š${ec.getDayGan()}`);

      document.getElementById('baziText').textContent = lines.join('\n');
      document.getElementById('panelBazi').style.display = 'block';

      // å°KPIï¼šç”Ÿè‚–ã€æ—¥å¹²ã€å¹´æ”¯ã€æ—¶åŒºï¼ˆæ˜¾ç¤ºä¿¡æ¯è€Œå·²ï¼‰
      const kpi = document.getElementById('kpi');
      kpi.innerHTML = '';
      const kpis = [
        ['ç”Ÿè‚–', lunar.getYearShengXiao()],
        ['æ—¥å¹²', ec.getDayGan()],
        ['å¹´æ”¯', ec.getYearZhi()],
        ['å¹´å¹²', ec.getYearGan()],
      ];
      kpis.forEach(([k, v]) => {
        const el = document.createElement('div'); el.className = 'kpi';
        el.innerHTML = `<h3>${k}</h3><div>${v}</div>`;
        kpi.appendChild(el);
      });
    }

    // â€”â€” 60å¹´æ—¶é—´è½´ â€”â€” //
    function generateLuck60() {
      const inps = ensureInputs(); if (!inps) return;
      const { y, m, d, h } = inps;

      // åŸºå‡†å…«å­—ï¼ˆç”¨äºå–æ—¥å¹²ã€ç”Ÿè‚–åŸºå‡†ç­‰ï¼‰
      const baseSolar = Solar.fromYmdHms(y, m, d, h, 0, 0);
      const baseLunar = baseSolar.getLunar();
      const baseEC = baseLunar.getEightChar();
      const dayGan = baseEC.getDayGan();
      const myAnimal = baseLunar.getYearShengXiao();

      const tbody = document.querySelector('#luckTable tbody');
      tbody.innerHTML = '';
      let bestYears = []; // æ”¶é›†â€œæœ‰åˆ©/éœ€é˜²â€çš„æ‘˜è¦ï¼ˆå¯æ‰©å±•ï¼‰

      for (let i = 0; i < 60; i++) {
        const Y = y + i;
        const sol = Solar.fromYmdHms(Y, m, d, h, 0, 0);
        const lun = sol.getLunar();
        const gz = lun.getYearInGanZhi();    // å¹´å¹²æ”¯ï¼ˆä¾‹å¦‚ï¼šç”²å­ï¼‰
        const gan = gz.charAt(0);            // å¤©å¹²
        const zhi = gz.charAt(1);            // åœ°æ”¯
        const animal = lun.getYearShengXiao();

        // æ ‡è®°ï¼ˆæœ¬å‘½å¹´/å†²å¤ªå²/åˆå¤ªå²ï¼‰
        const tags = [];
        if (animal === myAnimal) tags.push('<span class="tag">æœ¬å‘½å¹´</span>');
        if (clashSX[myAnimal] === animal) tags.push('<span class="tag">å†²å¤ªå²</span>');
        if (heSX[myAnimal] === animal) tags.push('<span class="tag">åˆå¤ªå²</span>');

        // é‡å¤§è½¬æŠ˜ï¼ˆå››æ­£ï¼‰
        const marks = [];
        if (fourZheng.has(zhi)) marks.push('<span class="tag tag-red">é‡å¤§è½¬æŠ˜</span>');

        // è´µäºº/å°äººï¼šå¹´å¹²ä¸æ—¥å¹²
        const hints = [];
        if (ganHe[dayGan] === gan) { marks.push('<span class="tag tag-green">è´µäºº</span>'); hints.push('è´µäººç›¸åŠ©ï¼Œåˆ©åä½œ/èµ„æº'); }
        if (ganChong[dayGan] === gan) { marks.push('<span class="tag tag-amber">å°äºº</span>'); hints.push('äººé™…æ£è‚˜ï¼Œå®œç¨³é‡å¤„äº‹'); }

        // è½»é‡æç¤ºï¼ˆå››åŸŸéšæœºæ¨¡æ¿ï¼Œå¯æ›¿æ¢ä¸ºæ›´ç²¾ç»†ç®—æ³•ï¼‰
        const suggest = domainHints(Y, animal, {gan, zhi});

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${Y}${(new Date().getFullYear()===Y)?'ï¼ˆä»Šå¹´ï¼‰':''}</td>
          <td>${gz}</td>
          <td>${animal}</td>
          <td>${[...tags, ...marks].join(' ')}</td>
          <td>${[...hints, suggest].join('ï¼›')}</td>
        `;
        tbody.appendChild(tr);
      }

      document.getElementById('panelLuck').style.display = 'block';
    }

    // â€”â€” ç®€åŒ–çš„é¢†åŸŸæç¤ºï¼ˆå¯æ›¿æ¢æˆåŸºäºåç¥/å–œå¿Œçš„æƒé‡ï¼‰ â€”â€” //
    function domainHints(year, animal, {gan, zhi}) {
      // åŸºäºâ€œå†²åˆ/å››æ­£/å¹²ç›¸åˆ/ç›¸å†²â€ç»™å‡ºä¸€å¥åˆæˆæç¤º
      const parts = [];
      if (fourZheng.has(zhi)) parts.push('èŠ‚ç‚¹å¹´ï¼šé€‚åˆå®šå¤§æ–¹å‘/æ¬è¿/è½¬å‹');
      if (/åˆ|å·³/.test(zhi)) parts.push('äº‹ä¸šçƒ­åº¦ä¸Šå‡ï¼Œæ³¨æ„èŠ‚å¥ä¸è€å¿ƒ');
      if (/å­|äº¥/.test(zhi)) parts.push('äººè„‰/å­¦ä¹ æå‡ï¼Œåˆ©è€ƒè¯ä¸å¤ç›˜');
      if (ganHe[gan]) {} // ä»…å ä½ï¼Œé¿å… ESLint æŠ¥æœªç”¨
      // ç®€çŸ­å››åŸŸæ‹¼å¥ï¼ˆæ¼”ç¤ºï¼‰
      const pool = [
        'æ„Ÿæƒ…ï¼šæ²Ÿé€šä¸ºå…ˆï¼Œå®œä¸»åŠ¨åˆ›é€ ç›¸å¤„æœºä¼š',
        'è´¢è¿ï¼šç°é‡‘æµä¼˜å…ˆï¼Œè°¨æ…æ æ†',
        'äº‹ä¸šï¼šæ˜ç¡®ç›®æ ‡ï¼Œåˆ©é¡¹ç›®æ¨è¿›ä¸èƒŒä¹¦',
        'å®¶åº­ï¼šå¤šé™ªä¼´ä¸å€¾å¬ï¼Œåè°ƒä½œæ¯'
      ];
      // éšæœºæŠ½ä¸¤æ¡ï¼Œä¿è¯æ¯è¡Œä¸å†—é•¿
      for (let i = 0; i < 2; i++) {
        const pick = pool.splice(Math.floor(Math.random()*pool.length), 1)[0];
        parts.push(pick);
      }
      return parts.join('ï¼›');
    }

    // â€”â€” å†…å»ºæµ‹è¯• â€”â€” //
    function runTests() {
      const st = document.getElementById('engineStatus');
      st.textContent = 'æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆæµ‹è¯•ä¸­â€¦ï¼‰'; st.classList.remove('green','red'); st.classList.add('orange');
      const out = [];
      try {
        if (!window.Solar || !window.Lunar) throw new Error('å¼•æ“æœªåŠ è½½');
        out.push('âœ… å¼•æ“å…¨å±€å¯¹è±¡å­˜åœ¨');
        const s1 = Solar.fromYmd(1990,1,1);
        const l1 = s1.getLunar();
        out.push('âœ… 1990-01-01 è½¬å†œå†ï¼š' + l1.toFullString());
        const ec = l1.getEightChar();
        out.push('âœ… å››æŸ±å¯å¾—ï¼š' + [ec.getYear(), ec.getMonth(), ec.getDay(), ec.getTime()].join(' '));
        const s2 = Solar.fromYmdHms(2000,5,20,14,0,0);
        out.push('âœ… fromYmdHms æ­£å¸¸ï¼š' + s2.toString());
        st.textContent = 'æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆå·²å°±ç»ªï¼‰'; st.classList.remove('orange'); st.classList.add('green');
      } catch(e) {
        out.push('âŒ æµ‹è¯•å¤±è´¥ï¼š' + e.message);
        st.textContent = 'æ’ç›˜å¼•æ“ï¼šlunar-javascriptï¼ˆåŠ è½½å¤±è´¥ï¼‰'; st.classList.remove('orange'); st.classList.add('red');
      }
      // æŠŠæµ‹è¯•ç»“æœæ˜¾ç¤ºåœ¨å…«å­—é¢æ¿
      const box = document.getElementById('panelBazi'); box.style.display = 'block';
      document.getElementById('baziText').textContent = out.join('\n');
      document.getElementById('kpi').innerHTML = '';
    }

    // â€”â€” ç»‘å®šæŒ‰é’® â€”â€” //
    document.getElementById('btnBazi').addEventListener('click', generateBazi);
    document.getElementById('btnLuck').addEventListener('click', generateLuck60);
    document.getElementById('btnTest').addEventListener('click', runTests);
  </script>
</body>
</html>
