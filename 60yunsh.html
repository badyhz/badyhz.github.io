<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>八字排盘 + 命格解析 + 运势</title>
  <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
  <style>
    body { font-family: "Noto Sans SC", sans-serif; padding: 20px; }
    h1 { color: #444; }
    .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
    button { padding: 8px 14px; margin: 5px; border-radius: 6px; border: none; cursor: pointer; background: #3a86ff; color: white; }
    button:hover { opacity: 0.9; }
    .ok { color: green; font-weight: bold; }
    .fail { color: red; font-weight: bold; }
    ul { line-height: 1.6; }
    .score { font-size: 18px; font-weight: bold; color: #d62828; }
  </style>
</head>
<body>
  <h1>八字排盘 & 命格解析 & 出生后60年运势</h1>

  <div id="engineStatus" class="section">排盘引擎：加载中…</div>
  <button onclick="runTest()">运行内建测试</button>

  <div class="section">
    <h2>输入出生信息</h2>
    <label>出生年份: <input type="number" id="year" value="1990"></label>
    <label>月份: <input type="number" id="month" value="1"></label>
    <label>日期: <input type="number" id="day" value="1"></label>
    <label>时辰(0-23): <input type="number" id="hour" value="12"></label>
    <button onclick="generateBazi()">生成八字</button>
  </div>

  <div class="section">
    <h2>八字排盘结果</h2>
    <div id="baziResult"></div>
  </div>

  <div class="section">
    <h2>命格 & 喜用神解析</h2>
    <div id="minggeResult"></div>
  </div>

  <div class="section">
    <h2>评分系统</h2>
    <div id="scoreResult" class="score"></div>
  </div>

  <div class="section">
    <h2>运势分析（出生后60年）</h2>
    <button onclick="generateLuck()">生成运势</button>
    <ul id="luckResult"></ul>
  </div>

  <script>
    // 五行对应表
    const wuxingMap = {
      "甲":"木","乙":"木",
      "丙":"火","丁":"火",
      "戊":"土","己":"土",
      "庚":"金","辛":"金",
      "壬":"水","癸":"水"
    };

    // 检测引擎
    function checkEngine() {
      const statusDiv = document.getElementById('engineStatus');
      if (window.Solar && window.Lunar) {
        statusDiv.textContent = '排盘引擎：lunar-javascript（已就绪）';
        statusDiv.className = 'ok';
      } else {
        statusDiv.textContent = '排盘引擎：lunar-javascript（加载失败）';
        statusDiv.className = 'fail';
      }
    }
    checkEngine();

    // 内建测试
    function runTest() {
      if (window.Solar && window.Lunar) {
        const solar = Solar.fromYmdHms(1990, 1, 1, 12, 0, 0);
        const lunar = solar.getLunar();
        alert("测试成功：1990-01-01 八字 -> " +
          lunar.getYearInGanZhi() + "年 " +
          lunar.getMonthInGanZhi() + "月 " +
          lunar.getDayInGanZhi() + "日 " +
          lunar.getTimeInGanZhi() + "时");
      } else {
        alert("引擎加载失败，无法运行测试。");
      }
    }

    // 八字生成
    function generateBazi() {
      const y = parseInt(document.getElementById('year').value);
      const m = parseInt(document.getElementById('month').value);
      const d = parseInt(document.getElementById('day').value);
      const h = parseInt(document.getElementById('hour').value);
      const solar = Solar.fromYmdHms(y, m, d, h, 0, 0);
      const lunar = solar.getLunar();

      const bazi = {
        year: lunar.getYearInGanZhi(),
        month: lunar.getMonthInGanZhi(),
        day: lunar.getDayInGanZhi(),
        hour: lunar.getTimeInGanZhi()
      };

      document.getElementById('baziResult').innerHTML = `
        <p>公历: ${y}-${m}-${d} ${h}:00</p>
        <p>农历: ${lunar.toFullString()}</p>
        <p>八字: ${bazi.year}年 ${bazi.month}月 ${bazi.day}日 ${bazi.hour}时</p>
      `;

      analyzeMingGe(bazi);
    }

    // 命格分析 & 喜用神
    function analyzeMingGe(bazi) {
      const stems = [bazi.year[0], bazi.month[0], bazi.day[0], bazi.hour[0]];
      const wuxingCount = {木:0,火:0,土:0,金:0,水:0};

      stems.forEach(stem => {
        if (wuxingMap[stem]) wuxingCount[wuxingMap[stem]]++;
      });

      const dayMaster = wuxingMap[bazi.day[0]]; // 日主五行
      let strongWeak = "中和";
      if (wuxingCount[dayMaster] >= 3) strongWeak = "偏强";
      if (wuxingCount[dayMaster] === 0) strongWeak = "偏弱";

      // 推荐喜用神（简单规则：日主强 → 喜泄耗制；日主弱 → 喜扶抑助）
      let yongshen = "";
      if (strongWeak === "偏强") {
        if (dayMaster === "木") yongshen = "金/火";
        if (dayMaster === "火") yongshen = "水/土";
        if (dayMaster === "土") yongshen = "木/水";
        if (dayMaster === "金") yongshen = "火/木";
        if (dayMaster === "水") yongshen = "土/火";
      } else if (strongWeak === "偏弱") {
        if (dayMaster === "木") yongshen = "水/木";
        if (dayMaster === "火") yongshen = "木/火";
        if (dayMaster === "土") yongshen = "火/土";
        if (dayMaster === "金") yongshen = "土/金";
        if (dayMaster === "水") yongshen = "金/水";
      } else {
        yongshen = "平衡五行，灵活取用";
      }

      document.getElementById('minggeResult').innerHTML = `
        <p>日主五行: <b>${dayMaster}</b></p>
        <p>五行分布: 木${wuxingCount.木} 火${wuxingCount.火} 土${wuxingCount.土} 金${wuxingCount.金} 水${wuxingCount.水}</p>
        <p>命局强弱: ${strongWeak}</p>
        <p>推荐喜用神: ${yongshen}</p>
      `;

      scoreSystem(wuxingCount, strongWeak);
    }

    // 评分系统
    function scoreSystem(wuxingCount, strongWeak) {
      let score = 60;

      // 五行均衡度（理想是 2±1）
      const values = Object.values(wuxingCount);
      const deviation = values.map(v => Math.abs(v - 2)).reduce((a,b)=>a+b,0);
      score += Math.max(0, 20 - deviation*3);

      // 强弱修正
      if (strongWeak === "偏强" || strongWeak === "偏弱") score -= 10;

      if (score > 100) score = 100;
      if (score < 0) score = 0;

      document.getElementById('scoreResult').textContent = "命局评分: " + score + " / 100";
    }

    // 运势生成
    function generateLuck() {
      const y = parseInt(document.getElementById('year').value);
      const m = parseInt(document.getElementById('month').value);
      const d = parseInt(document.getElementById('day').value);
      const h = parseInt(document.getElementById('hour').value);
      const solar = Solar.fromYmdHms(y, m, d, h, 0, 0);
      const startYear = solar.getYear();
      const luckList = document.getElementById('luckResult');
      luckList.innerHTML = '';

      for (let i = 0; i < 60; i++) {
        const year = startYear + i;
        const s = Solar.fromYmd(year, m, d);
        const l = s.getLunar();
        const gz = l.getYearInGanZhi();

        let tip = '';
        if (gz.includes('财')) tip = '财运增强';
        else if (gz.includes('官')) tip = '事业关键年';
        else if (gz.includes('印')) tip = '学习提升';
        else if (gz.includes('比')) tip = '需防竞争';
        else tip = '平稳发展';

        const li = document.createElement('li');
        li.textContent = `${year}年 (${gz}) - ${tip}`;
        luckList.appendChild(li);
      }
    }
  </script>
</body>
</html>
