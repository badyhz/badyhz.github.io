<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard · 分圈雷达(0–50/50–100/100–150) + 原条形图（结构→徽章→生态）</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
<style>
:root{--bg:#0b1020;--card:#121833;--ink:#e7ecff;--muted:#98a1c0;--line:#1c2447;--good:#4ade80;--warn:#f59f0b;--bad:#ff5c9a;--hl:#2a3b7a}
*{box-sizing:border-box}html,body{margin:0;background:linear-gradient(180deg,#0b1020,#0e1430);color:var(--ink);font-family:'Noto Sans SC',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1280px;margin:22px auto 80px;padding:14px}
.h1{font-size:26px;font-weight:700;margin:6px 0 12px}
.grid-main{display:grid;grid-template-columns:2fr 1fr;gap:16px}
.card{background:linear-gradient(180deg,#121833,#0f1733);border:1px solid var(--line);border-radius:14px;padding:14px}
.card h3{margin:0 0 8px;font-size:15px}
.canvas-wrap{position:relative;height:560px}
.note{font-size:12px;color:#9fb1ff;margin-top:6px}
.legend-tip{font-size:12px;color:#c8d3ff;margin-left:6px}
.btn{padding:8px 14px;border-radius:8px;background:#6c8cff;color:#fff;margin-right:6px;text-decoration:none;border:1px solid #7a95ff;cursor:pointer}
.tab{display:inline-block;padding:6px 10px;border:1px solid #2a3b7a;border-radius:10px;margin-right:6px;cursor:pointer}.tab.active{background:#1a244f;border-color:#5a76dd}
.q{padding:10px;border:1px dashed #2a3b7a;border-radius:12px;background:#0c1433;margin:8px 0;scroll-margin-top:70px}
.q.highlight{outline:2px solid #6c8cff;box-shadow:0 0 0 4px rgba(108,140,255,.25) inset}
.bar{position:relative;height:12px;width:100%;background:#0b1230;border:1px solid #2a3b7a;border-radius:999px;overflow:hidden;margin:6px 0 4px 0}
.bar>i{display:block;height:100%;background:linear-gradient(90deg,#6c8cff,#9aaeff)}
.bar.alt1>i{background:linear-gradient(90deg,#34d399,#10b981)}
.value{font-size:12px;color:#b9c4ff;display:block;text-align:right;margin-bottom:4px}
.badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid #2a3b7a;font-size:11px;margin:2px 4px 2px 0;cursor:pointer;user-select:none}
.badge .dot{width:6px;height:6px;border-radius:50%}
.badge.good{border-color:rgba(74,222,128,.5);color:#c8ffe0}.badge.good .dot{background:#10b981}
.badge.warn{border-color:rgba(245,158,11,.55);color:#ffe7b8}.badge.warn .dot{background:#f59e0b}
.badge.bad{border-color:rgba(255,92,154,.55);color:#ffc9dc}.badge.bad .dot{background:#ff5c9a}
.badge.tag{border-color:#3a4a8f;color:#cfe0ff;background:rgba(90,118,221,.12);cursor:default}
.tips{margin-top:6px;padding-left:14px}
.tips li{font-size:12px;color:#d3dcff;line-height:1.5}
.tips.collapsed li.extra{display:none}
.tip-toggle{margin-top:6px;font-size:12px;color:#a8b7ff;cursor:pointer;user-select:none}
.disclaimer{font-size:12px;color:#a5b3ff;margin-bottom:8px}
.smallnote{font-size:12px;color:#b7c4ff}
@media (max-width:1100px){
  .grid-main{grid-template-columns:1fr}
  .canvas-wrap{height:520px}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="h1">分圈雷达（结构0–50｜生态50–100｜潜力100–150） + 原条形图</div>
  <div class="grid-main">
    <!-- 左：一张雷达图、5 曲线（两结构/生态/两潜力） -->
    <div>
      <div class="card">
        <div class="canvas-wrap"><canvas id="radarOne"></canvas></div>
        <div class="note">
          半径分区：<b>0–50</b>（结构），<b>50–100</b>（生态），<b>100–150</b>（潜力）。Tooltip 显示原始 0–100 分的整数与维度名称。
          <span class="legend-tip">可点图例开关各曲线。</span>
        </div>
        <div style="margin-top:8px">
          <a class="btn" href="step1.html">Step1</a>
          <a class="btn" href="step2.html">Step2</a>
          <a class="btn" href="step3.html">Step3</a>
          <a class="btn" href="report.html">Report</a>
        </div>
      </div>
    </div>

    <!-- 右：原条形图面板（结构8/生态16/潜力8） + 熵增提示块 -->
    <div class="card">
      <div class="disclaimer">
        阈值口径：高≥70，中=50–65，低≤50。含“长期情绪低落/耗竭倾向”的表述仅为状态提醒，非医学诊断。<br/>
        环境口径：<b>环境+纠偏</b>（标签×0.65 + 纠偏×0.35），来源于 Step2 与 Step3 融合。
      </div>

      <!-- 熵增提示（展示，不参与计算更改） -->
      <div id="entropyBox" class="q" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <b>熵增（噪声）</b>
          <span id="entropyBadge" class="badge tag"><i class="dot"></i><span>—</span></span>
        </div>
        <div class="smallnote">说明：由生态上下文估算，仅用于提示“环境复杂度/系统噪声”。</div>
        <ul id="entropyTips" class="tips"></ul>
      </div>

      <div style="margin-bottom:8px">
        <span class="tab active" id="tab-struct">结构 8（徽章+规则）</span>
        <span class="tab" id="tab-eco">生态 16（由徽章推导）</span>
        <span class="tab" id="tab-pot">潜力 8</span>
      </div>
      <div id="panel-struct"><div id="structBadges"></div><div id="structList"></div></div>
      <div id="panel-eco" style="display:none"><div id="ecoBadges"></div><div id="ecoList"></div></div>
      <div id="panel-pot" style="display:none"><div id="potBadges"></div><div id="potList"></div></div>
    </div>
  </div>
</div>

<script>
/* ========= 基础标签 ========= */
const ECO16 = [
  "信任速度","协作质量","关系韧性","影响半径","目标推进力","节奏管理",
  "应变效率","落地闭环度","洞察敏锐度","表达条理度","信息整合度","改进驱动力",
  "能量外放","冲突风格","环境贴合度","幸福感基础"
];
const ECO_INDEX = {}; ECO16.forEach((n,i)=>ECO_INDEX[n]=i);
const STRUCT8_FULL = ["镜面（觉察）","筋骨（闭环力）","水流（灵活）","火焰（能量）","指南针（方向）","盾牌（情绪稳定）","桥梁（连接）","岩石（毅力）"];
const STRUCT8 = STRUCT8_FULL.map(s=>s.split('（')[0]);
const POT8 = ["创新潜力","领导潜力","艺术潜力","学习潜力","社交潜力","创业潜力","科研潜力","幸福潜力"];

/* ========= 生态领域路由 + 新增徽章文案（不改计算，仅展示） ========= */
const ECO_META = {
  "信任速度":{
    alias:"信任启动度",
    domains:["事业","家庭","生活"],
    why:"信任是协作入口，决定推进摩擦",
    high:[
      "快速破冰：用“小承诺—小兑现”建立信任循环",
      "保持真诚而非表演，信任可持续",
      "把握窗口期，先给对方可验证的信息"
    ],
    mid:[
      "信任需要时间：从小圈子先建立口碑",
      "增加透明度与回应速度，减少他人不确定",
      "用‘预期-进展-结果’三段式沟通"
    ],
    low:[
      "主动自我揭示，降低他人猜疑门槛",
      "先做一次可见的小帮助，触发信任启动",
      "避免失联，哪怕简短回应也比沉默好"
    ]
  },
  "协作质量":{
    alias:"协作互惠",
    domains:["事业","家庭"],
    why:"分工与闭环决定交付确定性",
    high:[
      "你的信誉就是资产：多做进展可视化",
      "提前暴露风险，团队会更信任你",
      "给到‘可执行’的下一步，而非信息堆积"
    ],
    mid:[
      "闭环不足：设置固定回报点（周报/站会）",
      "明确边界与责任，降低扯皮概率",
      "遇到依赖关系，先锁定接口人和时点"
    ],
    low:[
      "从一个小任务做到可预期，修复团队印象",
      "不要口头承诺大事，先小步交付建立节奏",
      "用清单化+时限化替代笼统表述"
    ]
  },
  "关系韧性":{
    alias:"修复弹性",
    domains:["家庭","伴侣","事业"],
    why:"冲突后的恢复速度决定长期稳定",
    high:[
      "冲突后能快速修复：主动复盘，而非翻旧账",
      "有界限的体谅，能让关系更稳",
      "把‘修复’当能力训练，而非偶发行为"
    ],
    mid:[
      "情绪恢复在中段：学会说“没事了，我们继续”",
      "限定冷处理时长，别无限期拖延",
      "用‘事实-感受-请求’三步法降低指责感"
    ],
    low:[
      "避免长期冷战：先修复再求对错",
      "用‘小道歉+小补偿’快速降级",
      "需要时请第三方做“关系调解人”"
    ]
  },
  "影响半径":{
    alias:"外溢影响力",
    domains:["事业","其他"],
    why:"机会获取与资源动员的放大器",
    high:[
      "别只扩散也要沉淀：把观点做成素材库",
      "为他人做‘可转用素材’，影响会更深",
      "适度稀缺，避免信息疲劳"
    ],
    mid:[
      "聚焦小圈层，逐步放大外溢面",
      "选择自己的“主场”渠道，坚持输出",
      "用数据/案例增强说服力"
    ],
    low:[
      "先在安全场练习表达，再逐步公开",
      "小范围试点你的想法，收集正反馈",
      "建立3个固定触达点（同事/群/平台）"
    ]
  },
  "目标推进力":{
    alias:"推进引擎",
    domains:["事业","学习","家庭"],
    why:"方向—拆解—执行的主链路",
    high:[
      "注意别碾压队友：留出协商空间",
      "为他人准备‘上手入口’降低阻力",
      "设置“完成可见”以增强队伍成就感"
    ],
    mid:[
      "容易中断：把目标切成 1–2 小步",
      "为自己设定每日最低动作量",
      "用番茄钟/看板拉回节奏"
    ],
    low:[
      "从‘最小下一步’开始，先点燃动能",
      "给自己一份小奖励形成正循环",
      "找一个监督搭子，降低惰性"
    ]
  },
  "节奏管理":{
    alias:"节律与能量",
    domains:["生活","事业","家庭"],
    why:"可持续产出与情绪稳定的地基",
    high:[
      "守住睡眠与运动，两项就是护城河",
      "根据生理高峰布置关键任务",
      "在周期低谷安排低强度事项"
    ],
    mid:[
      "用小仪式感把节奏拉回来（早/晚例行）",
      "建立‘停-看-调’的每周校准",
      "减少多线程，给大块时间做深度工作"
    ],
    low:[
      "先修复睡眠，再谈效率",
      "不要透支，留一点‘余白’给恢复",
      "每天固定 15 分钟保底规律"
    ]
  },
  "应变效率":{
    alias:"变中取稳",
    domains:["事业","生活","其他"],
    why:"低熵系统核心能力",
    high:[
      "敏捷试错要配合留痕，避免返工",
      "设定‘回滚点’，敢改也能稳",
      "复盘一次成功的快速调整经验"
    ],
    mid:[
      "常慢半拍：做情景预演与清单化响应",
      "建立 72 小时内的短周期复评",
      "别纠结完美，先把关键路径打通"
    ],
    low:[
      "从一次小调整开始训练适应肌肉",
      "与高应变伙伴结对，借他人节奏带动",
      "把‘不确定’拆成明细问题逐个击破"
    ]
  },
  "落地闭环度":{
    alias:"执行闭环",
    domains:["事业","家庭"],
    why:"‘最后一公里’决定价值兑现",
    high:[
      "你是完成型选手：别忘了展示成果",
      "为他人留下一键复用的操作痕迹",
      "把经验沉淀到 SOP/模板"
    ],
    mid:[
      "设置提醒与检查点，防止半途丢件",
      "任务分三段交付：版本-验收-上线",
      "明确 Done 的定义，避免标准漂移"
    ],
    low:[
      "先做‘小闭环’任务，体验完成感",
      "减少在制品（WIP），聚焦一件事完成",
      "给收尾动作设硬性时限"
    ]
  },
  "洞察敏锐度":{
    alias:"前瞻与识别",
    domains:["事业","孩子","生活"],
    why:"变量提纯，减少错误探索",
    high:[
      "分享不只讲结论，也讲推理过程",
      "用对比样本验证你的直觉",
      "记录异动信号，形成早预警机制"
    ],
    mid:[
      "多问一句‘还有别的解释吗’",
      "与不同背景的人讨论获得校准",
      "建立自己的信号清单（领先指标）"
    ],
    low:[
      "通过‘影随访谈’借别人的眼睛看世界",
      "做小样本试探，积累感知经验",
      "定期回顾成功/失误的前兆线索"
    ]
  },
  "表达条理度":{
    alias:"结构化表达",
    domains:["事业","孩子","家庭"],
    why:"让他人能执行，而非只‘听懂’",
    high:[
      "控制信息密度：先结论再三点支撑",
      "面向执行者说‘动作与时点’",
      "准备 FAQ，减少反复解释"
    ],
    mid:[
      "提前列3句提纲，现场按提纲讲",
      "用图表替代口头堆叠",
      "复述对方需求，确保同频"
    ],
    low:[
      "先说重点，再补背景与细节",
      "限制每段话 30 秒内说清动作",
      "用例子对齐抽象表述"
    ]
  },
  "信息整合度":{
    alias:"整合与对齐",
    domains:["事业","其他"],
    why:"跨源对齐减少试错成本",
    high:[
      "你是知识枢纽：定期整理为共享资产",
      "标注来源与时效，避免过期引用",
      "把冲突信息并列展示，帮助判断"
    ],
    mid:[
      "用思维导图搭框架，补全缺口",
      "区分‘原始事实/解释/猜测’",
      "建立资料索引，降低检索成本"
    ],
    low:[
      "练习‘一句话总结’再展开",
      "为每个信息标一个‘目的’标签",
      "做一页摘要而不是十页摘录"
    ]
  },
  "改进驱动力":{
    alias:"持续微优化",
    domains:["事业","生活"],
    why:"复利来自持续微改进",
    high:[
      "维持小步快跑，避免大改带来波动",
      "把改进‘产品化’，让他人也能复用",
      "每周保留 1 小时做改进回顾"
    ],
    mid:[
      "建立‘留痕’机制，防半途而废",
      "按 1% 原则：每天只改进一点点",
      "优先优化瓶颈节点，收益更高"
    ],
    low:[
      "从一项重复动作开始做小优化",
      "把痛点写下来，排个先后次序",
      "拉同伴一起做改进打卡"
    ]
  },
  "能量外放":{
    alias:"能量外显度",
    domains:["事业","其他"],
    why:"现场动员与号召的放大器",
    high:[
      "收放自如，避免自我消耗过快",
      "给团队留出发光空间，形成共振",
      "把能量化成“具体行动口号”"
    ],
    mid:[
      "找到你的触发场景（人/地/事）",
      "用音乐/场景切换快速充电",
      "把输出安排在状态峰值时段"
    ],
    low:[
      "先充电再带动别人：睡眠/运动/营养",
      "不硬撑：把任务拆给更有能量的人",
      "从小场景表达，逐步热身"
    ]
  },
  "冲突风格":{
    alias:"调和与边界",
    domains:["家庭","事业","孩子"],
    why:"降级速度决定关系成本",
    high:[
      "亮明立场也要注意方式与场合",
      "用‘我感受’替代‘你问题’",
      "结尾给出可行下一步而不是胜负"
    ],
    mid:[
      "温和但易被忽视：学会清晰边界",
      "提前设‘不可触碰’清单供团队知晓",
      "把分歧拉到白纸上讨论而非人身化"
    ],
    low:[
      "练习小规模表达，别长期回避",
      "遇到强冲突先求降级而非定输赢",
      "需要时请第三方主持讨论"
    ]
  },
  "环境贴合度":{
    alias:"匹配与选择",
    domains:["事业","生活"],
    why:"匹配度直接影响产出/幸福",
    high:[
      "继续深耕，复利会更明显",
      "争取更多‘在位优势’的场景",
      "把不匹配的工作做外包/移交"
    ],
    mid:[
      "先微调自己的工作方式再考虑换环境",
      "和上级对齐期待，减少错位",
      "寻找可匹配的子领域切入"
    ],
    low:[
      "长期消耗需警惕：考虑换土壤",
      "在可控范围内先调岗/调项目",
      "避免把消耗当常态，保留试错空间"
    ]
  },
  "幸福感基础":{
    alias:"幸福基线",
    domains:["生活","家庭","孩子","事业"],
    why:"地板分决定上限",
    high:[
      "让幸福反哺效率：安排高质量陪伴",
      "表达感恩能提升氛围与韧性",
      "用‘周末复原计划’稳固基线"
    ],
    mid:[
      "波动较大：记录每日三件小确幸",
      "减少无效内耗（比拼/比较/刷屏）",
      "建立心理的‘安全角落’仪式"
    ],
    low:[
      "优先修复睡眠与关系，别忽视身心信号",
      "必要时寻求专业支持",
      "从‘可控的一小时’开始重建秩序"
    ]
  }
};

/* ========= 锚位（结构/潜力8 映射到 16 坐标） ========= */
const STRUCT_ANCHORS = [8,7,6,12,4,15,1,0];
const POT_ANCHORS    = STRUCT_ANCHORS.slice();

/* ========= 读取 step1/2/3 + 融合（环境+纠偏） ========= */
function readArr(key, n=null){ try{ const v=JSON.parse(localStorage.getItem(key)||'null'); if(Array.isArray(v)&&(n==null||v.length===n)) return v; }catch(e){} return null; }
function sample(n,seed){ let x=seed, arr=[]; for(let i=0;i<n;i++){ x=(x*9301+49297)%233280; arr.push(Math.round((x/233280)*100)); } return arr; }
function clamp01(x){ return Math.max(0,Math.min(100,Number(x)||0)); }
const alpha = 0.65; // 环境(标签) : 纠偏(80题) = 65 : 35

// 结构
const s_self = readArr('step1_struct',8) || sample(8,11);
const s2_raw = readArr('step2_struct_raw',8) || null;
const s3_fix = readArr('step3_struct',8) || null;
const s_tag = s2_raw ? s2_raw.map(v=>clamp01(v)) : null;
const s_env = (s_tag||s3_fix) ? (STRUCT8.map((_,i)=> {
  const a=s_tag? s_tag[i]:null, b=s3_fix? s3_fix[i]:null;
  if(a!=null && b!=null) return Math.round(alpha*a + (1-alpha)*b);
  return Math.round(a!=null? a : (b!=null? b : s_self[i]));
})) : s_self.slice();

// 潜力
const pot_self = readArr('pot_self',8) || sample(8,201);
const pot2_raw = readArr('pot2_raw',8) || null;
const pot3_fix = readArr('pot3_fix',8) || null;
const pot_env_base = readArr('pot_env',8);
const pot_env = (pot2_raw||pot3_fix) ? POT8.map((_,i)=>{
  const a = pot2_raw? clamp01(pot2_raw[i]):null, b=pot3_fix? clamp01(pot3_fix[i]):null;
  if(a!=null && b!=null) return Math.round(alpha*a + (1-alpha)*b);
  return Math.round(a!=null? a : (b!=null? b : (pot_env_base? pot_env_base[i]:50)));
}) : (pot_env_base || sample(8,333));

/* ========= 生态推导：结构→徽章→生态（保留你的原逻辑） ========= */
function ecology16ApproxFromStruct(S){
  const v=i=>S[i]||50;
  return [
    (v(7)+v(6))/2, (v(6)+v(3)+v(4))/3, (v(5)+v(7))/2, (v(5)+v(6)+v(3))/3,
    (v(3)+v(4)+v(1))/3, (v(1)+v(7)+v(4))/3, (v(2)+v(6))/2, (v(1)+v(3))/2,
    (v(0)+v(2))/2, (v(2)+v(3))/2, (v(0)+v(1)+v(2))/3, (v(2)+v(6))/2,
    (v(3)+v(5))/2, (v(5)+v(1)+v(2))/3, (v(6)+v(7)+v(1))/3, (v(4)+v(1)+v(0))/3
  ].map(x=>Math.round(clamp01(x)));
}
function entropyFromE16(E16){
  const tmp = (E16 && E16.length===16) ? E16 : ecology16ApproxFromStruct(s_env);
  const L = tmp[7]||50, J = tmp[5]||50, F = tmp[14]||50;
  return Math.max(0, Math.min(100, Math.round(100 - (0.5*L + 0.3*J + 0.2*F))));
}
const ECO16_TO_AXIS = {"信任速度":7,"协作质量":6,"关系韧性":5,"影响半径":6,"目标推进力":3,"节奏管理":1,"应变效率":2,"落地闭环度":1,"洞察敏锐度":0,"表达条理度":2,"信息整合度":0,"改进驱动力":2,"能量外放":3,"冲突风格":5,"环境贴合度":6,"幸福感基础":4};
const RULE2ECO = {
  "强号召": {"能量外放":+10,"协作质量":+6,"影响半径":+6},
  "高能失控": {"冲突风格":+10,"协作质量":-8},
  "极化领导": {"协作质量":-10,"关系韧性":-6},
  "高能但能软着陆": {"协作质量":+6,"关系韧性":+6},
  "号召+凝聚": {"能量外放":+10,"关系韧性":+8,"协作质量":+6},
  "冷硬推进": {"协作质量":-8,"关系韧性":-8,"冲突风格":+8},
  "强势但可控": {"能量外放":+6,"冲突风格":+4},
  "敏捷有边": {"应变效率":+10,"落地闭环度":+4},
  "快变但返工风险": {"应变效率":+6,"落地闭环度":-8},
  "刚性维稳": {"应变效率":-8,"落地闭环度":+4,"节奏管理":+4},
  "稳定高效": {"落地闭环度":+10,"节奏管理":+6},
  "稳中求进": {"节奏管理":+6,"落地闭环度":+4},
  "改动可承受": {"关系韧性":+6,"应变效率":+4},
  "清晰拍板": {"目标推进力":+10,"信息整合度":+6},
  "分析多但锚定弱": {"目标推进力":-8,"节奏管理":-4},
  "清晰但起伏大": {"目标推进力":+4,"幸福感基础":-6},
  "看得清但目标摇摆": {"目标推进力":-8},
  "清晰定向": {"目标推进力":+10,"环境贴合度":+6},
  "坚定且可协同": {"协作质量":+8,"目标推进力":+6},
  "善意协调但边界弹性增": {"协作质量":+6,"环境贴合度":+4},
  "坚定但强硬": {"协作质量":-8,"冲突风格":+6},
  "创变执行": {"改进驱动力":+10,"应变效率":+8},
  "创意多但落地难": {"改进驱动力":+4,"落地闭环度":-10},
  "弹性改进": {"改进驱动力":+8,"应变效率":+6},
  "思路在、势能不足": {"能量外放":-8,"目标推进力":-4},
  "高连续性": {"节奏管理":+10,"落地闭环度":+8},
  "连续性略降但韧性提升": {"关系韧性":+6,"应变效率":+4},
  "规则在但情绪打断": {"节奏管理":-8,"关系韧性":-6},
  "稳定可靠": {"节奏管理":+8,"落地闭环度":+6},
  "一致对外": {"协作质量":+8,"关系韧性":+8},
  "坚定有边界但协作摩擦": {"协作质量":-8,"冲突风格":+6},
  "高冷静": {"冲突风格":-8,"幸福感基础":+6},
  "冷静转强势推进": {"目标推进力":+6,"冲突风格":+6},
  "冷静变“压抑”感": {"幸福感基础":-8,"节奏管理":-4}
};
function ecology16FromBadges(S8,E16_context){
  let base = ecology16ApproxFromStruct(S8);
  STRUCT8.forEach((ax,axIdx)=>{
    const v=S8[axIdx]||50;
    const mod = v>=70?+8:(v<=50?-8:0);
    ECO16.forEach((ecoName, ecoIdx)=>{
      if(ECO16_TO_AXIS[ecoName]===axIdx){ base[ecoIdx] = clamp01(base[ecoIdx] + mod); }
    });
  });
  const rulesPerAxis = comboRulesByAxis(S8, E16_context);
  const allTexts = new Set(); rulesPerAxis.forEach(arr=>arr.forEach(t=>allTexts.add(t)));
  allTexts.forEach(text=>{
    const m = RULE2ECO[text]; if(!m) return;
    Object.keys(m).forEach(ecoName=>{
      const idx = ECO_INDEX[ecoName]; if(idx!=null){ base[idx] = clamp01(base[idx] + m[ecoName]); }
    });
  });
  const H = entropyFromE16(E16_context);
  const penalty = Math.round((H-50)/5);
  ["节奏管理","落地闭环度","协作质量","应变效率","信息整合度","目标推进力"].forEach(name=>{
    const i = ECO_INDEX[name]; base[i] = clamp01(base[i] - penalty);
  });
  base[ECO_INDEX["冲突风格"]] = clamp01(base[ECO_INDEX["冲突风格"]] + penalty);
  return base.map(x=>Math.round(x));
}

/* ========= 组合规则（原样） + 结构徽章文案（原样） ========= */
function comboRulesByAxis(S8,E16){
  const [镜面,筋骨,水流,火焰,指南针,盾牌,桥梁,岩石] = S8;
  const 熵增 = (()=>{
    const tmp = ecology16ApproxFromStruct(S8);
    const L = tmp[7]||50, J = tmp[5]||50, F = tmp[14]||50;
    return Math.max(0, Math.min(100, Math.round(100 - (0.5*L + 0.3*J + 0.2*F))));
  })();
  const out = Array(8).fill(0).map(()=>[]);
  const push=(axes,text)=>{axes.forEach(i=>{if(!out[i].includes(text)) out[i].push(text);});};
  const GE=(v,t)=>v>=t, LE=(v,t)=>v<=t, BT=(v,a,b)=>v>=a&&v<=b;

  if(GE(岩石,70)&&GE(熵增,70)&&LE(水流,50)) push([7,2], "硬扛但恢复慢");
  if(GE(岩石,70)&&GE(熵增,70)&&BT(水流,50,65)) push([7,2], "硬扛并能转圜，恢复一般（高熵下能量消耗大）");
  if(GE(岩石,70)&&GE(熵增,70)&&GE(水流,66)) push([7,2], "硬扛且具韧性，恢复较快，但长期有耗竭/低落倾向");
  if(GE(岩石,70)&&LE(熵增,40)&&LE(水流,50)) push([7,2], "持久稳推");
  if(GE(岩石,70)&&LE(熵增,40)&&GE(水流,66)) push([7,2], "持久且敏捷");
  if(GE(岩石,70)&&GE(水流,66)&&LE(熵增,50)) push([7,2], "遇变不崩");
  if(GE(岩石,70)&&GE(水流,66)&&GE(熵增,70)) push([7,2], "顶得住但返工变多");

  if(GE(火焰,72)&&LE(盾牌,50)&&LE(桥梁,50)) push([3,5,6], "反应性攻击");
  if(GE(火焰,72)&&GE(盾牌,60)&&GE(桥梁,65)) push([3,5,6], "强号召");
  if(GE(火焰,72)&&GE(盾牌,60)&&LE(桥梁,50)) push([3,6], "极化领导");
  if(GE(火焰,72)&&LE(盾牌,50)&&GE(桥梁,65)) push([3,5,6], "高能但能软着陆");
  if(GE(火焰,72)&&LE(盾牌,50)) push([3,5], "高能失控");
  if(GE(火焰,72)&&GE(盾牌,60)) push([3,5], "高能但不失控");

  if(GE(筋骨,70)&&GE(水流,66)&&LE(熵增,50)) push([1,2], "敏捷有边");
  if(GE(筋骨,70)&&GE(水流,66)&&GE(熵增,70)) push([1,2], "快变但返工风险");
  if(GE(筋骨,70)&&LE(水流,50)&&GE(熵增,70)) push([1,2], "刚性维稳");
  if(GE(筋骨,70)&&LE(水流,50)&&LE(熵增,50)) push([1,2], "稳定高效");
  if(GE(筋骨,70)&&BT(水流,50,65)) push([1,2], "稳中求进");
  if(GE(筋骨,70)&&GE(水流,66)&&LE(熵增,50)) push([1,2], "改动可承受");

  if(GE(镜面,72)&&GE(指南针,65)&&GE(盾牌,60)) push([0,4,5], "清晰拍板");
  if(GE(镜面,72)&&LE(指南针,55)&&GE(盾牌,60)) push([0,4], "分析多但锚定弱");
  if(GE(镜面,72)&&GE(指南针,65)&&LE(盾牌,55)) push([0,5], "清晰但起伏大");
  if(GE(镜面,72)&&LE(指南针,55)) push([0,4], "看得清但目标摇摆");
  if(GE(镜面,72)&&GE(指南针,65)) push([0,4], "清晰定向");

  if(GE(指南针,70)&&GE(桥梁,70)&&LE(水流,50)) push([4,6,2], "坚定且可协同");
  if(GE(指南针,70)&&GE(桥梁,70)&&GE(水流,66)) push([4,6,2], "善意协调但边界弹性增");
  if(GE(指南针,70)&&LE(桥梁,50)&&LE(水流,50)) push([4,6,2], "坚定但强硬");
  if(GE(指南针,70)&&GE(桥梁,70)) push([4,6], "坚定且易协同");

  if(GE(水流,70)&&GE(火焰,66)&&GE(筋骨,70)) push([2,3,1], "创变执行");
  if(GE(水流,70)&&LE(筋骨,55)) push([2,1], "创意多但落地难");
  if(GE(水流,70)&&BT(筋骨,50,65)&&BT(火焰,50,65)) push([2,1,3], "弹性改进");
  if(GE(水流,70)&&LE(火焰,55)) push([2,3], "思路在、势能不足");
  if(BT(筋骨,50,65)&&BT(火焰,50,65)&&LE(水流,50)) push([1,3,2], "稳中求进");

  if(GE(筋骨,70)&&GE(盾牌,70)&&LE(水流,50)) push([1,5,2], "高连续性");
  if(GE(筋骨,70)&&GE(盾牌,70)&&GE(水流,66)) push([1,5,2], "连续性略降但韧性提升");
  if(GE(筋骨,70)&&LE(盾牌,55)&&LE(水流,50)) push([1,5,2], "规则在但情绪打断");
  if(GE(筋骨,70)&&GE(盾牌,70)) push([1,5], "稳定可靠");

  if(GE(桥梁,70)&&LE(熵增,50)&&GE(火焰,66)) push([6,3], "号召+凝聚");
  if(GE(桥梁,70)&&GE(熵增,70)&&GE(火焰,66)) push([6,3], "动员强但协调成本飙升");
  if(LE(桥梁,50)&&GE(熵增,70)&&GE(火焰,66)) push([6,3], "冷硬推进");
  if(LE(桥梁,50)&&LE(熵增,50)&&GE(火焰,66)) push([6,3], "强势但可控");

  if(GE(指南针,70)&&GE(岩石,70)&&LE(桥梁,50)) push([4,7,6], "坚定有边界但协作摩擦");
  if(GE(指南针,70)&&GE(岩石,70)&&GE(桥梁,70)) push([4,7,6], "一致对外");
  if(GE(指南针,70)&&LE(岩石,55)) push([4,7], "原则仍在但执行弹性增");

  if(GE(盾牌,75)&&LE(火焰,55)&&LE(熵增,50)) push([5,3], "高冷静");
  if(GE(盾牌,75)&&GE(火焰,72)) push([5,3], "冷静转强势推进");
  if(GE(盾牌,75)&&GE(熵增,70)) push([5], "冷静变“压抑”感");
  return out;
}

/* ========= 结构徽章文案（原表） ========= */
const BAND_TEXT = {
  "岩石":{
    high:[
      "硬扛但恢复慢（熵增≥70 & 水流≤50）",
      "硬扛并能转圜，恢复一般（熵增≥70 & 水流=50–65）",
      "硬扛且具韧性，恢复较快，但长期有耗竭/低落倾向（熵增≥70 & 水流≥66）",
      "持久稳推（熵增≤40 & 水流≤50）",
      "持久且敏捷（熵增≤40 & 水流≥66）",
      "遇变不崩（水流≥66 & 熵增≤50）",
      "顶得住但返工变多（水流≥66 & 熵增≥70）",
      "坚定有边界但协作摩擦（与指南针≥70 & 桥梁≤50）",
      "一致对外（桥梁≥70）"
    ],
    mid:["抗压中性，易受噪声或协作环境影响，表现可上可下"],
    low:["原则仍在但执行弹性增（岩石≤55，指南针≥70 & 桥梁≤50）"]
  },
  "水流":{
    high:[
      "硬扛且具韧性，恢复较快，但长期有耗竭/低落倾向（岩石≥70 & 熵增≥70）",
      "持久且敏捷（岩石≥70 & 熵增≤40）",
      "遇变不崩（岩石≥70 & 熵增≤50）",
      "顶得住但返工变多（岩石≥70 & 熵增≥70）",
      "敏捷有边（筋骨≥70 & 熵增≤50）",
      "快变但返工风险（筋骨≥70 & 熵增≥70）",
      "创变执行（火焰≥66 & 筋骨≥70）",
      "善意协调但边界弹性增（指南针≥70 & 桥梁≥70）",
      "连续性略降但韧性提升（筋骨≥70 & 盾牌≥70）"
    ],
    mid:[
      "硬扛并能转圜，恢复一般（岩石≥70 & 熵增≥70）",
      "稳中求进（筋骨≥70 & 熵增≤50）"
    ],
    low:[
      "硬扛但恢复慢（岩石≥70 & 熵增≥70）",
      "持久稳推（岩石≥70 & 熵增≤40）",
      "刚性维稳（筋骨≥70 & 熵增≥70）",
      "改动可承受（筋骨≥70 & 熵增≤50）",
      "坚定且可协同（指南针≥70 & 桥梁≥70）",
      "坚定但强硬（指南针≥70 & 桥梁≤50）",
      "高连续性（筋骨≥70 & 盾牌≥70）",
      "规则在但情绪打断（筋骨≥70 & 盾牌≤55）"
    ]
  },
  "火焰":{
    high:[
      "反应性攻击（盾牌≤50 & 桥梁≤50）",
      "高能但不失控（盾牌≥60）",
      "高能但能软着陆（桥梁≥65）",
      "强号召（盾牌≥60 & 桥梁≥65）",
      "高能失控（盾牌≤50）",
      "极化领导（桥梁≤50）",
      "创变执行（水流≥70 & 筋骨≥70）",
      "号召+凝聚（桥梁≥70 & 熵增≤50）",
      "动员强但协调成本飙升（桥梁≥70 & 熵增≥70）",
      "冷静转强势推进（盾牌≥75 & 火焰≥72）"
    ],
    mid:[
      "弹性改进（水流≥70 & 筋骨=50–65）",
      "思路在、势能不足（水流≥70 & 火焰≤55）"
    ],
    low:[
      "冷硬推进（桥梁≤50 & 熵增≥70）",
      "强势但可控（桥梁≤50 & 熵增≤50）",
      "思路在、势能不足（当火焰低时普遍适用）"
    ]
  },
  "指南针":{
    high:[
      "清晰拍板（镜面≥72 & 盾牌≥60）",
      "清晰定向（镜面≥72 & 指南针≥65）",
      "坚定且可协同（桥梁≥70 & 水流≤50）",
      "善意协调但边界弹性增（桥梁≥70 & 水流≥66）",
      "坚定但强硬（桥梁≤50 & 水流≤50）",
      "坚定且易协同（桥梁≥70）",
      "坚定有边界但协作摩擦（岩石≥70 & 桥梁≤50）",
      "一致对外（岩石≥70 & 桥梁≥70）"
    ],
    mid:["指向模糊，表述依赖外部锚定"],
    low:["原则仍在但执行弹性增（岩石≤55）","看得清但目标摇摆（镜面≥72 & 指南针≤55）","分析多但锚定弱（镜面≥72 & 指南针≤55）","清晰但起伏大（镜面≥72 & 盾牌≤55）"]
  },
  "盾牌":{
    high:[
      "清晰拍板（与镜面/指南针）",
      "稳定可靠（筋骨≥70 & 水流≤50）",
      "高冷静（火焰≤55 & 熵增≤50）"
    ],
    mid:["稳定但波动（与筋骨/火焰组合）"],
    low:[
      "清晰但起伏大（镜面≥72）",
      "高能失控（火焰≥72）",
      "极化领导（火焰≥72 & 桥梁≤50）",
      "冷静变“压抑”感（熵增≥70）",
      "规则在但情绪打断（筋骨≥70 & 水流≤50）"
    ]
  },
  "桥梁":{
    high:[
      "高能但能软着陆（火焰≥72）",
      "强号召（火焰≥72 & 盾牌≥60）",
      "坚定且可协同（指南针≥70 & 水流≤50）",
      "善意协调但边界弹性增（指南针≥70 & 水流≥66）",
      "号召+凝聚（火焰≥66 & 熵增≤50）",
      "一致对外（岩石≥70 & 指南针≥70）"
    ],
    mid:["协作稳定性一般，表述因搭配不同而变化"],
    low:[
      "反应性攻击（火焰≥72 & 盾牌≤50）",
      "高能失控（火焰≥72 & 盾牌≤50）",
      "极化领导（火焰≥72 & 桥梁≤50）",
      "冷硬推进（火焰≥66 & 熵增≥70）",
      "坚定但强硬（指南针≥70 & 水流≤50）",
      "坚定有边界但协作摩擦（岩石≥70 & 指南针≥70）"
    ]
  },
  "镜面":{
    high:[
      "清晰拍板（指南针≥65 & 盾牌≥60）",
      "看得清但目标摇摆（指南针≤55）",
      "清晰但起伏大（盾牌≤55）",
      "分析多但锚定弱（指南针≤55）",
      "清晰定向（指南针≥65）"
    ],
    mid:["分析充分，但决策阻抗"],
    low:["觉察不足，缺乏锚定（需外部规则/目标口径）"]
  },
  "筋骨":{
    high:[
      "敏捷有边（水流≥66 & 熵增≤50）",
      "快变但返工风险（水流≥66 &熵增≥70）",
      "刚性维稳（水流≤50 & 熵增≥70）",
      "稳定高效（水流≤50 & 熵增≤50）",
      "改动可承受（水流≥66 &熵增≤50）",
      "创变执行（水流≥70 & 火焰≥66）",
      "高连续性（盾牌≥70 & 水流≤50）"
    ],
    mid:["稳中求进（水流=50–65）"],
    low:["创意多但落地难（水流≥70 & 火焰≥66）"]
  }
};

/* ========= 生态上下文 ========= */
let e2_raw = readArr('step2_eco16_raw',16) || null;
let e3_fix = readArr('step3_eco16',16) || null;
let e_env = (e2_raw||e3_fix) ? ECO16.map((_,i)=>{
  const a = e2_raw ? clamp01(e2_raw[i]) : null;
  const b = e3_fix ? clamp01(e3_fix[i]) : null;
  if(a!=null && b!=null) return Math.round(alpha*a + (1-alpha)*b);
  return Math.round(a!=null? a : (b!=null? b : 0));
}) : null;
const eco_from_badges = ecology16FromBadges(s_env, e_env);
if(!e_env) e_env = eco_from_badges.slice();

/* ========= 分圈雷达（原样，未改动） ========= */
const mapStruct = v => Math.round((v||0) * 0.5);
const mapEco    = v => Math.round(50 + (v||0) * 0.5);
const mapPot    = v => Math.round(100 + (v||0) * 0.5);
function makeSparse16(anchorIdx8, values8, mapper){
  const arr = new Array(16).fill(NaN);
  for(let i=0;i<anchorIdx8.length;i++){
    const idx = anchorIdx8[i];
    arr[idx] = mapper(values8[i]||0);
  }
  return arr;
}
const ds_struct_self = makeSparse16(STRUCT_ANCHORS, s_self, mapStruct);
const ds_struct_env  = makeSparse16(STRUCT_ANCHORS, s_env,  mapStruct);
const ds_pot_self    = makeSparse16(POT_ANCHORS,    pot_self, mapPot);
const ds_pot_env     = makeSparse16(POT_ANCHORS,    pot_env,  mapPot);
const ds_eco16       = eco_from_badges.map(mapEco);

const STRUCT_ANCHOR_INV = {}; STRUCT_ANCHORS.forEach((ecoIdx,k)=>STRUCT_ANCHOR_INV[ecoIdx]=k);
const POT_ANCHOR_INV    = {}; POT_ANCHORS.forEach((ecoIdx,k)=>POT_ANCHOR_INV[ecoIdx]=k);

Chart.defaults.color = "#cfd7ff";
Chart.defaults.borderColor = "rgba(255,255,255,.12)";
const ctx = document.getElementById('radarOne').getContext('2d');

new Chart(ctx,{
  type:'radar',
  data:{
    labels: ECO16.map((n,i)=>`${i+1}.${n}`),
    datasets:[
      {label:'结构（自评 · 8维）',     data: ds_struct_self, borderColor:'#6c8cff', pointBackgroundColor:'#6c8cff', fill:false, borderWidth:2, pointRadius:3, spanGaps:true},
      {label:'结构（环境+纠偏 · 8维）', data: ds_struct_env,  borderColor:'#94b0ff', pointBackgroundColor:'#94b0ff', fill:false, borderWidth:2, pointRadius:3, spanGaps:true},
      {label:'生态（由徽章推导 · 16维）', data: ds_eco16,      borderColor:'#34d399', pointBackgroundColor:'#34d399', fill:false, borderWidth:2, pointRadius:2.5},
      {label:'潜力（自评 · 8维）',     data: ds_pot_self,    borderColor:'#fbbf24', pointBackgroundColor:'#fbbf24', fill:false, borderWidth:2, pointRadius:3, spanGaps:true},
      {label:'潜力（环境+纠偏 · 8维）', data: ds_pot_env,     borderColor:'#f59e0b', pointBackgroundColor:'#f59e0b', fill:false, borderWidth:2, pointRadius:3, spanGaps:true}
    ]
  },
  options:{
    responsive:true, maintainAspectRatio:false,
    plugins:{
      legend:{ display:true, position:'top', labels:{ color:'#dbe3ff', usePointStyle:true } },
      tooltip:{
        callbacks:{
          title: (items)=> items && items[0] ? ECO16[items[0].dataIndex] : '',
          label: (ctx)=>{
            const di = ctx.datasetIndex;
            const idx = ctx.dataIndex;
            const rawScaled = ctx.parsed.r;
            if(Number.isNaN(ctx.raw)) return '';
            let original = 0, name='';
            if(di===0 || di===1){
              original = Math.round((rawScaled) * 2);
              const k = STRUCT_ANCHOR_INV[idx]; name = STRUCT8[k]||'结构';
            }else if(di===2){
              original = Math.round((rawScaled-50) * 2);
              name = '生态';
            }else{
              original = Math.round((rawScaled-100) * 2);
              const k = POT_ANCHOR_INV[idx]; name = POT8[k]||'潜力';
            }
            return `${name}：${original}`;
          }
        }
      }
    },
    scales:{
      r:{
        min:0,max:150,
        ticks:{ callback:(v)=>v, stepSize:25 },
        grid:{ color:(ctx)=> {
          const v = ctx.tick.value;
          if(v===50||v===100) return 'rgba(255,255,255,.35)';
          return 'rgba(255,255,255,.12)';
        }},
        angleLines:{ color:'rgba(255,255,255,.15)' },
        pointLabels:{ color:'#e6ebff', font:{ size:11 } }
      }
    }
  }
});

/* ========= 右侧面板渲染 ========= */
function bandCls(v){ if(v>=70) return "good"; if(v<=50) return "bad"; return "warn"; }
function badge(label, val, targetId){
  return `<span class="badge ${bandCls(val)}" data-scroll="#${targetId}"><i class="dot"></i>${label} ${Math.round(val)}（${val>=70?'高':(val<=50?'低':'中')}）</span>`;
}
function barDual(label, v1, v2, tips, rowId){
  v1 = Math.round(v1||0); v2 = Math.round(v2||0);
  let html = `<div class='q' id='row-${rowId}'>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <b>${label}</b>
      <div>
        <span class="badge ${bandCls(v1)}"><i class="dot"></i>自评 ${v1}（${v1>=70?'高':(v1<=50?'低':'中')}）</span>
        <span class="badge ${bandCls(v2)}"><i class="dot"></i>环境+纠偏 ${v2}（${v2>=70?'高':(v2<=50?'低':'中')}）</span>
      </div>
    </div>
    <div class='bar'><i style='width:${v1}%'></i></div><span class='value'>自评：${v1}</span>
    <div class='bar alt1'><i style='width:${v2}%'></i></div><span class='value'>环境+纠偏：${v2}</span>`;
  if(tips && tips.length){
    const first = tips.slice(0,2), rest = tips.slice(2);
    const items1 = first.map(t=> `<li>${t}</li>`).join('');
    const items2 = rest.map(t=> `<li class="extra">${t}</li>`).join('');
    const cls = rest.length ? 'tips collapsed' : 'tips';
    const btn = rest.length ? `<div class="tip-toggle" data-target="tips-${rowId}">展开更多 ▾</div>` : '';
    html += `<ul id="tips-${rowId}" class="${cls}">${items1}${items2}</ul>${btn}`;
  }
  html += `</div>`;
  return html;
}
function barSingle(label, v2, tips, rowId, domainTagsHtml=''){
  v2 = Math.round(v2||0);
  let html = `<div class='q' id='row-${rowId}'>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <b>${label}</b>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
        ${domainTagsHtml}
        <div class="badge ${bandCls(v2)}"><i class="dot"></i>环境+纠偏 ${v2}（${v2>=70?'高':(v2<=50?'低':'中')}）</div>
      </div>
    </div>
    <div class='bar alt1'><i style='width:${v2}%'></i></div><span class='value'>环境+纠偏：${v2}</span>`;
  if(tips && tips.length){
    const first = tips.slice(0,2), rest = tips.slice(2);
    const items1 = first.map(t=> `<li>${t}</li>`).join('');
    const items2 = rest.map(t=> `<li class="extra">${t}</li>`).join('');
    const cls = rest.length ? 'tips collapsed' : 'tips';
    const btn = rest.length ? `<div class="tip-toggle" data-target="tips-${rowId}">展开更多 ▾</div>` : '';
    html += `<ul id="tips-${rowId}" class="${cls}">${items1}${items2}</ul>${btn}`;
  }
  html += `</div>`;
  return html;
}

/* 结构规则表述（保持原有合并策略） */
function statementsForAxis(i, S8){
  const axis = STRUCT8[i]; const v = S8[i]||0;
  const bk = v>=70?'high':(v<=50?'low':'mid');
  const lib = BAND_TEXT[axis] || {high:[],mid:[],low:[]};
  const general = lib[bk]||[];
  const combo = comboRulesByAxis(s_env, e_env)[i] || [];
  const seen = new Set(); const merged = [];
  [...general, ...combo].forEach(t=>{ if(t && !seen.has(t)){ seen.add(t); merged.push(t);} });
  return merged;
}

/* 渲染：结构8（自评+环境双条） + 徽章可点击定位 */
document.getElementById('structList').innerHTML = STRUCT8_FULL.map((full,i)=> {
  const tips = statementsForAxis(i, s_env);
  return barDual(full, s_self[i], s_env[i], tips, `struct-${i}`);
}).join('');
document.getElementById('structBadges').innerHTML = s_env.map((v,i)=> badge(STRUCT8[i], v, `row-struct-${i}`)).join('');

/* 渲染：生态16（由徽章推导，仅环境单条） + 领域小徽章 + 新增生态徽章文案 */
const eco_from_badges_now = ecology16FromBadges(s_env, e_env);
document.getElementById('ecoList').innerHTML = ECO16.map((name,i)=>{
  const meta = ECO_META[name]||null;
  const tagHtml = meta ? meta.domains.map(d=>`<span class="badge tag"><i class="dot"></i>${d}</span>`).join('') : '';
  const v = eco_from_badges_now[i]||0;
  const band = v>=70?'high':(v<=50?'low':'mid');
  const tips = meta && meta[band] ? meta[band] : [];
  return barSingle(`${i+1}. ${name}${meta?`（${meta.alias}）`:''}`, v, tips, `eco-${i}`, tagHtml);
}).join('');
document.getElementById('ecoBadges').innerHTML = eco_from_badges_now.map((v,i)=> badge(ECO16[i], v, `row-eco-${i}`)).join('');

/* 渲染：潜力8（自评+环境双条） + 徽章可点击定位（保持原样） */
document.getElementById('potList').innerHTML = POT8.map((n,i)=> barDual(`${i+1}. ${n}`, pot_self[i], pot_env[i], null, `pot-${i}`)).join('');
document.getElementById('potBadges').innerHTML = pot_env.map((v,i)=> badge(POT8[i], v, `row-pot-${i}`)).join('');

/* 熵增提示块（保持原逻辑） */
(function renderEntropy(){
  const H = entropyFromE16(e_env);
  const box = document.getElementById('entropyBox');
  const badge = document.getElementById('entropyBadge');
  const ul = document.getElementById('entropyTips');
  if(!box) return;
  let level = '中', cls='warn', tips=[];
  if(H>=70){ level='高'; cls='bad';
    tips = [
      "硬扛但恢复慢 / 硬扛并能转圜 / 硬扛且具韧性（岩石组合）",
      "顶得住但返工变多（水流组合）",
      "快变但返工风险（筋骨组合）",
      "动员强但协调成本飙升（桥梁组合）",
      "冷静变“压抑”感（盾牌组合）"
    ];
  }else if(H<=50){ level='低'; cls='good';
    tips = [
      "持久稳推 / 持久且敏捷（岩石组合）",
      "遇变不崩（水流组合）",
      "稳定高效 / 改动可承受（筋骨组合）",
      "号召+凝聚（桥梁组合）",
      "高冷静（盾牌组合）"
    ];
  }else{
    tips = ["环境复杂度中等，表现依赖其他维度"];
  }
  badge.className = `badge tag ${cls}`;
  badge.innerHTML = `<i class="dot"></i>当前：${H}（${level}）`;
  ul.innerHTML = tips.map(t=>`<li>${t}</li>`).join('');
  box.style.display = 'block';
})();

/* Tab 切换 + 折叠交互（保持原样） */
function activate(id){
  ['tab-struct','tab-eco','tab-pot'].forEach(t=>document.getElementById(t).classList.remove('active'));
  ['panel-struct','panel-eco','panel-pot'].forEach(p=>document.getElementById(p).style.display='none');
  document.getElementById('tab-'+id).classList.add('active');
  document.getElementById('panel-'+id).style.display='block';
}
document.getElementById('tab-struct').onclick=()=>activate('struct');
document.getElementById('tab-eco').onclick=()=>activate('eco');
document.getElementById('tab-pot').onclick=()=>activate('pot');

document.addEventListener('click', function(e){
  const t = e.target.closest('.tip-toggle'); 
  if(t){ const id = t.getAttribute('data-target'); const ul = document.getElementById(id);
    if(ul){ const collapsed = ul.classList.contains('collapsed');
      if(collapsed){ ul.classList.remove('collapsed'); t.textContent = '收起 ▴'; }
      else{ ul.classList.add('collapsed'); t.textContent = '展开更多 ▾'; }
    }
  }
  const b = e.target.closest('.badge');
  if(b && b.dataset.scroll){
    const el = document.querySelector(b.dataset.scroll);
    if(el){
      el.classList.add('highlight');
      el.scrollIntoView({behavior:'smooth', block:'center'});
      setTimeout(()=>el.classList.remove('highlight'), 3000);
    }
  }
}, false);

/* ======== 跨页自动热更新（原样） ======== */
window.addEventListener('storage', (e) => {
  if (['step2_struct_raw','step2_eco16_raw','step3_struct','step3_eco16'].includes(e.key)) {
    location.reload();
  }
});
</script>
</body>
</html>
