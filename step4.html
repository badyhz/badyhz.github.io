<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Step4 · 基础14维标签 + 权重预设与综合指数</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b1020;--card:#121833;--ink:#e7ecff;--muted:#98a1c0;--line:#1c2447;--hl:#2a3b7a;--ok:#34d399;--warn:#f59f0b;--bad:#ff5c9a;--pri:#6c8cff}
*{box-sizing:border-box}html,body{margin:0;background:linear-gradient(180deg,#0b1020,#0e1430);color:var(--ink);font-family:'Noto Sans SC',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1200px;margin:20px auto 80px;padding:14px}
.h1{font-size:24px;font-weight:700;margin:4px 0 10px}
.card{background:linear-gradient(180deg,#121833,#0f1733);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:1024px){.row{grid-template-columns:1fr}}
h3{margin:0 0 8px;font-size:16px}
h4{margin:8px 0 6px;font-size:13px;color:#cdd6ff}
.kv{display:grid;grid-template-columns:110px 1fr;gap:6px 10px;margin:6px 0;font-size:12px;color:#dbe3ff}
.small{font-size:12px;color:#a8b7ff}
.chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #2a3b7a;border-radius:999px;background:#0c1433;color:#dbe3ff;font-size:12px;cursor:pointer;user-select:none}
.chip.active{border-color:#7a95ff;background:rgba(108,140,255,.12)}
.segment{display:inline-flex;border:1px solid #2a3b7a;border-radius:10px;overflow:hidden}
.segment button{background:#0c1433;color:#cfe0ff;border:0;padding:6px 10px;cursor:pointer;font-size:12px}
.segment button.active{background:#1a244f;color:#e7efff}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a3b7a;border-radius:999px;padding:2px 8px;font-size:11px;color:#cfe0ff}
.badge .dot{width:6px;height:6px;border-radius:50%;background:#7a95ff}
.badge.ok{border-color:rgba(52,211,153,.6);color:#d8fff1}.badge.ok .dot{background:var(--ok)}
.badge.warn{border-color:rgba(245,158,11,.6);color:#ffe4b8}.badge.warn .dot{background:var(--warn)}
.badge.bad{border-color:rgba(255,92,154,.6);color:#ffd0e1}.badge.bad .dot{background:var(--bad)}
.hr{height:1px;background:#243163;margin:10px 0;border:0}
.btn{padding:8px 12px;border-radius:8px;background:var(--pri);border:1px solid #7a95ff;color:#fff;text-decoration:none;cursor:pointer}
.btn.ghost{background:#0c1433;color:#cfe0ff;border-color:#3a4a8f}
.flex{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.right{display:flex;gap:8px;align-items:center}
.score{font-size:12px;color:#cfe0ff}
.value{font-weight:700;color:#e7efff}
.tip{font-size:12px;color:#a8b7ff;margin-top:4px}
.table{width:100%;border-collapse:separate;border-spacing:0 6px;margin-top:8px}
.table th,.table td{font-size:12px;color:#dbe3ff;text-align:left;padding:6px 8px;background:#0b1430;border:1px solid #283766}
.table th{background:#0f1b3d;color:#e7efff}
.note{font-size:12px;color:#9fb1ff}
.select{background:#0c1433;border:1px solid #2a3b7a;border-radius:8px;color:#e7efff;padding:6px 10px;font-size:12px}
.wtbl{width:100%;border-collapse:separate;border-spacing:0 6px}
.wtbl th,.wtbl td{font-size:12px;color:#dbe3ff;text-align:left;padding:6px 8px;background:#0b1430;border:1px solid #283766}
.wtbl th{background:#0f1b3d;color:#e7efff}
.big{font-size:28px;font-weight:800;letter-spacing:0.5px}
</style>
</head>
<body>
<div class="wrap">
  <div class="flex" style="justify-content:space-between">
    <div class="h1">Step4 · 基础14维标签（点击即选，实时计算）</div>
    <div class="flex">
      <a class="btn ghost" href="dashboard.html">← 返回 Dashboard</a>
      <button class="btn" id="btnSave">保存（本地）</button>
      <button class="btn ghost" id="btnClear">清空选择</button>
    </div>
  </div>
  <div class="note">
    说明：本页不改变雷达与排版，仅用于补充 <b>思维 / 逻辑能力 / 熵增 / 洞察</b> + <b>10个更底层维度</b> 的标签判定与提示；并计算 <b>综合指数</b>（权重可一键切换预设）。
    分数口径：频率=从不/偶尔/常态 → 30/60/85；方向=偏少/适中/偏多 → -10/0/-5；标签加分≤+15；熵增使用“噪声−护栏”的净效。
  </div>

  <!-- 顶部：权重与综合指数 -->
  <div class="card">
    <div class="flex" style="justify-content:space-between;align-items:flex-start">
      <div>
        <h3>综合指数 & 权重预设</h3>
        <div class="small">综合指数 = 加权平均 − 兜底惩罚；兜底维度：逻辑能力/洞察能力/注意力控制/工作带宽/熵增。</div>
      </div>
      <div class="flex">
        <label class="small">权重预设：</label>
        <select id="presetSel" class="select">
          <option value="general">通用（默认）</option>
          <option value="startup">创业 0→1</option>
          <option value="scale">扩张 1→10</option>
          <option value="research">研发/产品深思</option>
          <option value="wellbeing">生活恢复/韧性</option>
        </select>
        <button class="btn ghost" id="btnWeightsReset">重置为预设</button>
      </div>
    </div>

    <div class="hr"></div>
    <div class="flex" style="justify-content:space-between;align-items:center;flex-wrap:wrap">
      <div class="flex" style="gap:16px;align-items:center">
        <div class="big" id="compVal">—</div>
        <span class="badge" id="compBand"><i class="dot"></i>—</span>
        <div class="small" id="penaltyText">兜底惩罚：—</div>
      </div>
      <div class="small">当前预设将保存在 <code>step4_weights</code>，综合指数存为 <code>step4_composite</code>。</div>
    </div>

    <table class="wtbl" id="wTable" style="margin-top:8px">
      <thead><tr><th style="width:34px">#</th><th>维度</th><th style="width:120px">权重（%）</th><th style="width:90px">分数</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><td colspan="2" style="text-align:right"><b>合计</b></td><td id="wSum">—</td><td id="weightedAvg">—</td></tr></tfoot>
    </table>
  </div>

  <!-- 概览：生态提示 -->
  <div class="card" id="summary">
    <h3>生态联动提示（仅提示，不改分）</h3>
    <table class="table" id="ecoHintsTable">
      <thead><tr><th style="width:160px">生态维度</th><th>提示（Δ 为建议方向强度）</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 维度编辑区 -->
  <div class="row" id="panel"></div>
</div>

<script>
/** ========= 基础数据 ========= */
const ECO16 = [
  "信任速度","协作质量","关系韧性","影响半径","目标推进力","节奏管理",
  "应变效率","落地闭环度","洞察敏锐度","表达条理度","信息整合度","改进驱动力",
  "能量外放","冲突风格","环境贴合度","幸福感基础"
];
const ECO_INDEX = {}; ECO16.forEach((n,i)=>ECO_INDEX[n]=i);

// 14 维顺序（用于 step4_scores）
const DIMENSIONS = [
  // 10 个更底层维度（时间视野→学习与迁移）
  { key:"focus", name:"注意力控制（Selective Focus）",
    desc:"在噪声中稳定选择与保持注意、必要时有代价地切换。",
    tags:["单点专注","抗干扰","深工≥60min","切换延迟可感","任务重返快","通知治理","环境布置","专注恢复仪式"],
    ecoLinks:{"落地闭环度":0.60,"节奏管理":0.40,"信息整合度":0.30}
  },
  { key:"wm", name:"工作带宽（Working Memory & Load）",
    desc:"承载并操作信息的“心智缓存”与负荷管理。",
    tags:["块化表达","外部记忆（白板/笔记）","3–5项上限","视觉板","复述校验","压缩表达","核对清单","定期清仓"],
    ecoLinks:{"表达条理度":0.60,"信息整合度":0.60,"目标推进力":0.30}
  },
  { key:"learn", name:"学习与迁移（Learning）",
    desc:"从经验中抽取结构，跨域迁移到新问题并快速试错。",
    tags:["快速建模","刻意练习","错题本","文档沉淀","跨域类比","微项目实践","导师/同侪回路","反馈半衰期短"],
    ecoLinks:{"洞察敏锐度":0.40,"改进驱动力":0.50,"落地闭环度":0.20}
  },
  { key:"affect", name:"情绪调节与生理自控（Affect & Interoception）",
    desc:"觉察与调节生理/情绪唤醒水平，使之服务于目标。",
    tags:["心率觉察","命名情绪","呼吸复位","睡眠守则","能量扫描","触发器识别","停—看—走","恢复日"],
    ecoLinks:{"幸福感基础":0.60,"关系韧性":0.40,"节奏管理":0.30}
  },
  { key:"boundary", name:"边界与主权（Boundaries & Agency）",
    desc:"明确边界与可用性，主动主张资源与顺序。",
    tags:["拒绝权限","可用性声明","接口清单","期望管理","资源请求","优先级公开","停工门槛","反馈回路"],
    ecoLinks:{"协作质量":0.50,"幸福感基础":0.30,"环境贴合度":0.40}
  },
  { key:"uncertainty", name:"不确定性承载（Uncertainty Tolerance）",
    desc:"在信息不全下稳健行动，并设计可逆试错。",
    tags:["范围预估","假设分层","信息价值评估","最小可逆下注","探索-利用比","容错区","早停/停损","后验更新"],
    ecoLinks:{"目标推进力":0.30,"改进驱动力":0.50,"应变效率":0.50}
  },
  { key:"calibration", name:"现实校准（Calibration）",
    desc:"自信与准确度匹配，基于证据持续矫正。",
    tags:["自信-准确记录","基线对比","反例搜索","红队审阅","误差账本","样本代表性检查","后验改口径","置信区间"],
    ecoLinks:{"信息整合度":0.50,"表达条理度":0.40,"信任速度":0.30}
  },
  { key:"habit", name:"习惯与自动化（Habit Loop & Autopilot）",
    desc:"把关键行为固化为低摩擦的可重复流程。",
    tags:["触发-行为-奖励","堆叠习惯","最小启动","闯关计数","复盘日","摩擦设计","脚本化/自动化","提醒回路"],
    ecoLinks:{"落地闭环度":0.60,"节奏管理":0.50,"关系韧性":0.20}
  },
  { key:"social", name:"关系心智（Social Cognition & Empathy）",
    desc:"理解他人心智与情境规则，降低误读与对立。（含微维度：带队力）",
    tags:["视角采择","归因习惯","镜像式聆听","受众适配","共识生成","冲突降级（SFR）","赞赏频次","修复仪式",
          "— 带队力：节奏带动","— 带队力：分工清晰","— 带队力：挡枪与背书","— 带队力：情绪调平","— 带队力：成长面谈","— 带队力：战术鼓舞"],
    ecoLinks:{"协作质量":0.60,"关系韧性":0.40,"信任速度":0.40}
  },
  { key:"meaning", name:"自我叙事与意义（Narrative & Meaning）",
    desc:"把经历组织成支持行动的叙事，维持意义感。",
    tags:["价值锚点","角色脚本","成长叙事","失败再定义","目标一致性","感恩练习","身份宽度","长期动机"],
    ecoLinks:{"幸福感基础":0.60,"影响半径":0.30,"改进驱动力":0.30}
  },

  // 必备 4 维
  { key:"thinking", name:"思维（Thinking Modes）",
    desc:"问题建模与切换的方式栈。",
    tags:["线性拆解","非线性跃迁","导演型叙事","系统思维","第一性原理","概率/贝叶斯","反事实推演","类比迁移","因果图谱","抽象⇄具体切换","博弈框架","实验主义","二阶效应","临界点/阈值"],
    ecoLinks:{"信息整合度":0.40,"洞察敏锐度":0.40,"表达条理度":0.30}
  },
  { key:"logic", name:"逻辑能力（Logic Skill）",
    desc:"论证与决策的可验证结构化能力。",
    tags:["结论先行","三点支撑","MECE","必要/充分","定义口径统一","变量与约束","因果链验证","反例搜索","证据强度评级","估算校核（Fermi）","数据/案例互证","边界条件申明","复杂度控制","信息密度控制","推理透明度","假设-检验闭环","图表素养","FAQ预答","风险与不确定性标注"],
    ecoLinks:{"表达条理度":0.50,"信息整合度":0.50,"目标推进力":0.30}
  },
  { key:"entropy", name:"熵增（Noise & Guardrails）",
    desc:"噪声来源与低熵护栏并存（本页以“熵管理”健康度计分）。",
    tags:["需求频繁变更","接口人不清","目标多版本","临时插单","排期漂移","会议过载","跨部门拉扯","返工>30%","文档失配","缺验收标准","Bug漏测","优先级打架","临时改向","数据口径变动","角色冲突","情绪外溢",
          "（低熵护栏）标准化模板","单一负责人","冻结窗","变更评审","WIP限流","看板透明","里程碑准入","复盘模板","异常告警","SLA协议","接口清单","灰度/回滚点"],
    ecoLinks:{"节奏管理":0.50,"落地闭环度":0.50,"协作质量":0.40}
  },
  { key:"insight", name:"洞察能力（Insight）",
    desc:"识别关键变量与领先指标、生成可检验假设。",
    tags:["关键变量识别","领先指标设定","异常点追踪","模式识别","样本代表性判断","田野访谈","影子数据/对照样本","边缘用户观察","竞品侧写","反事实比较","单位经济学敏感度","二阶/连锁效应","因果vs相关辨析","趋势外推","黑天鹅警觉","假设生成速度","问题再定义","从一线回模型"],
    ecoLinks:{"洞察敏锐度":0.60,"信息整合度":0.30,"目标推进力":0.20}
  }
];

// 分值口径
const BASE_SCORE = { "从不":30, "偶尔":60, "常态":85 };
const DIR_ADJ    = { "偏少":-10, "适中":0,  "偏多":-5 };
const MAX_TAG_BONUS = 15; // 标签最多加 15 分

/** ========= 权重预设 ========= */
// 便于引用的 key 索引
const K = DIMENSIONS.reduce((m,d)=>{ m[d.key]=d; return m; }, {});
const PRESETS = {
  general: { // 通用
    name:"通用",
    w:{
      logic:0.12, insight:0.12, entropy:0.10, wm:0.10, focus:0.10,
      uncertainty:0.08, thinking:0.08, learn:0.07, habit:0.05,
      boundary:0.05, social:0.05, affect:0.04, calibration:0.02, meaning:0.02
    }
  },
  startup: { // 创业 0→1
    name:"创业 0→1",
    w:{
      insight:0.14, logic:0.12, uncertainty:0.12, learn:0.10, entropy:0.10,
      focus:0.08, wm:0.08, thinking:0.08, boundary:0.05, social:0.05,
      habit:0.04, affect:0.02, calibration:0.01, meaning:0.01
    }
  },
  scale: { // 扩张 1→10
    name:"扩张 1→10",
    w:{
      entropy:0.12, social:0.10, boundary:0.08, habit:0.08, wm:0.10,
      focus:0.08, logic:0.10, insight:0.10, thinking:0.06, learn:0.06,
      uncertainty:0.06, affect:0.04, calibration:0.01, meaning:0.01
    }
  },
  research: { // 研发/产品深思
    name:"研发/产品深思",
    w:{
      logic:0.14, insight:0.14, wm:0.12, focus:0.10, thinking:0.10,
      learn:0.08, entropy:0.08, uncertainty:0.06, calibration:0.06,
      habit:0.04, boundary:0.03, social:0.03, affect:0.01, meaning:0.01
    }
  },
  wellbeing: { // 生活恢复/韧性
    name:"生活恢复/韧性",
    w:{
      affect:0.14, meaning:0.10, habit:0.10, boundary:0.10, focus:0.10,
      entropy:0.08, social:0.08, insight:0.06, logic:0.05, wm:0.05,
      learn:0.05, thinking:0.04, uncertainty:0.03, calibration:0.02
    }
  }
};

// 读取/保存
function loadMeta(){ try{ return JSON.parse(localStorage.getItem('step4_meta')||'{}'); }catch(e){ return {}; } }
function saveMeta(obj){ localStorage.setItem('step4_meta', JSON.stringify(obj)); }
function saveScores(arr){ localStorage.setItem('step4_scores', JSON.stringify(arr)); }
function saveEcoHint(obj){ localStorage.setItem('step4_eco_hint', JSON.stringify(obj)); }
function loadWeights(){ try{ return JSON.parse(localStorage.getItem('step4_weights')||'null'); }catch(e){ return null; } }
function saveWeights(obj){ localStorage.setItem('step4_weights', JSON.stringify(obj)); }
function saveComposite(num){ localStorage.setItem('step4_composite', String(num)); }

// 计算维度分
function computeDimScore(metaItem, totalTags){
  const f = BASE_SCORE[metaItem.freq||'偶尔']||60;
  const d = DIR_ADJ[metaItem.dir||'适中']||0;
  const sel = (metaItem.tags||[]).length;
  const bonus = totalTags>0 ? Math.min(MAX_TAG_BONUS, Math.round(MAX_TAG_BONUS * sel/totalTags)) : 0;
  let score = Math.max(0, Math.min(100, f + d + bonus));
  // 熵增特殊：把“噪声标签”当负项，“护栏标签”当正项
  if(metaItem.key==='entropy'){
    const noise = (metaItem.tags||[]).filter(t=>!t.startsWith('（低熵护栏）')).length;
    const guards= (metaItem.tags||[]).filter(t=>t.startsWith('（低熵护栏）')).length;
    const raw = f + d + (guards - noise) * 2; // 每条 ±2 分
    score = Math.max(0, Math.min(100, raw));
  }
  return score;
}

// 生成生态提示（不改分，只给 Δ 提示）
function buildEcoHints(scores){
  const eco = new Array(16).fill(0);
  DIMENSIONS.forEach((dim, idx)=>{
    const s = scores[idx]??60;
    const k = (s - 60) / 40; // -1..+1（60 为中线）
    Object.entries(dim.ecoLinks||{}).forEach(([name,w])=>{
      const i = ECO_INDEX[name]; if(i==null) return;
      eco[i] += k * w * 8; // 每维度最高±8 * 权重
    });
  });
  const entIdx = DIMENSIONS.findIndex(d=>d.key==='entropy');
  if(entIdx>=0){
    const s = scores[entIdx]??60;
    const neg = Math.max(0, (60 - s)/40); // 0..1
    eco[ECO_INDEX["节奏管理"]]   -= neg * 4;
    eco[ECO_INDEX["落地闭环度"]] -= neg * 4;
    eco[ECO_INDEX["协作质量"]]   -= neg * 3;
  }
  const out = {};
  eco.forEach((v,i)=>{ if(Math.abs(v)>=0.5){ out[ECO16[i]] = Math.round(v*10)/10; } });
  return out;
}

// 计算综合指数 + 兜底惩罚
function calcComposite(scores, weights){
  // 归一化
  let sumW = 0; Object.values(weights).forEach(v=> sumW += (v||0));
  const W = {}; Object.entries(weights).forEach(([k,v])=> W[k] = (sumW>0)? v/sumW : 0);
  // 加权平均
  let avg = 0;
  DIMENSIONS.forEach((d,idx)=>{ const s = scores[idx]??60; const w = W[d.key]||0; avg += s * w; });
  // 兜底惩罚：{logic, insight, focus, wm, entropy} 的最小值
  const idxMap = {};
  DIMENSIONS.forEach((d,i)=> idxMap[d.key]=i);
  const baseKeys = ['logic','insight','focus','wm','entropy'];
  const minBase = Math.min(...baseKeys.map(k=> scores[idxMap[k]]??60));
  const penalty = (minBase<60) ? Math.min(10, (60 - minBase)*0.25) : 0;
  const final = Math.round(avg - penalty);
  return {avg:Math.round(avg), penalty:Math.round(penalty*10)/10, final, minBase};
}

/** ========= 渲染 ========= */
function renderPanel(){
  const meta = loadMeta();
  const host = document.getElementById('panel');
  host.innerHTML = DIMENSIONS.map((dim, idx)=>{
    const m = meta[dim.key] || {freq:"偶尔", dir:"适中", tags:[]};
    const chips = dim.tags.map(tag=>{
      const on = (m.tags||[]).includes(tag) ? 'active' : '';
      return `<span class="chip ${on}" data-key="${dim.key}" data-tag="${tag}" title="点击选择/取消">${tag}</span>`;
    }).join('');
    const fBtns = ["从不","偶尔","常态"].map(x=> `<button class="${m.freq===x?'active':''}" data-type="freq" data-key="${dim.key}" data-val="${x}">${x}</button>`).join('');
    const dBtns = ["偏少","适中","偏多"].map(x=> `<button class="${m.dir===x?'active':''}" data-type="dir" data-key="${dim.key}" data-val="${x}">${x}</button>`).join('');

    const score = computeDimScore({...m,key:dim.key}, dim.tags.length);
    const band = score>=75?'ok':(score<60?'bad':'warn');
    const bandText = score>=75?'强':(score<60?'风险':'可用');

    return `<div class="card" id="card-${dim.key}">
      <div class="flex" style="justify-content:space-between">
        <h3>${idx+1}. ${dim.name}</h3>
        <div class="right">
          <span class="badge ${band}"><i class="dot"></i>分数 <span class="value">${score}</span>（${bandText}）</span>
        </div>
      </div>
      <div class="small">${dim.desc||''}</div>
      <div class="kv">
        <div>频率</div><div class="segment" data-scope="${dim.key}">${fBtns}</div>
        <div>方向</div><div class="segment" data-scope="${dim.key}">${dBtns}</div>
      </div>
      <h4>标签（点击选择/取消）</h4>
      <div class="chips" data-scope="${dim.key}">${chips}</div>
      <div class="tip">生态联动：${
        Object.entries(dim.ecoLinks||{}).map(([k,v])=>`${k}↑（权重${v}）`).join('，') || '—'
      }</div>
    </div>`;
  }).join('');
}

function renderEcoSummary(scores){
  const hints = buildEcoHints(scores);
  const tbody = document.querySelector('#ecoHintsTable tbody');
  const rows = Object.keys(hints).sort().map(name=>{
    const v = hints[name];
    const cls = v>=0? 'ok':'bad';
    return `<tr><td>${name}</td><td><span class="badge ${cls}"><i class="dot"></i>Δ ${v>0?'+':''}${v}</span> 仅为方向性提示（不改变分数）</td></tr>`;
  });
  tbody.innerHTML = rows.length? rows.join('') : `<tr><td colspan="2" class="small">暂无（选择一些标签或调整频率/方向后会生成提示）</td></tr>`;
  saveEcoHint(hints);
}

function renderWeightsAndComposite(){
  // 分数
  const meta = loadMeta();
  const scores = DIMENSIONS.map((d)=> computeDimScore({...meta[d.key], key:d.key}, d.tags.length));
  saveScores(scores);

  // 权重
  let wconf = loadWeights();
  if(!wconf){
    wconf = { preset:'general', weights: {...PRESETS.general.w} };
    saveWeights(wconf);
  }
  // 计算综合
  const res = calcComposite(scores, wconf.weights);
  saveComposite(res.final);

  // 顶部显示
  const $comp = document.getElementById('compVal');
  const $band = document.getElementById('compBand');
  const $pen  = document.getElementById('penaltyText');
  $comp.textContent = isNaN(res.final)? '—' : res.final;
  let bandCls='warn', bandTxt='可用';
  if(res.final>=75){ bandCls='ok'; bandTxt='强'; }
  if(res.final<60){ bandCls='bad'; bandTxt='风险'; }
  $band.className = `badge ${bandCls}`;
  $band.innerHTML = `<i class="dot"></i>${bandTxt}`;
  $pen.textContent = `兜底惩罚：${res.penalty}（地基最小值 ${res.minBase}）`;

  // 表格：每维权重与分数
  const tbody = document.querySelector('#wTable tbody');
  let sumW = 0; DIMENSIONS.forEach(d=> sumW += (wconf.weights[d.key]||0));
  const rows = DIMENSIONS.map((d,idx)=>{
    const w = wconf.weights[d.key]||0;
    const wPct = (sumW>0)? Math.round(w/sumW*1000)/10 : 0;
    return `<tr><td>${idx+1}</td><td>${d.name.split('（')[0]}</td><td>${wPct}%</td><td>${scores[idx]}</td></tr>`;
  });
  tbody.innerHTML = rows.join('');
  document.getElementById('wSum').textContent = '100%';
  document.getElementById('weightedAvg').textContent = res.avg;

  // 选择器同步
  const sel = document.getElementById('presetSel');
  sel.value = wconf.preset || 'general';

  // 同步生态提示
  renderEcoSummary(scores);
}

/** ========= 事件 ========= */
function bindEvents(){
  const panel = document.getElementById('panel');
  panel.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip');
    if(chip){
      const key = chip.getAttribute('data-key'), tag = chip.getAttribute('data-tag');
      const meta = loadMeta(); const m = meta[key] || {freq:'偶尔',dir:'适中',tags:[]};
      const i = m.tags.indexOf(tag);
      if(i>=0) m.tags.splice(i,1); else m.tags.push(tag);
      meta[key] = m; saveMeta(meta);
      renderPanel(); renderWeightsAndComposite();
      return;
    }
    const btn = e.target.closest('button[data-type]');
    if(btn){
      const key = btn.getAttribute('data-key'); const type = btn.getAttribute('data-type'); const val = btn.getAttribute('data-val');
      const meta = loadMeta(); const m = meta[key] || {freq:'偶尔',dir:'适中',tags:[]};
      m[type] = val; meta[key] = m; saveMeta(meta);
      renderPanel(); renderWeightsAndComposite();
      return;
    }
  });

  document.getElementById('btnSave').addEventListener('click', ()=>{
    renderWeightsAndComposite();
    alert('Step4 已保存到本地：step4_meta / step4_scores / step4_eco_hint / step4_weights / step4_composite');
  });

  document.getElementById('btnClear').addEventListener('click', ()=>{
    if(!confirm('确定清空 Step4 的全部选择和指数？')) return;
    localStorage.removeItem('step4_meta');
    localStorage.removeItem('step4_scores');
    localStorage.removeItem('step4_eco_hint');
    localStorage.removeItem('step4_composite');
    renderPanel(); renderWeightsAndComposite();
  });

  document.getElementById('presetSel').addEventListener('change', (e)=>{
    const val = e.target.value || 'general';
    const preset = PRESETS[val] || PRESETS.general;
    const conf = { preset: val, weights: {...preset.w} };
    saveWeights(conf);
    renderWeightsAndComposite();
  });

  document.getElementById('btnWeightsReset').addEventListener('click', ()=>{
    const sel = document.getElementById('presetSel');
    const val = sel.value || 'general';
    const preset = PRESETS[val] || PRESETS.general;
    const conf = { preset: val, weights: {...preset.w} };
    saveWeights(conf);
    renderWeightsAndComposite();
  });
}

/** ========= 初始化 ========= */
(function init(){
  // 如果本地没有权重，写入通用
  if(!loadWeights()){
    saveWeights({ preset:'general', weights:{...PRESETS.general.w} });
  }
  renderPanel();
  renderWeightsAndComposite();
  bindEvents();
})();
</script>
</body>
</html>
